<pre>
-------------------------------------------------------------------------------
help for <b>sdecode</b>                                                 (Roger Newson)
-------------------------------------------------------------------------------
<p>
<p>
<b><u>Decode string variable into numeric using formats for unlabelled values</u></b>
<p>
        <b>sdecode</b> <i>varname</i> [<i>if</i>] [<i>in</i>] , [ <b><u>g</u></b><b>enerate(</b><i>newvar</i><b>)</b> | <b>replace</b> ] [
                     <b><u>maxl</u></b><b>ength(</b><i>#</i><b>)</b> <b><u>fo</u></b><b>rmat(</b><i>format_spec</i><b>)</b> <b><u>labo</u></b><b>nly</b> <b><u>m</u></b><b>issing</b> <b><u>ftr</u></b><b>im</b>
                     <b><u>xmls</u></b><b>ub</b> <b><u>es</u></b><b>ub(</b><i>esubstitution_rule</i> [, <b><u>elz</u></b><b>ero</b>]<b>)</b>
                     <b><u>pr</u></b><b>efix(</b><i>string</i><b>)</b> <b><u>su</u></b><b>ffix(</b><i>string</i><b>)</b> ]
<p>
        <b>msdecode</b> <i>varlist</i> [<i>if</i>] [<i>in</i>] , <b><u>g</u></b><b>enerate(</b><i>newvar</i><b>)</b> [ <b>replace</b>
                     <b><u>d</u></b><b>elimiters(</b><i>string_list</i><b>)</b> <b><u>maxl</u></b><b>ength(</b><i>#</i><b>)</b> <b><u>fo</u></b><b>rmat(</b><i>format_spec</i><b>)</b>
                     <b><u>labo</u></b><b>nly</b> <b><u>m</u></b><b>issing</b> <b><u>ftr</u></b><b>im</b> <b><u>xmls</u></b><b>ub</b> <b><u>es</u></b><b>ub(</b><i>esubstitution_rule</i> [,
                     <b><u>elz</u></b><b>ero</b>]<b>)</b> <b><u>pr</u></b><b>efix(</b><i>string</i><b>)</b> <b><u>su</u></b><b>ffix(</b><i>string</i><b>)</b> ]
<p>
    where <i>format_spec</i> is either a format or a string variable name, and
    <i>esubstitution_rule</i> is any one of
<p>
        <b>none</b> | <b>x10</b> | <b>rtfsuper</b> | <b>texsuper</b> | <b>htmlsuper</b> | <b>smclsuper</b>
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>sdecode</b> ("super <b>decode</b>") creates an output string variable with values
    from the input numeric variable <i>varname</i>, using labels if present and
    formats otherwise.  The output string variable may either replace the
    input numeric variable or be generated as a new variable named <i>newvar</i>.
    Unlike <b>decode</b>, <b>sdecode</b> creates an output string variable containing the
    values of the input variable as output by the <b>tabulate</b> command and other
    Stata output, instead of decoding all unlabelled input values to missing.
    <b>sdecode</b> is especially useful if a numeric variable has value labels for
    some values but not for others.  <b>msdecode</b> is a multivariate version of
    <b>sdecode</b>, which inputs a list of numeric variables and (optionally) a list
    of delimiters, and creates a single string variable, containing the
    concatenated and decoded values of all the input variables, separated by
    the delimiters if provided.
<p>
<b><u>Options</u></b>
<p>
    For <b>sdecode</b>, either <b>generate()</b> or <b>replace</b> must be specified, but both
        options may not be specified at the same time.  For <b>msdecode</b>,
        <b>generate</b> must be specified, but <b>replace</b> is optional.
<p>
    <b>generate(</b><i>newvar</i><b>)</b> specifies the name of a new output string variable to be
        created.
<p>
    <b>replace</b>, with <b>sdecode</b>, specifies that the output string variable will
        replace the input numeric variable, and have the same name, the same
        position in the data set, and the same variable label and
        characteristics if present.  With <b>msdecode</b>, <b>replace</b> specifies that
        any existing variable with the same name as the <b>generate()</b> variable
        will be replaced.
<p>
    <b>delimiters(</b><i>string_list</i><b>)</b> (<b>msdecode</b> only) specifies a list of delimiters,
        to be inserted between the decoded values of successive variables in
        the input <i>varlist</i> when the output variable is generated.  If the
        number of elements provided is less than the number of input
        variables minus 1, then the last element is repeated as often as
        necessary.  If the <b>delimiters()</b> option is not provided, then the
        empty string <b>""</b> is assumed, and repeated as often as necessary.
<p>
    <b>maxlength(</b><i>#</i><b>)</b> is optional.  It specifies how many characters of the value
        label to retain.  <i>#</i> must be an integer between 1 and the maximum
        string variable length, which is stored in the system parameter
        <b>c(maxstrvarlen)</b>.  If unset, then <b>maxlength()</b> is set to the maximum
        string variable length.
<p>
    <b>format(</b><i>format_spec</i><b>)</b> is optional.  It specifies the format (or formats)
        used for decoding unlabelled values of the input numeric variable.
        It may be either a format (to be used for all unlabelled values), or
        the name of a string format variable (in which case each observation
        with an unlabelled value is decoded using the format stored in the
        string format variable for that observation).  If <b>format()</b> is not
        specified, then <b>sdecode</b> and <b>msdecode</b> use the format associated with
        the input numeric variable.
<p>
    <b>labonly</b> is optional.  It specifies that only labelled values for the
        input numeric variable will be decoded to nonmissing string values in
        the output string variable, and that unlabelled values will be
        decoded to a missing string value, as with <b>decode</b>.  If <b>labonly</b> is not
        specified, then all nonmissing values of the input numeric variable
        will be decoded to nonmissing string values, except for values in
        observations excluded by the <b>if</b> and <b>in</b> qualifiers, which are decoded
        to a missing string value.
<p>
    <b>missing</b> is optional.  It specifies that missing values in the input
        numeric variable will be decoded (using formats) to non-missing
        formatted string values (such as <b>"."</b>).  If <b>missing</b> is absent, then
        missing values in the input numeric variable are decoded to missing
        string values.
<p>
    <b>ftrim</b> is optional.  It specifies that values of the output string
        variable produced using a format will be trimmed to remove spaces on
        the left and on the right.
<p>
    <b>xmlsub</b> is optional.  It specifies that, in the decoded string output
        variable, the substrings <b>"&amp;"</b>, <b>"&lt;"</b> and <b>"&gt;"</b> will be replaced throughout
        with the XML entity references <b>"&amp;amp;"</b>, <b>"&amp;lt;"</b> and <b>"&amp;gt;"</b>,
        respectively.  This is useful if the decoded string output variable
        is intended for output to a table in a document in XHTML, or in other
        XML-based languages.  This substitution, if specified, is performed
        before any substitution specified by the <b>esub()</b> option.
<p>
    <b>esub(</b><i>esubstitution_rule</i> [, <b>elzero</b>]<b>)</b> is optional.  It specifies a rule for
        substitution of exponents in decoded values produced using the format
        specified by the <b>format()</b> option, to make them more suitable for
        output to TeX, HTML, RTF, or other word processor documents.  The
        presence of exponents is normally indicated, in Stata formatted
        values, by the presence of substrings <b>"e-"</b> or <b>"e+"</b>.  These substrings
        may indicate that the substring to the left is a mantissa, and that
        the substring to the right is the absolute value of an exponent,
        conventionally presented in documents as a superscript.  The possible
        values of the <i>esubstitution_rule</i> are <b>none</b>, <b>x10</b>, <b>rtfsuper</b>, <b>texsuper</b>,
        <b>htmlsuper</b> and <b>smclsuper</b>.  These rules are documented below under
        <b>Substitution rules for the esub() option</b>.  The suboption <b>elzero</b>, if
        present, indicates that, if the exponent contains leading zeros, then
        those leading zeros will be retained in the final formatted value.
        If the <b>esub()</b> option is specified without the <b>elzero</b> suboption, then
        such leading zeros are removed.
<p>
    <b>prefix(</b><i>string</i><b>)</b> is optional.  It specifies a prefix string, to be added to
        the left of the generated string variable.
<p>
    <b>suffix(</b><i>string</i><b>)</b> is optional.  It specifies a suffix string, to be added to
        the right of the generated string variable.
<p>
<p>
<a name="esub_rules"></a><b><u>Substitution rules for the </u></b><b><u>esub()</u></b><b><u> option</u></b>
<p>
    If the user specifies an <b>esub()</b> option, then <b>sdecode</b> and <b>msdecode</b> perform
    exponent substitution on those values of the output string variable which
    were produced using the format specified by the <b>format()</b> option.  This is
    done after any trimming specified by the <b>ftrim</b> option and/or any XML
    entity substitution specified by the <b>xmlsub</b> option, and before any
    addition of prefixes and suffixes specified by the <b>prefix()</b> and <b>suffix()</b>
    options.
<p>
    The first step is to locate the first appearance, in the output string
    value, of the substring <b>"e-"</b> or the substring <b>"e+"</b>, whichever appears
    first.  This substring (if it exists) is known as the <i>&lt;esign&gt;</i>.  The
    substring to the left is known as the <i>&lt;mantissa&gt;</i>, and the substring to
    the right is known as the <i>&lt;exponent&gt;</i>.  An output string value therefore
    has the syntax
<p>
    <i>&lt;mantissa&gt;</i> | <i>&lt;mantissa&gt;&lt;esign&gt;&lt;exponent&gt;</i>
<p>
    where &lt;mantissa&gt; is a string without any embedded <b>"e-"</b> or <b>"e+"</b>
    substrings.  If <b>elzero</b> is not specified, then the next step is to attempt
    to remove any leading zeros from the <i>&lt;exponent&gt;</i>, using a method that
    works if the <i>&lt;exponent&gt;</i> is an unsigned integer.
<p>
    If an <i>&lt;esign&gt;</i> is present, then the next step is to replace the <i>&lt;esign&gt;</i>
    with an infix string <i>&lt;eminfix&gt;</i> if the <i>&lt;esign&gt;</i> is <b>"e-"</b>, or with an infix
    string <i>&lt;epinfix&gt;</i> if the <i>&lt;esign&gt;</i> is <b>"e+"</b>, and to append a string <i>&lt;esuffix&gt;</i>
    to the end of the <i>&lt;exponent&gt;</i>.  The <i>esubstitution_rule</i> is defined by the
    values of the <i>&lt;eminfix&gt;</i>, <i>&lt;epinfix&gt;</i> and <i>&lt;esuffix&gt;</i> strings.  The revised
    output string should then have the syntax
<p>
    <i>&lt;mantissa&gt;</i> | <i>&lt;mantissa&gt;&lt;eminfix&gt;&lt;exponent&gt;&lt;esuffix&gt;</i> |
    <i>&lt;mantissa&gt;&lt;epinfix&gt;&lt;exponent&gt;&lt;esuffix&gt;</i>
<p>
    The values for the different <i>esubstitution_rule</i>s are as follows:
<p>
-------------------------------------------------------------------------------
<i>esubstitution_rule</i>  <i>&lt;eminfix&gt;</i>       <i>&lt;epinfix&gt;</i>      <i>&lt;esuffix&gt;</i>  <i>Description</i>
<b>none</b>                <b>"e-"</b>            <b>"e+"</b>           <b>""</b>         No substitition
<b>x10</b>                 <b>"x10-"</b>          <b>"x10"</b>          <b>""</b>         To be superscript
&gt; ed manually
<b>rtfsuper</b>            <b>"x10{\super -"</b>  <b>"x10{\super "</b>  <b>"}"</b>        RTF superscript
<b>texsuper</b>            <b>"\times 10^{-"</b>  <b>"\times 10^{"</b>  <b>"}"</b>        TeX superscript
<b>htmlsuper</b>           <b>"x10&lt;sup&gt;-"</b>     <b>"x10&lt;sup&gt;"</b>     <b>"&lt;/sup&gt;"</b>   HTML superscript
<b>smclsuper</b>           <b>"x10{sup:-"</b>     <b>"x10{sup:"</b>     <b>"}"</b>        SMCL superscript
-------------------------------------------------------------------------------
<p>
    Note that, if the user specifies <b>esub(none,elzero)</b>, then the result is
    equivalent to specifying no <b>esub()</b> option.  SMCL superscripts are
    documented in the online help for Stata graphics text.
<p>
<p>
<b><u>Remarks</u></b>
<p>
    <b>sdecode</b> is a separate package from <b>sencode</b> ("super <b>encode</b>"), which is
    also downloadable from SSC.  However, the two packages both have the
    alternative <b>generate()</b> and <b>replace</b> options.  They are complementary to
    the <b>destring</b> command and the <b>tostring</b> command, which are part of official
    Stata.  <b>tostring</b> and <b>destring</b> convert numeric values to and from their
    formatted string values, respectively, but they do not use value labels,
    and they do contain precautionary features to prevent the loss of
    information.  <b>sdecode</b> and <b>sencode</b>, on the other hand, do use value
    labels, and allow the possibility that the mapping from numeric values to
    string values can be many-to-one.
<p>
    For more about the use of <b>sdecode</b> with <b>listtab</b> and other SSC packages to
    create tables, see Newson (2012).
<p>
<p>
<b><u>Examples</u></b>
<p>
        <b>. sdecode price, replace</b>
<p>
        <b>. sdecode foreign, replace labonly</b>
<p>
        <b>. sdecode foreign, gene(origin)</b>
<p>
        <b>. sdecode foreign, gene(origin) maxlen(3)</b>
<p>
        <b>. replace foreign=_n/_N if mod(_n,2)</b>
        <b>. sdecode foreign, gene(origin1)</b>
        <b>. sdecode foreign, gene(origin2) format(%8.4f)</b>
<p>
        <b>. sdecode rep78, gene(srep78) missing</b>
<p>
        <b>. sdecode price, gene(sprice) prefix($)</b>
<p>
        <b>. sdecode weight, gene(sweight) suffix(" lb")</b>
<p>
        <b>. sdecode weight, gene(esweight) format(%8.1e) esub(htmlsuper)</b>
<p>
        <b>. msdecode foreign weight price, gene(fwp) delim(", " "lb for $")</b>
<p>
        <b>. msdecode foreign weight price, gene(fwp) replace delim(" car</b>
            <b>weighing " " lb and costing ") suffix(" dollars")</b>
<p>
<p>
<b><u>Author</u></b>
<p>
    Roger Newson, Imperial College London, UK.  Email:
    r.newson@imperial.ac.uk
<p>
<p>
<a name="references"></a><b><u>References</u></b>
<p>
    Newson, R. B.  2012.  From resultssets to resultstables in Stata.  <i>The</i>
        <i>Stata Journal</i> 12(2): 191-213.  Download from <i>The Stata Journal</i>
        website.
<p>
<p>
<b><u>Also see</u></b>
<p>
<p>
    Manual:  <b>[D] compress</b>, <b>[D] destring</b>, <b>[D] encode</b>, <b>[D] format</b>, <b>[D]</b>
             <b>functions</b>, <b>[D] generate</b>, <b>[D] label</b>
<p>
      Help:  <b>[D] compress</b>, <b>[D] destring</b>, <b>[D] encode</b>, <b>[D] decode</b>, <b>[D] format</b>, 
             <b>[D] functions</b>, <b>[D] generate</b>, <b>[D] label</b>
             <b>sencode</b>, <b>listtab</b> if installed
</pre>