<pre>
<p>
-------------------------------------------------------------------------------
help for <b>mahaselectunique</b>
-------------------------------------------------------------------------------
<p>
<b><u>Given a file written by mahapick with the genfile option, select a set of uniqu</u></b>
<b><u>&gt; e matches for the treated set.</u></b>
<p>
        <b>mahaselectunique,</b> <b>usefile(</b><i>filename1</i><b>)</b> <b>writefile(</b><i>filename2</i><b>)</b>
                 <b>idvar(</b><i>idvar</i><b>)</b> [ <b>prime_id(</b><i>prime_id</i><b>)</b> <b>matchnum(</b><i>matchnum</i><b>)</b>
                 <b>scorevar(</b><i>scorevar</i><b>)</b> <b>nmatch(</b><i>#</i><b>)</b> <b>seed(</b><i>seedvalue</i><b>)</b> <b>replace</b> <b>clear</b>
                 <b>nostrict</b> ]
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>mahaselectunique</b> takes a file in the form generated by the <b>genfile</b> option
    of mahapick, and performs a unique selection of matches for the treated
    set using a randomized priority order. The resulting selections are
    written to a separate file.
<p>
    The file to be used, <i>filename1</i>, should be in the form as written by 
    mahapick with the <b>genfile()</b> option. That is, it should have these
    variables:
        a "prime_id" variable that identifies treated cases;
        an "id" variable that identifies control cases matched to the treated
      cases;
        a "matchnum" variable, assumed to be int, enumerating the matches in
      closeness order;
        optionally, a "score" variable (float or double) - the distance
      measure.
<p>
    In <i>filename1</i>, every treated case should be present at least once, with
    <i>matchnum</i> =0 (and <i>idvar</i> = <i>prime_id</i>, though this latter condition is not
    mandatory). This is not a proposed match; it just carries the information
    that the <i>prime_id</i> value is a treated case. (But see the <b>nostrict</b> option
    for more on this matter.) Additionally, there are zero or more cases for
    the potential matches, with <i>matchnum</i> = 1, 2, 3, etc., corresponding to
    the best match, the second best match, the third best match, and so on.
    These potential matches are unique within each treated case, but not
    necessarily unique across different treated cases.  The purpose of
    <b>mahaselectunique</b> is to select among the potential matches such that they
    are unique across all treated cases.  Furthermore, if more than one match
    per treated case is opted (<i>#</i>&gt;1), the selected matches are unique across
    the entire set.
<p>
<b><u>Required Options</u></b>
<p>
    <b>usefile(</b><i>filename1</i><b>)</b> specifies the file to read, as described above.
<p>
    <b>writefile(</b><i>filename2</i><b>)</b> specifies the file to be written; it will have the
    same structure as <i>filename1</i>, but without the <i>matchnum</i> =0 cases. It will
    have exactly <i>#</i> cases for each value of <i>prime_id</i>, though some may have
    missing <i>idvar</i> and <i>matchnum</i> values.
<p>
    <b>idvar(</b><i>idvar</i><b>)</b> specifies the name of the id variable, which holds the
    identifier values of the matched control cases in the two files..
<p>
<b><u>Optional Options</u></b>
<p>
    <b>prime_id(</b><i>prime_id</i><b>)</b> allows you to specify the name for the prime_id
    variable, which holds the identifier values of the treated cases in the
    two files.  The default name is _prime_id.
<p>
    <b>matchnum(</b><i>matchnum</i><b>)</b> allows you to specify the name for the matchnum
    variable, which enumerates the matched control cases, presumably in
    increasing order of the distance measure value. The default name is
    _matchnum.
<p>
    <b>scorevar(</b><i>scorevar</i><b>)</b> allows you to specify the name of the score variable,
    containing the distance measure. The default name is _score. See
    additional notes under <b>Remarks</b>.
<p>
           --------------------------------------------------------------------
            <b>note:</b> The four variables specified by <b>idvar(</b><i>idvar</i><b>)</b>,
            <b>prime_id(</b><i>prime_id</i><b>)</b> <b>matchnum(</b><i>matchnum</i><b>)</b>, and
            <b>scorevar(</b><i>scorevar</i><b>)</b> will be sought in <i>filename1</i> and
            written into <i>filename2</i>. They correspond to the
            same-named options in <b>mahapick</b>, assuming that <i>filename1</i>
            was written by <b>mahapick</b>.
<p>
            <b>scorevar(</b><i>scorevar</i><b>)</b> is optionally present in <i>filename1</i>;
            if it is absent, just omit this option. If you do not
            specify this option, and there is a variable named
            _score in <i>filename1</i>, it will automatically be carried
            into <i>filename2</i>.
<p>
            The variable names specified by <b>prime_id(</b><i>prime_id</i><b>)</b>
            <b>matchnum(</b><i>matchnum</i><b>)</b>, and <b>scorevar(</b><i>scorevar</i><b>)</b> have the
            same default values as in <b>mahapick</b>. Thus, you need to
            specify them only if you specified them in <b>mahapick</b>
            with non-default values.
           --------------------------------------------------------------------
<p>
    <b>nmatch(</b><i>#</i><b>)</b> specifies how many matches per treated case to gather. The
    default is 1.  See additional notes under <b>Remarks</b>.
<p>
    <b>seed(</b><i>seedvalue</i><b>)</b> specifies a seed value for the random-selection process.
    This can be useful if you want to be able to exactly replicate the
    process; it also can be included in the documentiation of your
    data-preparation processes.  The value provided can be anything that is
    acceptible to the set seed command. This includes integers in the range
    of 1..(2^32-1), and "code" values - that which is returned by the c(seed)
    function, representing the internal state of the random number generator.
    The latter appear to be strings of the form "X" (upper case X) followed
    by 36 hex digits, though possibly not all such strings are accepted.
<p>
    <b>replace</b> specified that if <i>filename2</i> already exists, it will be
    overwritten.
<p>
    <b>clear</b> specifies that it is okay to replace the data in memory, even
    though the current data have not been saved to disk. This program will 
    use <i>filename1</i>, so the in-memory data needs to be either empty (cleared)
    or "safe" to replace (saved to disk); otherwise, you will need to specify
    <b>clear</b>.
<p>
    <b>nostrict</b> relaxes the requirement that every teated case be present in
    <i>filename1</i> with one record having <i>matchnum</i>=0.  By default, the set of
    treated cases is taken from the <i>prime_id</i> values in records having
    <i>matchnum</i>==0. If there are any treated cases with only the <i>matchnum</i>&gt;0
    cases present, then such cases will be omitted (but you will be shown a
    list of their <i>prime_id</i> values). The <b>nostrict</b> option relaxes this
    behavior; the set of treated cases will then be the set of all <i>prime_id</i>
    values present in <i>filename1</i>.  If <i>filename1</i> was produced by <b>mahapick</b>, then
    this option should not be needed.
<p>
<b><u>Remarks</u></b>
<p>
    See mahapick for an explanataion of the distance measure, the matching
    process, and the concept of the treated cases.  <b>mahapick</b> will obtain a
    set of potential match candidates for each of the treated cases, but they
    may not be unique.  (They should be unique for any given treated case,
    but not necessarily unique across different treated cases.)
    <b>mahaselectunique</b> will attempt to reduce that to a set of unique matches.
    The selection process begins by marking all potential matches as
    available. The treated cases are visited in a random order.  For each
    treated case, the best available matching control case is chosen, and all
    other potential matches (for all treated cases) with the same value of
    <i>idvar</i> are marked as unavailable. (The "best available matching control
    case" is the one with the lowest <i>matchnum</i> value among those that are
    available.) If <b>nmatch(</b><i>#</i><b>)</b> is specified as greater than 1, then additional
    passes through the treated cases are performed; each pass through this
    process is given a different random order.  (Thus, the second and
    subsequent selections for a given treated case are not made in the same
    pass; to do so would give the early-chosen treated cases an unfair
    advantage on all of their selections.)
<p>
    <i>filename2</i> will not be sorted as you might expect. It is written in the
    order that selections were made, that is, randomly. But if you sort on
    <i>prime_id</i> and <i>matchnum</i>, it will make more sense.  It may have cases with
    <i>matchnum</i>=-1, signifying that <i>filename1</i> had no potential matches for the
    given value of <i>prime_id</i>; it may also have cases with <i>matchnum</i>=.,
    signifying that no more potential matches were available.  (Note that
    <i>filename1</i> should have no instances of <i>matchnum</i> being negative or
    missing.)
<p>
    If <i>scorevar</i> is included, it is not used in determining the closeness of
    the match; it is only carried along into <i>filename2</i>.  Presumably, <b>mahapick</b>
    already did the job of setting <i>matchnum</i> based on <i>scorevar</i>.
<p>
    The value specified under <b>nmatch(</b><i>#</i><b>)</b> should be significantly less than
    that specified in <b>nummatches(</b><i>#</i><b>)</b> in <b>mahapick</b>; conversely, the <b>nummatches</b>
    value needs to significantly greater than the <b>nmatch</b> value.
    <b>nummatches(</b><i>#</i><b>)</b> is the size of the available pool of match candidates for
    each treated person. Because there may be replication in these
    candidates, it needs to be larger than <b>nmatch(</b><i>#</i><b>)</b>, so that every treated
    case can get at least that many unique matches. How much larger depends
    on the degree of replication among the close matches, which is dependent
    on the data as well as the choice of covariates used in <b>mahapick</b>. Some
    experimentation in the <b>nummatches</b> value may be needed to get it
    sufficiently large. Adjusting of the covariate set may also be useful, as
    will be explained.
<p>
    If you are not getting enough matches selected in <i>filename2</i> it could mean
    either that <b>nummatches</b> in <b>mahapick</b> needs to be increased, or that the
    covariate set needs to be adjusted. Putting aside which of these is the
    issue, let's examine what happens when you have many possible control
    cases in <i>filename1</i>, but you are not getting very many matches showing up
    in <i>filename2</i>.  In this situation, although there are many control cases
    potentially matchable to the treated cases, there are not enough unique
    cases (distinct values of <i>idvar</i>) among them; there are many duplicates.
    Another characterization of this situation is that the best <b>nmatch(</b><i>#</i><b>)</b>
    matches for the treated cases are concentrated among a too-small portion
    of the potential control pool - a portion significantly smaller than
    <b>nmatch(</b><i>#</i><b>)</b>* num_treated_cases / num_potential_control_cases.
<p>
    It is worth paying attention to the <i>matchnum</i> values in <i>filename2</i>. These
    indicate the quality of the choice made in the selection process - in
    terms of the rank of the choice's closeness to the treated case.
    Suppose, for example, that a given treated case has 8 as as its first (or
    only) <i>matchnum</i>, this means it got the 8th closest match, which means that
    by the time its match was selected, the first 7 best matches were already
    taken. If there is no match at all, that means that all the available
    potential matches (the best <b>nummatches</b>) were already taken. (It may have
    been destined to get, say, the 12th best match, but you only had 10
    available.) So, if you are not getting enough matches, increasing
    <b>nummatches</b> may help. But there are reasons that point to adjusting the
    covariate set as well.
<p>
    If you are not getting enough matches in <i>filename2</i>, or if you do get
    enough, but <i>matchnum</i> values are high, then this means that, among the
    potential control cases, a large portion are equally or nearly equally
    close to the treated cases in terms of the distance measures. It also may
    signify that many of the treated cases are close to each other, and thus
    "attract" many of the same control cases.  Whether that is good or not is
    for you to decide. But it may be that your set of covariates could be
    adjusted so as to spread out the distance values. Of course, the choice
    of covariates needs to be guided by analytical considerations, but it is
    worth noting that having at least one continuous measure (with a wide
    varitety of values) in the covariate set is helpful toward the goal of
    spreading out the distance measure. If on the other hand, there are no
    continuous variable - just a few dicotomous variables, then the distance
    measure will range over a small set of values.  That, in turn, makes it
    likely that many pairs of cases will have the exact same distance
    measure, and consequently, many treated cases may have the same best
    match (and second best, etc) among the potential control cases.  For
    example, if the covariate set contains just five dicotomous variables,
    the distance measure will have at most 32 distinct values
<p>
    In the situation where the <i>matchnum</i> value is high, such as 8 in the
    example given above, it may be worth examining the spread of the distance
    measures in <i>filename1</i>; this would be done for the first <i>n</i> potential
    matches for each given treated case, where <i>n</i> is the maximal chosen
    <i>matchnum</i> in <i>filename2</i> for the given treated case - or for the first <i>n</i>
    matches among all potential matches, where <i>n</i> is the maximal <i>matchnum</i> in
    <i>filename2</i> overall.  If they are close together, then a "poor" choice of a
    match may not be so bad after all; it may have been nearly as good as the
    preferred ones. If, on the other hand, they are spread out, then the
    "poor" choices are truly less desirable.
<p>
    Conceivably, <b>mahaselectunique</b> could use a file written by <b>mahascores</b>,
    with the <b>genfile</b> and <b>treated</b> options, as well as <b>name1</b> and <b>name2</b>, however
    the file would need to be sorted on <i>name1</i> and <i>scorevar</i>, and have <i>matchnum</i>
    generated. (<b>by</b> <i>name1</i> <b>(</b><i>scorevar</i><b>): gen int</b> <i>matchnum</i><b>=_n</b>.) But you will need
    the <b>nostrict</b> option in <b>mahaselectunique</b>.
<p>
    After running <b>mahaselectunique</b>, you will be left with reords from
    <i>filename1</i> where <i>matchnum</i> &gt;0, but sorted in a random order.
<p>
<b><u>Example, including call to mahapick</u></b>
<p>
    <b>. mahapick income age numkids, idvar(id0) genfile(match1)</b>
        <b>nummatches(12)treated(assisted)</b>
    <b>. mahaselectunique, idvar(id0) usefile(match1) writefile(match2)</b>
        <b>seed(14716)</b>
<p>
<p>
<b><u>Acknowledgement</u></b>
    The author wishes to thank Paula Arce for the inspiration to write this
    program.
<p>
<b><u>Author</u></b>
    David Kantor. Email kantor.d@att.net if you observe any problems.
<p>
<b><u>Also See</u></b>
    mahapick, mahascore, mahascores, mahascore2, covariancemat, variancemat, 
    screenmatches, stackids.
<p>
</pre>