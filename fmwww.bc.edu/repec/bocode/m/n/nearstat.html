<pre>
-------------------------------------------------------------------------------
<b>help for nearstat</b> 
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
  <b>nearstat --- Calculates distances, generates distance-based variables, and</b>
        <b>exports distance matrix to files.</b>
<p>
<a name="contents"></a>        +--------------------+
    ----+  Table of Contents +-----------------------------------------------
<p>
  Syntax
  General description
  Description of the options
  Saved scalars
  Examples
  References
  Citation
  Author information
-------------------------------------------------------------------------------
<p>
<a name="syntax"></a><b><u>Syntax</u></b>
<p>
    <b>nearstat</b> <i>varlist1</i> [if] [in]<b>,</b> <b>near(</b><i>varlist2</i><b>)</b> <b><u>dist</u></b><b>var(</b><i>newvar1</i><b>)</b> [ <i>Other</i>
        <i>options</i> ]
<p>
<p>
    <i>options</i>                           Description
    -------------------------------------------------------------------------
    Options
        
      <b>near(</b><i>varlist2</i><b>)</b>                  indicate latitudes and longitudes for
                                        the neighboring observations or areal
                                        units; this option is required
<p>
      <b><u>dist</u></b><b>var(</b><i>newvar1</i><b>)</b>                calculate distance to nearest
                                        neighbors; this option is required
<p>
      <b>kth(</b><i>#</i><b>)</b>                          specify the order of the nearest
                                        neighbors to which distance needs to
                                        be calculated; default is kth(1)
<p>
      <b>nid(</b><i>varname</i> <i>newvar2</i><b>)</b>            request the identity or name of the
                                        specified nearest neighbors
<p>
      <b>cart</b>                            request distance calculation for
                                        Cartesian coordinates.
<p>
      <b>r(</b><i>#</i><b>)</b>                            indicate the earth radius value to be
                                        used in case of spherical
                                        coordinates; default is r(6371.009),
                                        i.e., 6371.009 km
<p>
      <b><u>contv</u></b><b>ar(</b><i>varlist3</i><b>)</b>               specify a list of variables to be used
                                        in calculation of descriptive
                                        statistics
<p>
      <b><u>statv</u></b><b>ar(</b><i>newvarlist</i><b>)</b>             specify a list of new variable names to
                                        hold calculated descriptive
                                        statistics or to hold the variable
                                        values corresponding to nearest
                                        neighbors
<p>
      <b><u>statn</u></b><b>ame(</b><i>stats</i><b>)</b>                 indicate the descriptive statistics to
                                        be calculated
          : where <i>stats</i> is either <i>min</i>, <i>max</i>, <i>mean</i>, <i>std</i>, or <i>sum</i>
<p>
      <b>knn(</b><i>#&gt;</i><b>=</b><i>2</i><b>)</b>                       request statistics for nearest
                                        neighbors
<p>
      <b><u>db</u></b><b>and(</b><i>numlist</i><b>)</b>                  specify a distance band when requesting
                                        statistics, a neighbor count
                                        variable, or a dummy variable for
                                        neighbors falling in the specified
                                        distance band
<p>
      <b><u>all</u></b><b>nei</b>                          request descriptive statistics for all
                                        neighbors
<p>
      <b><u>dn</u></b><b>ame(</b><i>newvar3</i><b>)</b>                  request a dummy variable equal to 1 if
                                        the specified nearest neighbors are
                                        within the distance band specified
                                        with <b>dband()</b>
<p>
      <b><u>nc</u></b><b>ount(</b><i>newvar4</i><b>)</b>                 request a variable holding the number
                                        of neighbors falling in ring <b>dband()</b>
<p>
      <b><u>inc</u></b><b>dist(</b><i>newvar5</i><b>)</b>                request a variable holding incremental
                                        distance to reach a metropolitan area
                                        with a specified population threshold
<p>
      <b>atpop(</b><i>#</i><b>)</b>                        specify the metropolitan area
                                        population threshold
<p>
      <b>alpha(</b><i>#</i><b>)</b>                        request distance weighted statistics
<p>
      <b>iidist(</b><i>newvar6</i><b>)</b>                 request a variable holding one-to-one
                                        distance between input and near
                                        features
<p>
      <b><u>minm</u></b><b>axd(</b><i>newvar7</i> <i>mmtype</i><b>)</b>         request a variable holding the mininimu
                                        or maximum distance for each
                                        observation, where <i>mmtype</i> must equal
                                        to <i>min</i> or <i>max</i>
<p>
      <b><u>exp</u></b><b>dist(</b><i>distname</i><b>)</b>               export a matrix containing the
                                        distances between each input feature
                                        and all near features
          
      <b>expto(</b><i>Stata</i>|<i>tab</i>|<i>csv</i>|<i>Mata</i><b>)</b>       specify a file format for the distance
                                        matrix
<p>
      <b><u>spa</u></b><b>rse(</b><i>tab</i>|<i>csv</i>|<i>Mata</i><b>)</b>            export the distance matrix in sparse
                                        form
<p>
      <b><u>noz</u></b><b>ero</b>                          remove zeros from sparse distance
                                        matrix
<p>
      <b>des(</b><i>des_option,</i>[<i>des_suboption</i>]<b>)</b> display descriptive statistics for the
                                        distances between input and near
                                        features, distance to the kth-nearest
                                        neighbors (k=1,..., N-1), and
                                        neighbor count within a distance band
          : where <i>des_option=stat</i> to request <i>Min, Mean, Std, Max, and Sum</i>
            and <i>des_suboption=quart</i> to request <i>quartiles</i>
<p>
      <b>replace</b>                         overwrite existing variables and files
<p>
      <b>favor(</b><i>speed</i>|<i>space</i><b>)</b>              favor speed or space
<p>
    -------------------------------------------------------------------------
<p>
<a name="description"></a>        +-------------+
    ----+ Description +------------------------------------------------------
<p>
    Using Mata, the Stata’s new matrix language, <b>nearstat</b> calculates
    distances, generates distance-based variables, and exports the distances
    to a Stata matrix, a Mata file, or a text file. To generate the
    variables, <b>nearstat</b> performs, for each observation in a Stata dataset, a
    series of computational tasks including, but not limited to, calculating
    distance-weighted descriptive statistics over all neighbors, nearest
    neighbors, and neighbors falling in a specified distance band;
    calculating distance to nearest neighbors; counting the number of
    neighbors falling in a specified distance band; and determining whether a
    specified (e.g., first, second, third,…) nearest neighbor falls within a
    certain distance band. Distance is calculated as the Great Circle or
    crow-fly distance depending on whether spherical or Cartesian coordinates
    are supplied to <b>nearstat</b>.
<p>
    Spherical coordinates can be obtained from any shapefiles using the Stata
    command <b>shp2dta</b> written by Kevin Crow (see shp2dta if installed). If not
    installed, a copy of <b>shp2dta</b> can be found here.
<p>
    <b>T</b>opologically <b>I</b>ntegrated <b>G</b>eographic <b>E</b>ncoding and <b>R</b>eferencing (TIGER)-
    LINE shapefiles for metropolitan areas, counties, census tracts, etc.,
    are available from the U.S. Census Bureau's website (see the references
    below). One way to obtain Cartesian or projected coordinates is to
    project the shapefiles in the ArcGIS software using appropriate projected
    coordinate systems.
<p>
        <b>nearstat</b> requires Stata 10.1 or higher.
<p>
<p>
<a name="options"></a>        +---------+
    ----+ Options +----------------------------------------------------------
<p>
    <b>near(</b><i>varlist2</i><b>)</b> specifies the variables holding latitudes and longitudes
        for the observations or areal units to which distance needs to be
        calculated. This option is required.
<p>
        <i>varlist1</i> holds latitudes and longitudes for the observations or areal
        units from which distance needs to be calculated.
<p>
        Observations or areal units in <i>varlist1</i> are referred to as input
        features and those in <i>varlist2</i> are referred to as near features.
<p>
        <b>Note 1:</b> <i>varlist1</i> and <i>varlist2</i> may contain the same areal units. For
        example, you might want to calculate the distance from each county to
        its nearest neighboring county or to obtain for each county the
        average per capita income for the eight nearest counties. In this
        case, the two variables supplied in <i>varlist1</i> would be exactly the
        same as those supplied in <i>varlist2</i>.
<p>
        Different areal units are also allowed. For instance, you might want
        to calculate the distance from each rural county to its nearest
        metropolitan area. In this case, <i>varlist1</i> would hold the latitudes
        and longitudes of the rural counties while <i>varlist2</i> would contain the
        population weighted latitudes and longitudes of the metropolitan
        areas. Although the areal units supplied in <i>varlist1</i> and <i>varlist2</i> may
        be different, their coordinates must be of the same type.
<p>
    <b>distvar(</b><i>newvar1</i><b>)</b> specifies the name of a variable for holding distance
        from each input feature to its nearest neighbor specified with the
        <b>kth(</b><i>#</i><b>)</b> option. This option is required.
<p>
    <b>kth(</b><i>#</i><b>)</b> indicates the order of the nearest neighbors to which distance is
        to be calculated. For example, specifying <b>kth(</b><i>2</i><b>)</b> indicates the second
        nearest neighbors. The default is to calculate distance to the first
        nearest neighbors, i.e., <b>kth(</b><i>1</i><b>)</b>.
<p>
    <b>nid(</b><i>varname</i> <i>newvar2</i><b>)</b> requests the identification numbers or names of the
        nearest neighbors specified with <b>kth(</b><i>#</i><b>)</b>. This option requires two
        variable names. The first one should be the name of the identifier
        variable for the near features. The other one is the name of a
        variable to hold the requested identitification numbers or names.
        Obviously, if <i>varlist1</i> = <i>varlist2</i> then there is only one identifier
        variable for both input and near features. If an observation has two
        or more equidistant neighbors, given the order considered, <b>nearstat</b>
        will report the first one encountered.
<p>
    <b>cart</b> indicates that coordinates are projected and that crow-fly distance
        should be calculated using the Pythagorean formula:
        <b>dij=sqrt((xj-xi)^2+(yj-yi)^2)</b>. When <b>cart</b> is specified, the distance
        unit is the same as that of the projected coordinates.  Option <b>cart</b>
        may be specified if the coordinates are in arbitrary digitizing
        units.
<p>
        By default, distance is calculated for spherical non-projected
        coordinates. In such a case, <b>nearstat</b> calculates the "Great Circle"
        distance using the Haversine formula, which yields more accurate
        distance than the Law of Cosines or Vincenty formula due to problems
        related to small distances.
<p>
        The Haversine formula to calculate distance between two points is
        given as follows:
<p>
        <u>Haversine Formula</u>
            <i>dlong = long2 - long1</i>
            <i>dlat = lat2 - lat1</i>
            <i>z = sin^2(dlat/2) + cos(lat1) * cos(lat2) * sin^2(dlong/2)</i>
            <i>c = 2 * arcsin(min(1,sqrt(z)))</i>
            <i>dist = r * c</i>,
            where <i>c</i> is the Great Circle distance in radians and <i>r</i> is the
            radius of the earth. <i>dist</i> is in the same unit as <i>r</i>.  By default,
            <i>r</i> is set to 6371.009 km considered to be the Earth's mean radius
            by the International Union of Geodesy and Geophysics (IUGG).  The
            IUGG's corresponding value in miles is 3958.761, which users can
            supply with the <b>r()</b> option to obtain distance in miles.
<p>
        Spherical coordinates must be measured in decimal degrees. If your
        coordinates are in a degrees, minutes, and seconds format, you can
        convert them into decimal degrees using the following formula:
<p>
            <i>Decimal value = Degrees + (Minutes/60) + (Seconds/3600)</i>
<p>
        For instance, a latitude of 122 degrees 45 minutes 45 seconds north
        is equal to 122.7625 degrees north.
<p>
    <b>r(</b><i>#</i><b>)</b> indicates the value to be used for the Earth radius or mean radius
        in case of spherical coordinates. The Earth radius usually refers to
        various fixed distances and to various mean radii since only a sphere
        has a true radius. Fortunately, the numerical differences among
        different radii vary by far less than one percent, making the choice
        of # less of a concern.
<p>
        <b>r(</b><i>#</i><b>)</b> and <b>cart</b> may not be combined.
<p>
    <b>contvar(</b><i>varlist3</i><b>)</b> specifies the variables to be used in calculating the
        statistics or the variables whose values associated with the nearest
        neighbors need to be reported.
<p>
        <b>Note 2:</b> <i>varlist3</i> must have the same number of valid (non-missing)
        observations as <i>varlist2</i>.
<p>
    <b>statvar(</b><i>newvarlist</i><b>)</b> provides a list of names for the variables to hold
        the calculated descriptive statistics or to hold the values of the
        variables in <i>varlist3</i> corresponding to the nearest neighbors. Specify
        one variable name for each variable in <i>varlist3</i>.
<p>
        <b>Note 3:</b> Options <b>contvar()</b> and <b>statvar()</b> must be combined.
<p>
    <b>statname(</b><i>stats</i><b>)</b> indicates the statistics to be calculated. <i>stats</i> may be
        either min, max, mean, std, or sum.  When variables listed in
        <i>varlist3</i> are dummies, mean is equivalent to proportion or percentage
        if multiplied by 100.
<p>
        <b>Note 4:</b> If <b>contvar()</b> and <b>statvar()</b> are specified, but <b>statname()</b> is
        not, then each variable in listed <i>newvarlist</i> will contain the values
        of the corresponding variable listed in <i>varlist3</i> associated with the
        nearest neighbors, given the order specified with <b>kth()</b> (see examples
        2 and 4).
<p>
    <b>knn(</b><i>#</i><b>)</b> indicates the number of nearest neighbors to be used when
        calculating the descriptive statistics. # cannot be less than 2 or
        greater than the number of valid observations contained in <i>varlist2</i>.
<p>
    <b>dband(</b><i>numlist</i><b>)</b> indicates the distance band to be used with option <b>dname()</b>
        and/or <b>ncount()</b>, or requests that statistics be calculated for near
        features falling in the ring specified with <b>dband()</b>.
<p>
        <b>Note 5:</b> When <b>dband()</b> is specified, by default, the distance unit is
        assumed to be kilometers, but that can be overridden with option <b>cart</b>
        or <b>r(</b><i>#</i><b>)</b>.
<p>
    <b>allnei</b> requests that statistics be calculated using all near features.
        <b>allnei</b> and <b>knn()</b> may not be combined.
<p>
    <b>alpha(</b><i>#</i><b>)</b> requests distance-weighted statistics. For instance, if <b>alpha(</b><i>1</i><b>)</b>
        is specified, <b>nearstat</b> will divide the values of the variables listed
        in <i>varlist3</i> by distance prior to calculating the statistics.
        Specifying <b>alpha(</b><i>2</i><b>)</b> entails dividing by distance squared.
<p>
    <b>dname(</b><i>newvar3</i><b>)</b> provides the name for a dummy variable equal to one if a
        nearest neighbor specified with <b>kth()</b> is within the distance band
        specified with <b>dband()</b> and zero otherwise.
<p>
    <b>ncount(</b><i>newvar4</i><b>)</b> specifies the name of a variable to hold, for each
        observation, the number of neighbors falling in the distance band
        specified with <b>dband()</b>.
<p>
        <b>Note 6:</b> When <b>allnei</b> or <b>knn(</b><i>#</i><b>)</b> is specified, specifying <b>dband()</b>
        implies a request for a neighbor count variable or for a dummy
        variable. As a result, either <b>ncount()</b> or <b>dname()</b> must be specified.
<p>
    <b>incdist(</b><i>newvar5</i><b>)</b> specifies the name of a variable for holding incremental
        distance to reach the threshold population specified with <b>atpop()</b>
        (see Partridge and Rickman, 2008). <b>incdist()</b> and <b>statvar()</b> may not be
        combined.
<p>
    <b>atpop(</b><i>#</i><b>)</b> specifies a metropolitan area population threshold for which
        incremental distance needs to be calculated. <b>atpop()</b> and <b>incdist()</b>
        must be combined.
<p>
    <b>iidist(</b><i>newvar6</i><b>)</b> specifies the name of a variable to hold one-to-one
        distance between input and near features when they are different but
        have the same number of non-missing observations. Essentially, this
        variable holds the diagonal elements of the distance matrix.
<p>
    <b><u>minm</u></b><b>axd(</b><i>newvar7</i> <i>mmtype</i><b>)</b> requests that a variable for holding the minimum
        or maximum distance from each observation to its neighbors be
        generated. <i>mmtype</i> should be equal to <i>min</i> or <i>max</i> to request the
        minimum or maximum distance respectively.
<p>
    <b>expdist(</b><i>distname</i><b>)</b> requests that distance between input and near features
        be exported as a matrix to the permanent file or temporary matrix
        <i>distname</i>.
<p>
    <b>expto(</b><i>Stata</i>|<i>tab</i>|<i>csv</i>|<i>Mata</i><b>)</b> indicates whether the distance matrix should be
        exported to a Stata matrix loaded in memory or to a file in a tab
        delimited, csv, or Mata format. Note that if <b>expto(</b><i>Stata</i><b>)</b> is
        specified, a Stata matrix loaded in memory will be created only if
        the matrix size does not exceed the matsize limit of your Stata
        flavor.
<p>
    <b>sparse(</b><i>tab</i>|<i>csv</i>|<i>Mata</i><b>)</b> specifies that the distance matrix be written as a
        three-column matrix (row, column, value) to a tab delimited, a csv,
        or a Mata file. <b>expto()</b> and <b>sparse()</b> may not be combined, but you
        must specify one of them when <b>expdist()</b> is specified.
<p>
    <b>nozero</b> specifies that the diagonal zeros be removed from the sparse
        distance matrix. By default, the diagonal zeros are not removed.
<p>
    <b>des(</b><i>des_option,</i>[<i>des_suboption</i>]<b>)</b> requests that descriptive statistics for
        the distances between input and near features and the distances to
        the nearest neighbors specified with <b>kth(</b><i>#</i><b>)</b> be displayed. <i>des_option</i>
        is required when <b>des()</b> is specified.
<p>
        If <i>des_suboption</i> is not specified, then statistics include number of
        location pairs, minimum, mean, standard deviation, and maximum
        distance. Otherwise, lower quartile, median or second quartile, and
        upper quartile will be displayed as well. With or without the <b>des()</b>
        option specified, these statistics are returned as saved scalars.
<p>
        Descriptive statistics for the number of neighbors falling in ring
        <b>dband()</b> will also be displayed if <b>ncount()</b> is specified.
<p>
    <b>replace</b> overwrites existing variables <i>newvar1</i>, <i>newvar2</i>, <i>newvar3</i>, <i>newvar4</i>,
        <i>newvar5</i>, <i>newvar6</i>, <i>newvar7</i> and any variables listed in <i>newvarlist</i> and
        existing file <i>distname</i>.
<p>
    <b>favor(</b><i>speed</i>|<i>space</i><b>)</b> instructs <b>nearstat</b> to favor speed or space when
        performing all the calculations.  <b>favor(</b><i>speed</i><b>)</b> is the default. This
        option provides a trade-off between speed and memory use. See [M-3]
        mata set.
<p>
<a name="results"></a>        +---------------+
    ----+ Saved scalars +----------------------------------------------------
<p>
  r(nearest_min) =  Minimum of the distance to the kth nearest neighbors
  r(nearest_max) =  Maximum of the distance to the kth nearest neighbors
 r(nearest_mean) =  Average of the distance to the kth nearest neighbors
       r(n_near) =  Number of near features
      r(n_input) =  Number of input features
     r(max_dist) =  maximum distance between input and near features
      r(Q3_dist) =  Upper quartile distance between input and near features 
      r(Q2_dist) =  Median or middle quartile distance between input and near f
&gt; eatures
    r(mean_dist) =  Average distance between input and near features
      r(Q1_dist) =  Lower quartile distance between input and near features
     r(min_dist) =  Minimum distance between input and near features
          r(Obs) =  Number of location pairs between which distance was calcula
&gt; ted
<p>
<p>
<a name="examples"></a>        +----------+
    ----+ Examples +---------------------------------------------------------
<p>
    1) Calculate average test score and proportion of nonwhite for the first
        3 nearest neighbors using Cartesian coordinates
<p>
        <b>. nearstat latitude longitude, near(latitude longitude)</b>
        <b>distvar(distname) ///</b>
          <b>cart contvar(testscore nonwhite) statvar(avtest pctnwhite) knn(3) ///</b>
          <b>statname(mean)</b>
<p>
    Note that in this case, <i>varlist1</i> is the same as <i>varlist2</i>
<p>
  -----------------------------------------------------------------------------
<p>
    2) Determine the identification number, test score, and race of each
        observation's nearest neighbor
<p>
        <b>. nearstat latitude longitude, near(latitude longitude)</b>
        <b>distvar(distname) ///</b>
          <b>cart contvar(testscore nonwhite) statvar(near_score near_race) ///</b>
          <b>nid(id nei_id) replace</b>
<p>
    Here option <b>replace</b> is specified to replace the variable <b>distname</b> already
        created.
<p>
  -----------------------------------------------------------------------------
<p>
    3) Calculate distance from each county to the nearest metropolitan area
        using spherical coordinates
<p>
      a) First, load the county level data
<p>
        <b>. use mycountydata</b>
<p>
      b) Second, merge your metropolitan level data
<p>
        <b>. merge using mymetrodata</b>
<p>
        <b>. drop _merge</b>
<p>
      c) Now you are ready to run <b>nearstat</b>
<p>
        <b>. nearstat latvar1 longvar1, near(latvar2 longvar2)</b>
        <b>distvar(distmetro)</b>
<p>
    Here <b>latvar1</b> and <b>longvar1</b> hold latitudes and longitudes of the counties
        and <b>latvar2</b> and <b>longvar2</b> contain population weighted latitudes and
        longitudes of the metropolitan areas.
<p>
  -----------------------------------------------------------------------------
<p>
    4) Calculate distance from each rural county to its nearest metropolitan
        area and record population of the nearest metropolitan area using
        spherical coordinates
<p>
        <b>. nearstat latvar1 longvar1, near(latvar2 longvar2)</b>
        <b>distvar(distmetro) ///</b>
         <b> contvar(popmetro) statvar(popnear)</b>
<p>
    Here popmetro is the variable holding population in each metropolitan
        area and popnear is the name of a variable to hold population in the
        nearest metropolitan area.
<p>
  -----------------------------------------------------------------------------
<p>
    5) Calculate incremental distance to reach a metropolitan area with a
        population of at least 500,000
<p>
        <b>. nearstat latvar1 longvar1, near(latvar2 longvar2)</b>
        <b>distvar(distmetro) ///</b>
          <b>contvar(popmetro) incdist(incd5) atpop(500000)</b>  
<p>
    Here incd5 is the name of a variable for holding the calculated
        incremental distance
<p>
  -----------------------------------------------------------------------------
<p>
    6) Create a variable (nearmetro) holding the population of a county if
        the county is part of a defined metropolitan area or the population
        of the nearest metropolitan area if the county is a non-metropolitan
        one.
<p>
      In addition to the variables in Example 4, you need a variable holding
        county population and a dummy variable equal to 1 if the county is
        part of a metropolitan area and zero otherwise.
<p>
      a) First, set the variable nearmetro equal to the county population
        variable:
<p>
        <b>. gen nearmetro=pop2000</b> // where pop2000 is a variable holding county
        population in 2000
<p>
      b) Second, calculate population in the nearest metropolitan area as in
        Example 4
<p>
      c)Third, replace nearmetro values with popnear values if the county is
        non-metro.
<p>
        <b>. replace nearmetro=popnear if metro==0</b> // where popnear is a
        variable holding population in the nearest metropolitan area
<p>
  -----------------------------------------------------------------------------
<p>
    7) Calculate average income for 200 nearest neighbors of each county
        using spherical coordinates
<p>
        <b>. nearstat lat long, near(lat long) distvar(distname) contvar(income)</b>
        <b>///</b>
          <b>statvar(avincome) statname(mean) knn(200) replace</b>
<p>
  -----------------------------------------------------------------------------
<p>
    8) Obtain a dummy variable (dum1_150) equal to 1 if the first nearest
        neighbor is within 150 kilometers and zero otherwise
<p>
        <b>. nearstat lat long, near(lat long) distvar(distname) dname(dum1_150)</b>
        <b>///</b>
          <b>dband(0 150) replace</b>
<p>
  -----------------------------------------------------------------------------
<p>
    9) Obtain a dummy variable (dum3_150m) equal to one if the third nearest
        neighbor is within 150 miles and zero otherwise
<p>
        <b>. nearstat lat long, near(lat long) distvar(distvar3) kth(3)</b>
        <b>r(3958.761) ///</b>
          <b>dname(dum3_150m) dband(0 150)</b>
<p>
  -----------------------------------------------------------------------------
<p>
    10) Request a variable (nbnei) that holds (for each observation) the
        number of neighbors located within a two-mile radius
<p>
        <b>. nearstat lat long, near(lat long) distvar(mydist) ncount(nbnei)</b>
        <b>dband(0 2) ///</b>
         <b> r(3958.761)</b> 
<p>
  -----------------------------------------------------------------------------
<p>
    11) Display descriptive statistics for distance (in miles) between input
        and near features, assuming spherical coordinates
<p>
        <b>. nearstat lat long, near(lat long) distvar(mydist) des(stat)</b>
        <b>r(3958.761)</b>
<p>
    This line of code will generate a table containing two rows. The second
        row reports, for example, the maximum distance from the first nearest
        neighbor, which is the minimum distance (or distance cut-off) to
        obtain at least one neighbor for each observation.
<p>
  -----------------------------------------------------------------------------
<p>
    12) Display descriptive statistics for the distances between input and
        near features and for the number of neighbors falling in the distance
        band: 0&lt;dij&lt;=9
<p>
        <b>. nearstat latitude longitude, near(latitude longitude)</b>
        <b>distvar(distname) ///</b>
          <b>des(stat) db(0 9) ncount(neicount) replace</b> 
<p>
  -----------------------------------------------------------------------------
<p>
    13) Calculate for each county the proportion of surrounding counties with
        high poverty rate (poverty rate &gt;=20%) in 2000
<p>
      a) Create a dummy variable (pov20_00) equal to one if a county has a
        poverty rate &gt;=20% and zero otherwise
<p>
        <b>. gen pov20_00=(povrt00&gt;=20)</b>
<p>
      b) Calculate the proportion variable (neipov00) for which eight
        neighbors are considered.
<p>
        <b>. nearstat latitude longitude, near(latitude longitude)</b>
        <b>distvar(nearestnei) ///</b>
          <b>contvar(pov20_00) statvar(neipov00) statname(mean) knn(8)</b> 
<p>
  -----------------------------------------------------------------------------
<p>
    14) Calculate distance from each observation to District of Columbia (DC)
        to analyze housing values for example
<p>
      a) First, create a one-observation dataset with the latitude and
        longitude of DC:
<p>
        <b>. set obs 1</b>
<p>
        <b>. gen lat_dc=38.8964</b>
<p>
        <b>. gen lon_dc=-77.0262</b>
<p>
        <b>. save dc_coord</b>
<p>
      b) Second, load your housing value dataset:
<p>
        <b>. use mydataset, clear</b>
<p>
      c) Third, merge your data with the DC coordinates:
<p>
        <b>. merge using dc_coord</b>
<p>
      d) Finally, calculate distance from each observation to DC:
<p>
        <b>. nearstat lat long, near(lat_dc lon_dc) distvar(distodc)</b> // where
        lat and long are variables holding the housing coordinates
<p>
  -----------------------------------------------------------------------------
<p>
    15) Generate a variable (called dmax) for holding the maximum distance
        for each observation
<p>
        <b>. nearstat latitude longitude, near(latitude longitude)</b>
        <b>distvar(nearestnei) minmaxd(dmax max)</b>
<p>
  -----------------------------------------------------------------------------
<p>
<p>
<a name="refs"></a><b><u>References</u></b>
<p>
<b>de Smith, M.J., M.F. Goodchild, and P.A. Longley</b>, 2007. <i>Geospatial Analysis: A </i>
<i>&gt; comprehensive Guide to Principles, Techniques, and Software Tools</i>. Matador: L
&gt; eicester, UK
http://www.spatialanalysisonline.com
<p>
<b>Gould, W.</b> 2007. "Mata Matters: Subscripting". <i>The Stata Journal</i> 7: 106-116.
<p>
<b>Gould, W.</b> 2006. "Mata Matters: Creating New Variables—Sounds Boring, Isn't". <i>Th</i>
<i>&gt; e Stata Journal</i> 6: 112-123. 
Available at http://www.stata-journal.com/article.html?article=pr0021
<p>
<b>Jeanty, P.W., M. Partridge, and E. Irwin</b>. 2010. Estimation of a Spatial Simulta
&gt; neous Equation Model of Population Migration and Housing Price Dynamics.
<i>Journal of Regional Science and Urban Economics</i> 40(5): 343-352.
<p>
<b>Partridge, M. and R.S. Dan</b>. 2008. Distance from Urban Agglomeration Economies a
&gt; nd Rural Poverty. 
<i>Journal of Regional Science</i> 48(2):285-310.
<p>
<b>U.S. Census Bureau Geographic Information Systems FAQ.</b> <i>What is the best way to </i>
<i>&gt; calculate the distance between 2 points</i>
http://www.movable-type.co.uk/scripts/gis-faq-5.1.html.
<p>
<b>U.S. Census Bureau</b>. 2012. <i>Cartographic Boundary Files.</i> http://www.census.gov/ge
&gt; o/www/cob/bdy_files.html
   
<b>U.S. Census Bureau</b>. 2011. <i>Using the TIGER/Line Shapefiles and Census Data.</i> http
&gt; ://www.census.gov/geo/www/tiger/wwtl/wwtl.html
<p>
<b>U.S. Census Bureau</b>. 2011. <i>TIGER Products.</i> http://www.census.gov/geo/www/tiger/i
&gt; ndex.html#tl
<p>
<b>U.S. Census Bureau</b>. 2010. <i>Census 2000 Gazetteer Files.</i> http://www.census.gov/ge
&gt; o/www/gazetteer/places2k.html
<p>
<b>Wikipedia</b>. 2012. <i>Great-Circle Distance</i>. http://en.wikipedia.org/wiki/Great-circ
&gt; le_distance
<p>
<b>---------</b>. 2012. <i>Earth Radius</i>. http://en.wikipedia.org/wiki/Earth_radius#Mean_r
&gt; adii.
<p>
<p>
<a name="citat"></a><b><u>Citation</u></b>
<p>
Thanks for citing <b>nearestat</b> as follows:
<p>
<b>Jeanty, P.W.</b>, 2010. nearstat: Stata module to calculate distances, generate dis
&gt; tance-based variables, and export distance matrix to text files. 
Available from http://ideas.repec.org/c/boc/bocode/s457110.html.
<p>
<p>
<a name="author"></a><b><u>Author</u></b>
<p>
    <b>P. Wilner Jeanty</b>, The Kinder Institute for Urban Research/Hobby Center
    for the Study of Texas, Rice University, Houston, Texas
<p>
                        
    Email to pwjeanty@rice.edu
<p>
<p>
    <b>N.B.:</b> Previous versions of <b>nearstat</b> were written when the author was a
    Research Economist with the Dept. of Agricultural, Environmental, and
    Development Economics,
    The Ohio State University
<p>
<b><u>Also see</u></b>
<p>
    Online: <b>vincenty</b>, <b>nearest</b>, <b>distmatch</b> (if installed)
<p>
<p>
</pre>