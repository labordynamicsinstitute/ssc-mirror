<pre>
<p>
help for <b>nnmatch</b>
<p>
<p>
<b><u>Nearest Neighbor Matching Estimation for Average Treatment Effects</u></b>
<p>
        <b>nnmatch</b><i> depvar treatvar varlist_nnmatch</i> [<b>if</b> <i>exp</i>] [<b>in</b> <i>range</i>] [<b>pw</b>] [<b>,</b>
                <b>tc(</b><i>ate</i> |<i>att</i> |<i>atc</i><b>)</b> <b>m(</b><i>#</i><b>)</b> <b><u>met</u></b><b>ric</b><b>(</b><i>maha</i> |<i>matname</i><b>)</b> <b><u>ex</u></b><b>act(</b><i>varlist_ex</i><b>)</b>
                <b><u>bias</u></b><b>adj(</b><i>bias</i> |<i>varlist_adj</i><b>)</b> <b><u>rob</u></b><b>ust(</b><i>#_v</i><b>)</b> <b><u>pop</u></b><b>ulation</b> <b><u>l</u></b><b>evel(</b><i>#</i><b>)</b>
                <b><u>k</u></b><b>eep(</b><i>filename</i><b>) replace</b>]
<p>
<i>depvar</i>, <i>varlist_nnmatch</i>, and elements of <b>biasadj(</b><i>varlist_adj</i><b>)</b> and
<b>exact(</b><i>varlist_ex</i><b>)</b> must be numeric variables.  <i>treatvar</i> must be a {0,1}
variable.
<p>
<p>
<b><u>Description</u></b>
<p>
<b>nnmatch</b> estimates the average treatment effect on <i>depvar</i> by comparing outcomes
between treated and control observations (as defined by <i>treatvar</i>), using
nearest neighbor matching across the variables defined in <i>varlist_nnmatch</i>.
<b>nnmatch</b> can estimate either the treatment effect for the treated observations,
for the controls, or for the sample as a whole.  The program pairs observations
to the closest <i>m</i> matches in the opposite treatment group to provide an estimate
of the counterfactual treatment outcome.  The program allows for matching over
a multi-dimensional set of variables(<i>varlist_nnmatch</i>), giving options for the
weighting matrix to be used in determining the optimal matches.  It also allows
exact matching (or as close as possible) on a subset of variables. In addition,
the program allows for bias correction of the treatment effect, and estimation
of either the sample or population variance, with or without assuming a
constant treatment effect (homoskedasticity).  Finally it allows observations
to be used as a match more than once, thus making the order of matching
irrelevant.  See Imbens et al. (Stata Journal 2004) for greater detail.
<p>
<p>
<b><u>Options</u></b>
<p>
<b>tc(</b><i>ate|att|atc</i><b>)</b> specifies which treatment effect is to be estimated:
<p>
    <i>ate</i>: the average treatment effect,
    <i>att</i>: the average treatment effect for the treated, or
    <i>atc</i>: the average treatment effect for the controls.
<p>
    If no option is specified, the average treatment effect, <i>ate</i>, is assumed.
    In this case all observations are matched to their nearest <i>m</i> neighbors of
    the opposite treatment group.  In estimating the <i>att</i> or <i>atc</i>, only the
    treated or controls, respectively, are matched.
<p>
<b>m(</b><i>#</i><b>)</b> specifies the number of matches to be made per observation. If two
    observations of the opposite treatment group are equally close to that
    being matched, both will be used.  Thus the number of matches per
    observation will be greater than or equal to <i>m</i>.  If the average treatment
    effect is selected, <i>m</i> must be less than or equal to the smaller of <i>N0</i> and
    <i>N1</i>, where <i>N0</i> is the number of control observations in the dataset, and <i>N1</i>
    is the number of treatment observations.  If <b>tc(</b><i>att</i><b>)</b> is selected, <b>m</b> need
    only be less than or equal to <i>N0</i>; if <b>tc(</b><i>atc</i><b>)</b> is selected, <b>m</b> must be less
    than or equal to <i>N1</i>.  If <b>m(</b><i>#</i><b>)</b> is not specified, 1 is assumed.
<p>
<b>metric(</b><i>maha|matname</i><b>)</b> specifies the weighting matrix to be used when <i>k</i>, the
    number of elements of <i>varlist_nnmatch</i>, is greater than 1.  The <b>metric</b>
    option specifies the relative weight to be placed on each variable in
    <i>varlist_nnmatch</i> in defining nearest neighbor matches.  Two options are
    available:
<p>
    (1) <b>metric(</b><i>maha</i><b>)</b> specifies the Mahalanobis metric, the
        inverse of the sample variance/covariance matrix of the
        <i>k</i> variables in <i>varlist_nnmatch</i>.
    (2) <b>metric(</b><i>matname</i><b>)</b> allows for a user-defined weight matrix
        <i>matname</i>, where <i>matname</i> is an already-specified
        <i>k</i>-dimensional, symmetric and positive semi-definite
        matrix.
<p>
    If no option is specified, the default is to use the <i>k</i> x <i>k</i>
    diagonal matrix of the inverse sample standard errors of the
    <i>k</i> variables in <i>varlist_nnmatch</i>.
<p>
<b>exact(</b><i>varlist_ex</i><b>)</b> allows the user to specify exact matching (or as exact as
    possible) on one or more variables.  The exact-matching variables need not
    overlap with the elements of <i>varlist_nnmatch</i>.  In practice, however, the
    exact matching option adds these variables to the original <i>k</i> x <i>k</i>
    <i>varlist_nnmatch</i> matrix, but in the weight matrix multiplies each exact
    element by 1000 relative to the weights placed on the elements of
    <i>varlist_nnmatch</i>.  (Regardless of the <b>metric()</b> option chosen for the
    <i>varlist_nnmatch</i> variables, the exact match variables are normalized via the
    default option - the inverse sample errors.) Because for each matched
    observation there may not exist members of the opposite treatment group
    with equal values of the exact-matching variables, matching may not be
    exact across the full dataset.  The output lists the percentage of matches
    (across the paired observations, greater than or equal to <i>N</i>*<i>m</i> in number)
    that match exactly.
<p>
<b>biasadj(</b><i>bias</i> | <i>varlist_adj</i><b>)</b> The simple matching estimator estimates the average
    treatment effect by calculating the average, over the <i>N</i> observations being
    matched, of the difference between the <i>depvar</i> outcome for observation <i>i</i>,
    and the average outcomes for its <i>m</i> matches in the opposite treatment group.
    However, the simple matching estimator will be biased if matching is not
    exact.  This option regression-adjusts the results using either the
    original matching variable(s), <i>varlist_nnmatch</i> (if <b>baisadj(</b><i>bias</i><b>)</b> is
    selected), or a newly-specified set of variables, <i>varlist_adj</i>, (if
    <b>baisadj(</b><i>varlist_adj</i><b>)</b> is chosen).
<p>
<b>robust(</b><i>#_v</i><b>)</b> By default <b>nnmatch</b> assumes homoskedastic errors (a constant
    treatment effect).  However, the user can allow for heteroskedastic errors
    by selecting the <b>robust(</b><i>#_v</i><b>)</b> option.  The program does this by conducting a
    second matching process (again across the elements of <i>varlist_nnmatch</i>),
    this time matching observations in the same treatment group, to compare
    variability in outcomes (<i>depvar</i>) for observations with approximately the
    same <i>varlist_nnmatch</i> values.  <b>robust(</b><i>#_v</i><b>)</b> allows the user to choose how
    many matches are used in this process.  If <b>robust</b> is not selected, or <i>#_v</i>
    equals zero, homoskedastic errors are estimated.
<p>
<b>population</b> allows the user to specify the calculation of the population
    variance rather than the sample variance.  If <b>population</b> is not selected,
    sample variance is assumed.
<p>
<b>level(</b><i>#</i><b>)</b> specifies the confidence level, in percent, for confidence intervals.
    The default is <b>level(95)</b> or as set by <b>set level</b>.
<p>
<b>keep(</b><i>filename</i><b>) replace</b> In the estimation process, <b>nnmatch</b> creates a temporary
    dataset holding, for each observation <i>i</i> being matched, a new observation
    holding <i>i</i>'s outcome variable (<i>depvar</i>) and matching variable(s),
    <i>varlist_nnmatch</i>, values, and the outcome and <i>varlist_nnmatch</i> values for its
    <i>m</i> closest matches.  Thus, the new dataset will hold at least (but
    potentially more than) <i>N</i>*<i>m</i> observations.  If <b>biasadj(</b><i>varlist_adj</i><b>)</b> or
    <b>exact(</b><i>varlist_ex</i><b>)</b> are selected, the temporary dataset will also hold these
    values for each observation <i>i</i> and its match(es) <i>j</i>.  <b>keep(</b><i>filename</i><b>)</b> allows
    the user to save this temporary dataset.
<p>
    If <b>keep(</b><i>filename</i><b>)</b> is selected, each observation of <i>filename</i>.dta will hold
    the following variables:
<p>
      <i>t</i>:  The treatment group indicator, <i>treatvar</i>, for the
            observation being matched, <i>i</i>.
      <i>y</i>:  The observed outcome variable, <i>depvar</i>(<i>i</i>).
      <i>x</i>:  The <i>varlist_nnmatch</i> values for observation <i>i</i>.
      <i>id</i>: The identification code for the observation being
            matched, <i>i</i>.
            (When the command <b>nnmatch</b> is given, the program
            creates a temporary variable, <i>id</i> = {1,2,...N}, based
            on the original sort order.)
      <i>index</i>:  The identification code for <i>j</i>, the match for
            observation <i>i</i>.
      <i>dist</i>:  The estimated distance between observation <i>i</i> and
            its match <i>j</i>, based on the<i> varlist_nnmatch</i> values of
            each and the selected weight matrix.
      <i>k_m</i>: The number of times observation <i>i</i> is itself used as a
            match for any observation <i>l</i> of the opposite
            treatment group, each time weighted by the total
            number of matches for the given observation <i>l</i>.
            (For example, if observation <i>i</i> is one of three
            matches for observation <i>l</i>, it receives a value of
            1/3 for that match.  <i>k_m</i>(<i>i</i>) is the sum, across all
            observations <i>l</i>, of this value.  Thus the sum of <i>k_m</i>
            across all observations <i>i</i> will equal <i>N</i> (or <i>N0</i> or <i>N1</i>,
            if the <i>atc</i> or <i>att</i>, respectively, are estimated).
            Note that this value refers to <i>i</i>'s use as a match,
            not to its matches <i>j</i>, so the value of <i>k_m</i> is equal
            across all observations in the temporary dataset
            that pertain to the matching of observation <i>i</i>.
      <i>w_id</i>: Weight for observation <i>i</i>, if weights are selected.
      <i>w_index</i>: Weight of observation <i>j</i>, the match for
            observation <i>i</i>, if weights are selected.
      <i>`y'_0</i>:  The inferred <i>depvar</i> value if observation <i>i</i> were in
            the control group.
            (If observation <i>i</i> is in fact a control observation,
            `y'_0 = `y'(<i>i</i>).  If <i>i</i> is a treated observation,
            `y'_0 = `y'(<i>j</i>).)
      <i>`y'_1</i>: Inferred <i>depvar</i> value if <i>i</i> were in the treated
            group.
      <i>`x'_0m</i>: Values of <i>varlist_nnmatch</i> for <i>i</i>'s `control'
            observation.  Namely, if <i>i</i> is a control observation,
            <i>`x'_0m</i> = <i>x_i</i> for each element <i>x</i> of <i>varlist_nnmatch</i>.
            If <i>i</i> is a treatment observation, <i>`x'_0m</i> will equal
            <i>x_j</i>.
      <i>`x'_1m</i>: Values of <i>varlist_nnmatch</i> for <i>i</i>'s `treatment'
            observation.
      <i>`b'_0b</i>: Values of the bias-adjustment variables (if
            <b>biasadj(</b><i>varlist_adj</i><b>)</b> is selected) for <i>i</i>'s `control'
            observation, where <i>`b'</i> represents each element of
            the bias-adjustment variables.
      <i>`b'_1b</i>: Bias-adjustment variables for <i>i</i>'s `treatment'
            observation.
      <i>`e'_0e</i>: Values of the exact-matching variables (if
            <b>exact(</b><i>varlist_ex</i><b>)</b> is selected) for <i>i</i>'s `control'
            observation, where <i>`e'</i> represents each element of
            the exact-matching variables.
      <i>`e'_1e</i>: Exact-matching variables for <i>i</i>'s `treatment'
            observation.
<p>
<b>replace</b> If <b>keep(</b><i>filename</i><b>)</b> is selected, and <i>filename</i>.dta already exists, <b>replace</b>
    must be selected for <i>filename</i>.dta to be saved.
<p>
<p>
<b><u>Weights</u></b>
<p>
<b>nnmatch</b> allows users to define weights, used as <i>pweights</i>.  In particular, when
determining the <i>m</i> closest matches, if weights are selected, the program will
choose the closet observations, <i>j</i>, such that their summed weights are equal to
or just exceed <i>m</i>.  If robust standard errors are chosen, a similar approach
will be taken in choosing the closest matches in the variance calculation step.
<p>
<p>
<b><u>Examples: match</u></b>
<p>
nnmatch y t x1 x2
nnmatch y t x1, m(3)
nnmatch y t x1 x2, tc(att)
nnmatch y t x1 x2, tc(atc) met(maha) bias(bias) robust(4)
nnmatch y t x1 x2, met(<i>matname</i>) bias(x1 x3) keep(artdata) replace
nnmatch y t x1 x2 [w=w], met(<i>matname</i>) bias(x1 x3) exact(x4) pop
<p>
</pre>