<pre>
<b>help mata mm_bs()</b>
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
    <b>mm_bs() -- Bootstrap estimation</b>
<p>
<p>
<b><u>Syntax</u></b>
<p>
           <i>bs</i> = <b>mm_bs(</b><i>f</i><b>,</b> <i>X</i> [<b>,</b> <i>w</i><b>,</b> <i>reps</i><b>,</b> <i>d</i><b>,</b> <i>nodots</i><b>,</b> <i>strata</i><b>,</b> <i>cluster</i><b>,</b> <i>stat</i><b>,</b>
                  <i>...</i>]<b>)</b>
<p>
           <i>bs</i> = <b>mm_bs2(</b><i>f</i><b>,</b> <i>X</i> [<b>,</b> <i>w</i><b>,</b> <i>reps</i><b>,</b> <i>d</i><b>,</b> <i>nodots</i><b>,</b> <i>strata</i><b>,</b> <i>cluster</i><b>,</b> <i>stat</i><b>,</b>
                  <i>...</i>]<b>)</b>
<p>
    where
<p>
            <i>f</i>:  <i>pointer scalar</i> containing address of function to be
                  bootstrapped, i.e. <i>f</i> = <b>&amp;</b><i>functionname</i><b>()</b>
            <i>X</i>:  <i>real matrix</i> containing data (rows are observations, columns
                  variables)
            <i>w</i>:  <i>real colvector</i> containing weights
         <i>reps</i>:  <i>real scalar</i> specifying number of replications (default: 50)
            <i>d</i>:  <i>real scalar</i> specifying reduction of bootstrap sample size
                  (default: 0)
       <i>nodots</i>:  <i>real scalar</i> indicating that replication dots be suppressed
       <i>strata</i>:  <i>real colvector</i> containing (sorted) strata ID variable
      <i>cluster</i>:  <i>real colvector</i> containing (sorted) cluster ID variable
         <i>stat</i>:  <i>real matrix</i> containing the results of <i>f</i> using the original
                  data, i.e., the "observed" value of <i>f</i>
          <i>...</i>:  up to 10 optional arguments to pass through to <i>f</i>
<p>
<p>
    <i>real matrix</i> <b>mm_bs_report(</b><i>bs</i> [<b>,</b> <i>what</i>, <i>level</i><b>,</b> <i>mse</i><b>,</b> <i>jk</i>]<b>)</b>
<p>
    where
<p>
         <i>what</i>:  <i>string vector</i> containing statistics to be reported, where the
                  available statistics are: <b>"b"</b> or <b>"theta"</b> ("observed"
                  value), <b>"mean"</b> (bootstrap mean), <b>"bias"</b> (bootstrap mean -
                  observed value), <b>"v"</b> (variance-covariance matrix), <b>"se"</b>
                  (standard error; the default), <b>"ci"</b> or <b>"n"</b>
                  (normal-approximation confidence interval), <b>"basic"</b> (basic
                  confidence interval), <b>"p"</b> (percentile confidence interval),
                  <b>"bc"</b> (bias-corrected confidence interval), <b>"bca"</b>
                  (bias-corrected and accelerated confidence interval), <b>"t"</b>
                  (percentile-t confidence interval)
        <i>level</i>:  <i>real scalar</i> containing the confidence level for confidence
                  intervals (default is 95 or as set by <b>set level</b>)
          <i>mse</i>:  <i>real scalar</i> indicating that the mean squared errors formula
                  be used
           <i>jk</i>:  <i>struct mm_jkstats</i> containing results from <b>mm_jk()</b> (required
                  if <i>what</i> contains <b>"bca"</b>)
<p>
    <i>bs</i> is a variable used for communication between <b>mm_bs()</b> and
    <b>mm_bs_report()</b>. If you declare <i>bs</i>, declare it to be <i>transmorphic</i>.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>mm_bs(</b><i>f</i><b>,</b> <i>X</i><b>,</b> <i>w</i><b>)</b> applies function <i>f</i> to bootstrap samples of the data <i>X</i> (and
    weights <i>w</i>) and returns the results as a structure. To be precise, <i>f</i> is a
    pointer to a function, i.e. <i>f</i> = <b>&amp;</b><i>functionname</i><b>()</b>, e.g.  <i>f</i> = <b>&amp;mean()</b> (see
    <b>[M-2] ftof</b>).  <b>mm_bs()</b> expects function <i>f</i> to return a <i>real rowvector</i> of
    parameter estimates to be bootstrapped or, optionally, a <i>real matrix</i>
    containing parameter estimates in the first row and associated standard
    errors in the second row (the standard errors are required for
    percentile-t confidence intervals; see Remarks below). Furthermore,
    function <i>f</i> must take the data as the first argument and weights as the
    second argument.
<p>
    Note that the weights <i>w</i> are not relevant for the bootstrap resampling
    process. That is, <b>mm_bs()</b> always draws simple (i.e. equal probability)
    random samples (with replacement), no matter whether weights are
    specified or not. However, weights are passed through to the internal
    calls of function <i>f</i>. Omit <i>w</i>, or specify <i>w</i> as 1 to obtain unweighted
    results. <i>w</i>=1 is passed to function <i>f</i> if <i>w</i> is omitted.
<p>
    <i>reps</i> specifies the number of desired bootstrap replicates.  The default
    is 50, which is too low for most applications. The default sample size
    for the single bootstrap samples is the number of observations in the
    data (or number of clusters, if <i>cluster</i> is specified). However, <i>d</i>&gt;0
    causes the default bootstrap sample size to be reduced by <i>d</i> (within each
    stratum if <i>strata</i> is specified). For example, specify <i>d</i>=1 to produce
    bootstrap samples containing only N-1 observations. Specify, <i>d</i>=0 to not
    change the default sample size.
<p>
    <i>nodots</i>!=0 indicates that replication dots be suppressed.  By default, a
    single dot character is displayed for each successful replication and a
    single red 'x' is displayed for each unsuccessful replication. A
    replication is considered unsuccessful if the replication result contains
    one or more missing values. <b>mm_bs()</b> only returns results from successful
    replications.
<p>
    <i>strata</i> and <i>cluster</i> may be used to specify a strata ID variable and a
    cluster ID variable. <b>mm_bs()</b> will then draw stratified samples of
    clusters. Note that <b>mm_bs()</b> does not sort the data: A new stratum begins
    each time <i>strata</i> changes from one row to the next, a new cluster begins
    each time <i>cluster</i> (or <i>strata</i>) changes from one row to the next. Omit
    <i>strata</i> or specify <i>strata</i>=. if the sample is unstratified; omit <i>cluster</i> or
    specify <i>cluster</i>=. if the sample does not contain clusters.
<p>
    By default, <b>mm_bs()</b> first applies <i>f</i> to the original data to obtain the
    "observed" value of <i>f</i> given <i>X</i> and <i>w</i>. Alternatively, the "observed" value
    may be provided as <i>stat</i>, where <i>stat</i> is a<i> real matrix</i> containing point
    estimates in the first row and, optionally, associated standard errors in
    the second row. Omit <i>stat</i> or specify <i>stat</i>=. if you do not want to provide
    the "observed" value.
<p>
    <b>mm_bs2()</b> is an alternative version of <b>mm_bs()</b>. Instead of physically
    sampling the data, <b>mm_bs2()</b> implements bootstrap estimation by
    multiplying <i>w</i> by the number of times an observation belongs to the
    bootstrap sample. <b>mm_bs2()</b> requires less memory than <b>mm_bs()</b> but it is
    slower and cannot be used in all situations (i.e. only if, for the
    statistic in question, multiplying <i>w</i> is a correct way to represent
    multiple drawn observations).
<p>
    The results produced by <b>mm_bs()</b> and <b>mm_bs2()</b> depend on the the initial
    value of random-number seed. Use <b>set seed</b> or <b>uniformseed()</b> to set the
    seed.
<p>
    <b>mm_bs_report()</b> is used to analyze the bootstrap replications computed by
    <b>mm_bs()</b> or <b>mm_bs2()</b>. It returns a matrix of statistics such as bootstrap
    means, bootstrap standard errors, or various versions of bootstrap
    confidence intervals (see the <i>what</i> argument above).  Multiple statistics
    are arranged beneath one another in the specified order. For example,
    <b>mm_bs_report(</b><i>bs</i><b>, ("b","se","ci"))</b> will return the observed values in the
    first row, the standard errors in the second row, and the lower and upper
    bounds of the normal-approximation confidence intervals in the third and
    forth row.
<p>
    <i>level</i> specifies the confidence level, as a percentage, for confidence
    intervals.  The default is <i>level</i>=95 or as set by <b>set level</b>.
<p>
    <i>mse</i>!=0 indicates that variances and standard errors be computed using
    deviations of the replicates from the "observed" value. By default,
    variances and standard errors are computed using deviations from the
    average of the replicates.
<p>
    <i>jk</i> provides jackknife statistics as returned by <b>mm_jk()</b>. <i>jk</i> is required
    for bias-corrected and accelerated confidence intervals (<b>"bca"</b>). Omit <i>jk</i>
    or specify <i>jk</i>=. if no bias-corrected and accelerated confidence intervals
    are computed.
<p>
<p>
<b><u>Remarks</u></b>
<p>
    Remarks are presented under the headings
<p>
        <i>Introduction</i>
        <i>BCa confidence intervals</i>
        <i>Percentile-t confidence intervals</i>
        <i>Methods and formulas</i>
<p>
<p>
<a name="r1"></a>    <i><u>Introduction</u></i>
<p>
    The following example illustrates the basic usage of <b>mm_bs()</b> and
    <b>mm_bs_report()</b>:
<p>
        : x = uniform(75,2)
        
        : B = mm_bs(&amp;mean(), x, 1, 200)
        
        Bootstrap replications (200)
        ----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5
        ..................................................    50
        ..................................................   100
        ..................................................   150
        ..................................................   200
<p>
        : mm_bs_report(B, ("b", "se"))
                         1             2
            +-----------------------------+
          1 |  .5059552237   .4677170853  |
          2 |  .0307029664   .0333863864  |
            +-----------------------------+
<p>
        : mm_bs_report(B, "ci")
                         1             2
            +-----------------------------+
          1 |  .4454103082   .4018805821  |
          2 |  .5665001392   .5335535885  |
            +-----------------------------+
<p>
    <b>mm_bs()</b> first produces 200 bootstrap replicates of the means of the two
    variables contained in <b>x</b>. <b>mm_bs_report()</b> then reports the "observed"
    values, i.e. the means of the two variables in <b>x</b> (first row) and the
    bootstrap standard errors of the means (second row). The second call of
    <b>mm_bs_report()</b> displays the 95% normal-approximation confidence intervals
    for the two means (lower bound in first row, upper bound in second row).
<p>
<p>
<a name="r2"></a>    <i><u>BCa confidence intervals</u></i>
<p>
    Bias-corrected and accelerated confidence intervals require the user to
    provide jackknife replicates of the parameter estimates. Use the <b>mm_jk()</b>
    function to compute these statistics. Example:
<p>
        : J = mm_jk(&amp;mean(), x, 1)
        
        Jackknife replications (75)
        ----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5
        ..................................................    50
        .........................
<p>
        : mm_bs_report(B, "bca", 95, 0, J)
                         1             2
            +-----------------------------+
          1 |  .4468480011   .4088091557  |
          2 |  .5566050638   .5391249383  |
            +-----------------------------+
<p>
<p>
<a name="r3"></a>    <i><u>Percentile-t confidence intervals</u></i>
<p>
    The formula for the (1-alpha) percentile-t confidence interval is
<p>
        [ b - t(1-alpha/2) * se, b - t(alpha/2) * se ]
<p>
    where b is the original parameter estimate, se is an estimate of the
    standard error of b and t(<i>p</i>) is the <i>p</i>-quantile of the asymptotically
    pivotal statistic
<p>
        t_i = (b_i - b)/se_i,  i = 1, ..., B
<p>
    where the i indicates the bootstrap replicates.
<p>
    To enable the computation of percentile-t confidence intervals, function
    <i>f</i> provided to <b>mm_bs()</b> must return standard error estimates along with the
    point estimates of the parameters (point estimates in the first row,
    standard errors in the second row). The following example illustrates the
    procedure using the textbook formula for the standard error of the mean:
<p>
        : real matrix meanse(x, w)
        &gt; {
        &gt;         if (w!=1) _error(3498, "w must be 1")
        &gt;         return(mean(x, 1) \
        &gt;          sqrt(diagonal(variance(x, 1))'/rows(x)))
        &gt; }
<p>
        : meanse(x,1)
                         1             2
            +-----------------------------+
          1 |  .5059552237   .4677170853  |
          2 |  .0326460175   .0347510918  |
            +-----------------------------+
<p>
        : B = mm_bs(&amp;meanse(), x, 1, 200)
        
        Bootstrap replications (200)
        ----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5
        ..................................................    50
        ..................................................   100
        ..................................................   150
        ..................................................   200
<p>
        : mm_bs_report(B, "t")
                         1             2
            +-----------------------------+
          1 |  .4442775319    .406048357  |
          2 |  .5645887108    .537843043  |
            +-----------------------------+
<p>
    An alternative approach may be to compute the standard errors by the
    bootstrap, i.e. to perform bootstrap-within-bootstrap or nested
    bootstrap. Example:
<p>
        : real matrix meanbsse(x, w)
        &gt; {
        &gt;         if (w!=1) _error(3498, "w must be 1")
        &gt;         return(mean(x, 1) \
        &gt;          mm_bs_report(mm_bs(x,1,&amp;mean(),50,0,1),"se"))
        &gt; }
<p>
        : meanbsse(x,1)
                         1             2
            +-----------------------------+
          1 |  .5059552237   .4677170853  |
          2 |  .0294400659   .0297055941  |
            +-----------------------------+
<p>
        : B = mm_bs(&amp;meanbsse(), x, 1, 200)
        
        Bootstrap replications (200)
        ----+--- 1 ---+--- 2 ---+--- 3 ---+--- 4 ---+--- 5
        ..................................................    50
        ..................................................   100
        ..................................................   150
        ..................................................   200
<p>
        : mm_bs_report(B, "t")
                         1             2
            +-----------------------------+
          1 |   .438978656   .4096034266  |
          2 |  .5833692536    .552163646  |
            +-----------------------------+
<p>
<p>
<a name="r4"></a>    <i><u>Methods and formulas</u></i>
<p>
    The formulas for the percentile-t confidence intervals can be found
    above. Also see, e.g., Poi (2004).
<p>
    The basic confidence interval is defined as
<p>
        [ 2*b - q(1-alpha/2), 2*b - q(alpha/2) ]
<p>
    where b is the original parameter estimate and q(<i>p</i>) is the <i>p</i>-quantile of
    the bootstrap distribution of b (see, e.g., Davison and Hinkley 1997).
<p>
    For all other formulas see <b>[R] bootstrap</b>. Note that, other than indicated
    in <b>[R] bootstrap</b>, 1/k is used instead of 1/(k-1) in the mean squared
    errors formula (the same is true for official Stata's <b>bootstrap</b>).
<p>
<p>
<b><u>Conformability</u></b>
<p>
    <b>mm_bs(</b><i>f</i><b>,</b> <i>X</i><b>,</b> <i>w</i><b>,</b> <i>reps</i><b>,</b> <i>d</i><b>,</b> <i>nodots</i><b>,</b> <i>strata</i><b>,</b> <i>cluster</i><b>,</b> <i>stat</i><b>,</b> <i>...</i><b>)</b>,
    <b>mm_bs2(</b><i>f</i><b>,</b> <i>X</i><b>,</b> <i>w</i><b>,</b> <i>reps</i><b>,</b> <i>d</i><b>,</b> <i>nodots</i><b>,</b> <i>strata</i><b>,</b> <i>cluster</i><b>,</b> <i>stat</i><b>,</b> <i>...</i><b>)</b>:
           <i>f</i>:  1 <i>x</i> 1
           <i>X</i>:  <i>n x k</i>
           <i>w</i>:  <i>n x</i> 1 or 1 <i>x</i> 1
        <i>reps</i>:  1 <i>x</i> 1
           <i>d</i>:  1 <i>x</i> 1
      <i>nodots</i>:  1 <i>x</i> 1
      <i>strata</i>:  <i>n x</i> 1 or <i>strata</i>=.
     <i>cluster</i>:  <i>n x</i> 1 or <i>cluster</i>=.
        <i>stat</i>:  <i>m x p</i>, m&gt;0, or <i>stat</i>=.
         <i>...</i>:  (depending on <i>f</i>)
      <i>result</i>:  <i>struct mm_bsstats</i>
<p>
    <b>(*</b><i>f</i><b>)(</b><i>X</i><b>,</b> <i>w</i><b>,</b> <i>...</i><b>)</b>:
           <i>X</i>:  <i>n x k</i>
           <i>w</i>:  <i>n x</i> 1 or 1 <i>x</i> 1
         <i>...</i>:  (depending on <i>f</i>)
      <i>result</i>:  <i>m x p</i>, m&gt;0
<p>
    <b>mm_bs_report(</b><i>bs</i><b>,</b> <i>what</i><b>,</b> <i>level</i><b>,</b> <i>mse</i>, <i>jk</i><b>)</b>:
          <i>bs</i>:  <i>struct mm_bsstats</i>
        <i>what</i>:  <i>s x</i> 1 or 1 <i>x s</i>
       <i>level</i>:  1 <i>x</i> 1
         <i>mse</i>:  1 <i>x</i> 1
          <i>jk</i>:  <i>struct mm_jkstats</i> or <i>jk</i>=.
      <i>result</i>:  <i>r x p</i>
<p>
<p>
<b><u>Diagnostics</u></b>
<p>
    <b>mm_bs()</b> and <b>mm_bs2()</b> cannot be used with built-in functions (use
    wrappers).
<p>
    <b>mm_bs_report()</b> will abort with error if <i>what</i> contains <b>"bca"</b> and no
    jackknife estimates are provided.
<p>
    <b>mm_bs_report()</b> with <i>what</i> containing <b>"t"</b> will abort with error if applied
    to bootstrap replicates that do not contain information on standard
    errors.
<p>
<p>
<b><u>Source code</u></b>
<p>
    mm_bs.mata
<p>
<p>
<b><u>References</u></b>
<p>
    Davison, A.C., Hinkley, D.V. (1997). Bootstrap Methods and Their
        Application. Cambridge University Press.
<p>
    Poi, B.P. (2004). From the help desk: Some bootstrapping techniques.
        Stata Journal 4(3):312-328.
<p>
<p>
<b><u>Author</u></b>
<p>
    Ben Jann, ETH Zurich, jann@soz.gess.ethz.ch
<p>
<p>
<b><u>Also see</u></b>
<p>
    Online:  help for <b>bootstrap</b>, <b>mm_jk()</b>, <b>moremata</b>
</pre>