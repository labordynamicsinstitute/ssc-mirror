<pre>
<b>help mfpigen</b>                                                    Patrick Royston
-------------------------------------------------------------------------------
<p>
<p>
<b><u>Title</u></b>
<p>
    <b>mfpigen</b> -- Modelling interactions between pairs of covariates
<p>
<p>
<b><u>Syntax</u></b>
<p>
        <b>mfpigen</b> [, <i>options</i>] <b>:</b>  <i>regression_cmd</i> [<i>yvar</i>] <i>mainvarlist</i> [<i>if</i>] [<i>in</i>] [
            <i>weight</i>] [<b>,</b> <i>regression_cmd_options</i>]
<p>
<p>
<a name="syntax"></a>    where
<p>
    <i>regression_cmd</i> may be <b>clogit</b>, <b>cnreg</b>, <b>glm</b>, <b>intreg</b>, <b>logistic</b>, <b>logit</b>, 
        <b>mlogit</b>, <b>nbreg</b>, <b>ologit</b>, <b>oprobit</b>, <b>poisson</b>, <b>probit</b>, <b>qreg</b>, <b>regress</b>, <b>rreg</b>,
        <b>stcox</b>, <b>stpm2</b> (if installed), <b>streg</b>, <b>xtgee</b>.
<p>
<p>
<a name="mfpigen_options"></a>    <i>options</i>                   Description
    -------------------------------------------------------------------------
    <b><u>ag</u></b><b>ainst(</b><i>against_var</i><b>)</b>      variable to plot interaction function against
    <b><u>al</u></b><b>pha(</b><i>alpha_list</i><b>)</b>         significance level(s) for selecting FP
                                functions of continuous predictors
    <b>df(</b><i>df_list</i><b>)</b>               degrees of freedom for FP functions of
                                continuous predictors
    <b><u>for</u></b><b>ward(</b><i>#</i><b>)</b>                forward selection of interaction(s) (linear
                                terms only)
    <b><u>fpl</u></b><b>ot(</b>[<b>%</b>]<i>list</i><b>)</b>            define plotting values for an interaction
    <b><u>lin</u></b><b>adj(</b><i>xvarlist_lin</i><b>)</b>      adjust for linear effects of variables in
                                <i>xvarlist_lin</i>
    <b><u>int</u></b><b>eractions(</b><i>intlist</i><b>)</b>     adjust for predefined interactions
    <b><u>mfpa</u></b><b>dj(</b><i>xvarlist_mfp</i><b>)</b>      adjust for effects of variables in
                                <i>xvarlist_mfp</i>, as selected by <b>mfp</b>
    <b>nomfp</b>                     prevent MFP being applied to variables in
                                <i>mainvarlist</i>
    <b><u>nover</u></b><b>bose</b>                 suppresses the display of interaction results
    <b><u>out</u></b><b>come(</b><i>outcome</i><b>)</b>          outcome for prediction (<i>regression_cmd</i> = <b>mlogit</b>
                                only)
    <b><u>plot</u></b><b>opts(</b><i>plot_options</i><b>)</b>    options for <b>graph twoway</b>
    <b><u>pv</u></b><b>alue(</b><i>#</i><b>)</b>                 P-value for screening interactions
    <b><u>sel</u></b><b>ect(</b><i>select_list</i><b>)</b>       significance level for selecting variables
    <b>se</b>                        standard error of predicted functions (see
                                <b>fplot()</b>)
    <i>mfp_options</i>               options for <b>mfp</b>, excluding <b>select()</b>, <b>alpha()</b>,
                                <b>df()</b> (which are described separately, see
                                above)
    <i>regression_cmd_options</i>    options for <i>regression_cmd</i>
    -------------------------------------------------------------------------
<p>
    All weight types supported by <i>regression_cmd</i> are allowed; see weight.
<p>
    <i>yvar</i> is not allowed for <b>streg</b>, <b>stcox</b> and <b>stpm2</b>; for these commands, you
        must first <b>stset</b> your data.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>mfpigen</b> is designed to investigate interactions between each pair of
    covariates in <i>mainvarlist</i>. Typically these are continuous covariates, but
    linear effects of binary or categorical covariates are allowed. Factor
    variables are supported. Fractional polynomials are used to model the
    main effects of continuous variables. The statistical significance of
    each interaction between pairs of selected FP (or linear) functions is
    reported.
<p>
    For each pair of variables in <i>mainvarlist</i>, <b>mfpigen</b> applies mfp to the
    remaining variables in <i>mainvarlist</i> and also to variables defined by
    <b>mfpadj(</b><i>xvarlist_mfp</i><b>)</b> to select a `confounder model' which is used to
    adjust an interaction model for possible confounding by other covariates.
    Variables defined by <b>linadj(</b><i>xvarlist_lin</i><b>)</b> are included as linear in the
    confounder part of the model, and are included in every model.  Variables
    in <i>mainvarlist</i> and <i>xvarlist_mfp</i> are subject to FP transformation if
    required, as determined by <b>mfp</b>, whereas those in <i>xvarlist_lin</i> are
    modelled as linear. The best-fitting FP functions of each pair of
    variables modelled with an interaction and of variables in the confounder
    model, including the adjustment variables, are selected simultaneously in
    single runs of <b>mfp</b>.
<p>
<p>
<b><u>Options</u></b>
<p>
    <b>against(</b><i>against_var</i><b>)</b> defines the variable against which interaction
        function(s) are to be plotted. See <b>fplot()</b> for more details.
<p>
    <b>alpha(</b><i>alpha_list</i><b>)</b> sets the significance levels for testing between FP
        models of different degrees. The rules for <i>alpha_list</i> are the same as
        for <i>df_list</i> in the <b>df()</b> option.  The default nominal p-value
        (significance level, selection level) is 0.05 for all variables.
<p>
    <b>df(</b><i>df_list</i><b>)</b> sets the df for each predictor in <i>mainvarlist</i> and (if the
        <b>mfpadj()</b> option is used) in <i>xvarlist_mfp</i>.  See <b>df()</b> for further
        details. Models with all terms linear are specified as <b>df(1)</b>.
<p>
    <b>forward(</b><i>#</i><b>)</b> performs forward selection of interaction(s) at significance
        level <i>#</i>. This option applies only to models with all terms linear,
        therefore use of the <b>forward()</b> option implies <b>df(1)</b>. The procedure
        searches for the most significant interaction. If it is is
        significant at the <i>#</i> level, the interaction is reported and the
        procedure continues to search for anothher interaction. The process
        stops when no further significant interactions are found.
<p>
    <b>fplot(</b>[<b>%</b>]<i>list</i><b>)</b> plots the interaction between the last pair of items in
        <i>mainvarlist</i>, say, <i>item1</i> and <i>item2</i>.  Typically, both items are
        continuous variables. <i>list</i> is a set of values of <i>item1</i>. The fitted
        function of <i>item2</i> is evaluated at each value in <i>list</i> and plotted
        against <i>item2</i>.  The functions are adjusted for other variables in the
        selected model, if any. Examples:
<p>
        <b>. mfpigen, fplot(30 40 50 60) : regress y age bmi</b>
        <b>. mfpigen, select(0.05) fplot(30 40 50 60) : regress y sex chol age</b>
            <b>bmi</b>
<p>
        If <i>list</i> is preceded by a percent sign (<b>%</b>) then its values are
        interpreted as centiles of the distribution of <i>item1</i>. If <i>list</i> is only
        a percent sign, default centiles of 25, 50 and 75 are used. Examples:
<p>
        <b>. mfpigen, fplot(%10 50 90) : regress y age bmi</b>
        <b>. mfpigen, select(0.05) fplot(%) : regress y sex chol age bmi</b>
<p>
        A second possibility is for <i>item1</i> to be a factor variable. Then <i>list</i>
        consists of factor levels of <i>item1</i>, and <b>fplot(%)</b> means plot at all
        available levels. Example:
<p>
        <b>. mfpigen, fplot(1 2 3) : stcox i.grade age</b>
<p>
        A third possibility is for <i>item1</i> to be of the form <b>(</b><i>varlist</i><b>)</b>, i.e. a
        list of variables enclosed in parentheses.  <i>varlist</i> could comprise
        any combination of binary, categorical or continuous variables. <i>list</i>
        defines values of each variable in <i>varlist</i> at which the function of
        <i>item2</i> is to be plotted. For example,<b> fplot(0 0 0 1 1 0 1 1)</b> might
        define the four possible combinations of two binary variables, each
        of which takes the value 0 or 1. This would plot four fitted curves
        against <i>item2</i>, one for each combination of the two binary variables.
        Example:
<p>
        <b>. mfpigen, fplot(0 0 0 1 1 0 1 1): regress y (sex treat) age</b>
<p>
        An abbreviated syntax is available. If the pairs of values in <i>list</i>
        are enclosed within parentheses, all combinations of the values are
        generated. For example,<b> fplot(0 0 0 1 1 0 1 1)</b> could be abbreviated
        as<b> fplot((0 1)(0 1))</b>. All combinations of three such binary variables
        could be specified as<b> fplot((0 1)(0 1)(0 1))</b>, much easier than
        spelling out the required 2 ^ 3 = 8 pairs = 16 values. Examples:
<p>
        <b>. mfpigen, fplot((0 1)(0 1)(0 1)): regress y (sex treat group) age</b>
        <b>. mfpigen, fplot((25 50)(10 100)): regress y (age pgr) bmi</b>
<p>
        Items within parentheses do not have to be 0 and 1; for example, they
        could be values of a continuous variable. However, there must be
        exactly two values within each pair of parentheses. More general
        combinations of values should be spelled out explicitly using the
        standard syntax.
<p>
        <i>item2</i> could consist of a single variable, as already discussed, or
        take the form <b>(</b><i>varlist</i><b>)</b>. <i>varlist</i> might be an FP transformation
        created outside <b>mfpigen</b>. For example, to plot an interaction between
        sex and an FP2 function of age with powers (-2, 2) centered on age
        50, we could code:
<p>
        <b>. fracgen age -2 2, center(50)</b>
        <b>. mfpigen, fplot(0 1) adjust(no) against(age): regress y sex (age_1</b>
            <b>age_2)</b>
<p>
        <b>fracgen</b> creates FP-transformed variables called <b>age_1</b> and <b>age_2</b>,
        centered on age 50, that is, such that the mean of each of <b>age_1</b> and
        <b>age_2</b> is zero. The <b>adjust(no)</b> option of <b>mfpigen</b> prevents <b>mfp</b> from
        re-centering the already-centered variables <b>age_1</b> and <b>age_2</b>. <b>mfpigen</b>
        computes the interaction between <b>sex</b> and both of <b>age_1</b> and <b>age_2</b>. The
        example assumes that <b>sex</b> is coded as 0 and 1, but this coding is not
        mandatory. Note the use of the option <b>against(age)</b>. Without this
        option, the plots would be against the first member of <i>varlist</i>, in
        this case, <b>age_1</b>. We would be unlikely to want this.
<p>
        As well as being plotted, the fitted functions are saved under the
        names <b>_fit1</b>, <b>_fit2</b>, ... .
<p>
    <b>interactions(</b><i>intlist</i><b>)</b> adjusts all investigated models for predefined
        interactions specified by <i>intlist</i>. The syntax of <i>intlist</i> is <i>var11</i>
        <i>var12</i> [<b>,</b> <i>var21</i> <i>var22</i> ...]. Each pair of variables is translated to
        model terms of the form <b>c.</b><i>var11</i><b>##c.</b><i>var12</i> if <i>var11</i> and <i>var12</i> are both
        continuous. If either of the variables is an FP transformation with
        more than one term, the terms are included in parentheses, for
        example to include an interaction between an FP2 function of age and
        binary sex, we would specify interactions((age_1 age_2) i.sex), where
        <b>age_1 age_2</b> are the FP2 transformed terms for age. The interaction
        terms are included as linear terms in all interaction models
        investigated.
<p>
        Note that continuous variables should be entered as they are and
        categorical predictors preceded by <b>i.</b>, for example,
        <b>interactions((age_1 age_2) i.race)</b>.
<p>
    <b>linadj(</b><i>xvarlist_lin</i><b>)</b> includes <i>xvarlist_lin</i> as confounder variables in all
        the fitted models. They are always modelled as linear and are not
        subject to selection. <i>xvarlist_lin</i> may include factor variables.
<p>
    <b>mfpadj(</b><i>xvarlist_mfp</i><b>)</b> includes <i>xvarlist_mfp</i> as confounder variables in all
        the fitted models. Members of <i>xvarlist_mfp</i> are subject to selection
        and to determination of FP functional form by <b>mfp</b>, according to the
        options used for model selection (see the <b>alpha()</b>, <b>df()</b> and <b>select()</b>
        options).  <i>xvarlist_mfp</i> may include factor variables.
<p>
    <b>nomfp</b> prevents MFP being applied to variables in <i>mainvarlist</i>, and
        prevents them being candidates for an adjustment model. The default
        is to select these variables using <b>mfp</b>, if necessary with FP
        transformation.
<p>
    <b>noverbose</b> suppresses the display of interaction results. This is useful
        when you are building up a model including multiple interactions and
        you wish to see which interaction has the lowest P-value.
<p>
    <b>outcome(</b><i>outcome</i><b>)</b> specifies the outcome in <b>mlogit</b> models for which the
        linear predictor is to be calculated. For details of the syntax, see
        the description of <b>outcome()</b> in <b>mlogit postestimation</b>.
<p>
    <b>plotopts(</b><i>plot_options</i><b>)</b> are options for the graph of fitted function to be
        used by <b>graph twoway</b>.
<p>
    <b>pvalue(</b><i>#</i><b>)</b> defines the P-value to be used for screening interactions.
        Interactions that are not significant at the <i>#</i> level are not
        displayed, thus reducing clutter in the output. Default <i>#</i> is 1,
        meaning results for all interactions are displayed. Note that the
        <b>pvalue()</b> option has no effect on estimation, it is merely for
        convenience when inspecting many interactions for "interesting" ones.
<p>
    <b>se</b> requests standard errors of the fitted functions provided by the
        <b>fplot()</b> options. These are saved under the names <b>_sefit1</b>, <b>_sefit2</b>,
        ... .
<p>
    <b>select(</b><i>select_list</i><b>)</b> sets the nominal p-values (significance levels) for
        variable selection by backward elimination.  A variable is dropped if
        its removal causes a non-significant increase in deviance.  The rules
        for <i>select_list</i> are the same as those for <i>df_list</i> in the <b>df()</b> option.
        Using the default selection level of 1 for all variables forces them
        all into the model.  Setting the nominal p-value to be 1 for a given
        variable forces it into the model, leaving others to be selected or
        not. The nominal p-value for elements of <i>mainvarlist</i> or <i>xvarlist_mfp</i>
        bound by parentheses is specified by including <b>(</b><i>xvarlist</i><b>)</b> or
        <b>(</b><i>xvarlist_mfp</i><b>)</b> in <i>select_list</i>. Note that variables in <i>xvarlist_lin</i>
        may not be included in <i>select_list</i>.
<p>
    <b>showmfp</b> displays each <b>mfp</b> command that is run by <b>mfpigen</b>, and its
        results. This is to enable you to check that the commands are correct
        and as expected.
<p>
    <i>regression_cmd_options</i> are any options for <i>regression_cmd</i>.
<p>
    <i>mfp_options</i> are any options for <b>mfp</b>, excluding <b>alpha()</b>, <b>df()</b> and
        <b>select()</b>.
<p>
<p>
<b><u>Methodology</u></b>
<p>
    The algorithm provided in <b>mfpigen</b> can be summarized as follows.  Suppose
    we have continuous variables z1 and z2 and potential confounders x:
<p>
    1. Apply MFP to z1, z2 and x with significance level a* for selecting
        members of x and FP functions of continuous variables. Force z1 and
        z2 into the model and apply the FP function selection procedure to
        them. This step requires a single run of MFP.
<p>
    2. Calculate multiplicative interaction terms between the FP
        transformations selected for z1 and z2, or between untransformed z1
        and z2 if no FP transformation is needed. For example, if both
        variables need FP2 transformation, four interaction terms are
        created.
<p>
    3. Refit the model selected on x, z1, z2 with the interaction terms
        included.  Test the latter in the usual way using a likelihood ratio
        test. If k interaction terms are added to the model, the interaction
        chisquare test has k d.f. For example, if FP2 functions were selected
        for both z1 and z2 then k = 2 × 2 = 4.
<p>
    4. Consider all pairs of predictors for possible interaction,
        irrespective of the statistical significance of their main effects in
        the MFP model. If z1 and/or z2 is binary or forced to be linear, the
        procedure simplifies to the usual situation. If z1 and/or z2 are
        categorical, joint tests on all dummy variables are performed. An
        option is to treat the dummy variables as separate predictors.
<p>
    5. Check all interactions for artefacts and ignore any that fail the
        check. See section 7.4.2 of Royston &amp; Sauerbrei (2008) for further
        details.
<p>
    6. If more than one interaction is detected, apply a forward stepwise
        procedure to extend the main-effects model.
<p>
    There is one main difference between this algorithm, MFPIgen, and MFPI
    (Royston &amp; Sauerbrei 2004, 2009). In MFPI, the confounder model x is
    selected independently of z1 and z2, whereas in MFPIgen, a joint model is
    selected. The reason for the difference is that MFPI is principally
    intended for use with data from a randomized trial in which the effect of
    the treatment covariate z1 is by design independent of other covariate
    effects. Therefore, adjustment by x is less important. In observational
    studies, however, it may be necessary fully to adjust the effects of z1
    and z2 for confounders before investigating their interaction.
<p>
    Since MFPIgen addresses dozens of potential interactions, multiple
    testing is an issue. Results must be checked in detail and interpreted
    cautiously as hypothesis-generating only.
<p>
<p>
<b><u>Examples</u></b>
<p>
    <b>. mfpigen, alpha(0.2): logit y x1 x2 x3 x4 x5</b>
<p>
    <b>. mfpigen: stcox x1 x2 x3 x4 x5, stratify(group)</b>
<p>
    <b>. mfpigen, select(0.05) dfdefault(2) linadj(x1 x4 x5) mfpadj(x6 x7)</b>
        <b>fplot(%33 67) se: logit y x2 x3</b>
<p>
    <b>. mfpigen, select(0.05) fplot(0 1) dfdefault(2) alpha(1): regress mpg</b>
        <b>price headroom trunk weight length turn displacement foreign</b>
        <b>gear_ratio</b>
<p>
<p>
<b><u>Author</u></b>
<p>
    Patrick Royston
    MRC Clinical Trials Unit
    London, UK
    pr@ctu.mrc.ac.uk
<p>
<p>
<b><u>References</u></b>
<p>
    Royston, P., and W. Sauerbrei. 2008. Multivariable model-building. A
        pragmatic approach based on fractional polynomials for modelling
        continuous variables, pp. 172-181. Chichester, John Wiley and Sons.
<p>
<p>
<b><u>Also see</u></b>
<p>
    Manual:  <b>[R] fracpoly</b>, <b>[R] mfp</b>
<p>
    Online:  <b>mfp</b>, <b>fracpoly</b>, <b>mfpi</b> (if installed)
</pre>