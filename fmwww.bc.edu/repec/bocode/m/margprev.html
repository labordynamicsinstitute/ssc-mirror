<pre>
-------------------------------------------------------------------------------
help for <b>margprev</b>                                                (Roger Newson)
-------------------------------------------------------------------------------
<p>
<b><u>Marginal prevalences from binary regression models</u></b>
<p>
        <b>margprev</b> [<i>if</i>] [<i>in</i>] [<i>weight</i>] , [ <b><u>at</u></b><b>spec(</b><i>atspec</i><b>)</b> <b>subpop(</b><i>subspec</i><b>)</b>
                     <b><u>pr</u></b><b>edict(</b><i>pred_opt</i><b>)</b> <b>vce(</b><i>vcespec</i><b>)</b> <b>no</b><b><u>e</u></b><b>sample</b> <b>force</b>
                     <b><u>iter</u></b><b>ate(</b><i>#</i><b>)</b> <b><u>ef</u></b><b>orm</b> <b><u>l</u></b><b>evel(</b><i>#</i><b>)</b> <b>post</b> ]
<p>
    where <i>atspec</i> is an at-specification recognized by the <b>at()</b> option of 
    <b>margins</b>, <i>subspec</i> is a subpopulation specification of the form recognized
    by the <b>subpop()</b> option of <b>margins</b>, and <i>vcespec</i> is a variance-covariance
    specification of the form recognized by <b>margins</b>, and must have one of the
    values
<p>
    <b>delta</b> | <b>unconditional</b>
<p>
    <b>fweight</b>s, <b>aweight</b>s, <b>iweight</b>s, <b>pweight</b>s are allowed; see weight.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>margprev</b> calculates confidence intervals for marginal prevalences, also
    known as scenario proportions.  <b>margprev</b> can be used after an estimation
    command whose predicted values are interpreted as conditional
    proportions, such as <b>logit</b>, <b>logistic</b>, <b>probit</b>, or <b>glm</b>.  It estimates a
    marginal prevalence for a scenario ("Scenario 1"), in which one or more
    predictor variables may be assumed to be set to particular values, and
    any other predictor variables in the model are assumed to remain the
    same.
<p>
<p>
<b><u>Options for </u></b><b><u>margprev</u></b>
<p>
    <b>atspec(</b><i>atspec</i><b>)</b> is an at-specification, allowed as a value of the <b>at()</b>
        option of <b>margins</b>.  This at-specification must specify a single
        scenario ("Scenario 1"), defined as a fantasy world in which a subset
        of the predictor variables in the model are set to specified values.
        <b>margprev</b> uses the <b>margins</b> command to estimate the proportion of
        outcome values positive under Scenario 1, and then uses <b>nlcom</b> to
        estimate the logit of this scenario proportion, known as the marginal
        prevalence.  If <b>atspec()</b> is not specified, then its default value is
        <b>atspec((asobserved) _all)</b>, implying that Scenario 1 is the real-life
        baseline scenario, represented by the predictor values actually
        present.
<p>
    <b>subpop(</b><i>subspec</i><b>)</b>, <b>predict(</b><i>pred_opt</i><b>)</b> and <b>vce(</b><i>vcespec</i><b>)</b> have the same form
        and function as the options of the same names for <b>margins</b>.  They
        specify the subpopulation, the predict option(s), and the
        variance-covariance matrix formula, respectively, used to estimate
        the logit of the marginal prevalence.
<p>
    <b>noesample</b> has the same function as the option of the same name for 
        <b>margins</b>.  It specifies that computations will not be restricted to
        the estimation sample used by the previous estimation command.
<p>
    <b>force</b> has the same function as the option of the same name for <b>margins</b>.
<p>
    <b>iterate(</b><i>#</i><b>)</b> has the same form and function as the option of the same name
        for <b>nlcom</b>.  It specifies the number of iterations used by <b>nlcom</b> to
        find the optimal step size to calculate the numerical derivative of
        the logit of the marginal prevalence, with respect to the original
        marginal prevalence calculated by <b>margins</b>.
<p>
    <b>eform</b> specifies that <b>margprev</b> will display an estimate, <i>P</i>-value and
        confidence limits for the marginal odds, instead of for the log
        marginal odds (the logit of the marginal prevalence).  If <b>eform</b> is
        not specified, then a confidence interval for the log marginal odds
        is displayed.  In either case, <b>margprev</b> also displays an asymmetric
        confidence interval for the untransformed marginal prevalence.
<p>
    <b>level(</b><i>#</i><b>)</b> specifies the percentage confidence level to be used in
        calculating the confidence interval.  If it is not specified, then it
        is taken from the current value of the c-class value <b>c(level)</b>, which
        is usually 95.
<p>
    <b>post</b> specifies that <b>margprev</b> will post in <b>e()</b> the estimation results for
        estimating the logit of the marginal prevalence.  If <b>post</b> is not
        specified, then any existing estimation results are left in <b>e()</b>.
        Note that the estimation results posted are for the logit of the
        marginal prevalence, and not for the marginal prevalence itself.
        This is done because the estimation results are intended to define a
        symmetric confidence interval for the logit marginal prevalence,
        which can be back-transformed to define an asymmetric confidence
        interval for the untransformed marginal prevalence.
<p>
<p>
<b><u>Remarks</u></b>
<p>
    <b>margprev</b> estimates the marginal prevalence, which is a scenario
    proportion, which is a special case of a scenario mean.  The general
    principles behind scenario means for generalized linear models were
    introduced in Lane and Nelder (1982).
<p>
    <b>margprev</b> starts by estimating the logit of the scenario proportion, using
    <b>margins</b> and <b>nlcom</b>.  The results of this estimation are stored in <b>e()</b>, if
    the option <b>post</b> is specified.  These estimation results may be saved in
    an output dataset (or resultsset) by the <b>parmest</b> package, which can be
    downloaded from SSC.
<p>
    <b>margprev</b> assumes that the most recent estimation command estimates the
    parameters of a regression model, whose fitted values are conditional
    proportions, which must be bounded between 0 and 1.  It is the user's
    responsibility to ensure that this is the case.  However, it will be true
    if the conditional proportions are defined using a generalized linear
    model with a Bernoulli variance function (<i>not</i> a non-Bernoulli binomial
    variance function), and a logit, probit or complementary log-log link
    function.
<p>
    Note that <b>margprev</b> estimates a single marginal prevalence, and does not
    compare 2 marginal prevalences using differences or ratios.  Users who
    need to estimate differences between scenario proportions (population
    attributable risks) should use <b>regpar</b>.  Users who need to estimate ratios
    between scenario proportions (population unattributable fractions) should
    use either <b>punaf</b> (for cohort or cross-sectional study data) or <b>punafcc</b>
    (for case-control or survival study data).  Users who need to estimate
    general marginal means for general non-negative outcomes, instead of
    marginal prevalences for outcomes bounded between 0 and 1, should
    probably use <b>marglmean</b>.  The packages <b>marglmean</b>, <b>regpar</b>, <b>punaf</b> and 
    <b>punafcc</b> are downloadable from SSC.
<p>
<p>
<b><u>Examples</u></b>
<p>
    The following examples use the dataset <b>lbw.dta</b>, provided by Hosmer and
    Lemeshow (1988) and used in <b>[R] logistic</b> and distributed by Stata Press.
    This dataset has 1 observation for each of a sample of pregnancies, and
    data on the birth weight of the baby and on a list of predictive
    variables, which might be assumed to be causal by some scientists.
<p>
    Setup
<p>
        <b>. use http://www.stata-press.com/data/r11/lbw.dta, clear</b>
        <b>. describe</b>
<p>
    The following example estimates marginal prevalences of low birth weight
    under the existing scenario and under a fantasy scenario where no mothers
    smoke.
<p>
        <b>. logit low i.race i.smoke, or robust</b>
        <b>. margprev</b>
        <b>. margprev, at(smoke=0)</b>
<p>
    The following example demonstrates the use of <b>margprev</b> with the <b>parmest</b>
    package, downloadable from SSC.  The marginal prevalence of low birth
    weight is estimated using <b>margprev</b> (with the <b>post</b> option), and saved (in
    its logit-transformed version), using <b>parmest</b>, in a dataset in memory,
    overwriting the original dataset, with 1 observation for the 1
    transformed parameter, named <b>"Scenario_1"</b>, and data on the estimate,
    confidence limits, <i>P</i>-value, and other parameter attributes.  We then use 
    <b>replace</b> to replace the symmetric confidence interval for the transformed
    parameter with an asymmetric confidence interval for the untransformed
    parameter, and <b>describe</b> and <b>list</b> the new dataset.
<p>
        <b>. logit low i.race i.smoke, or robust</b>
        <b>. margprev, eform post</b>
        <b>. parmest, norestore</b>
        <b>. foreach Y of var estimate min* max* {</b>
        <b>. replace `Y'=invlogit(`Y')</b>
        <b>. }</b>
        <b>. describe</b>
        <b>. list</b>
<p>
<p>
<b><u>Saved results</u></b>
<p>
    <b>margprev</b> saves the following in <b>r()</b>:
<p>
    Scalars        
      <b>r(rank)</b>             rank of <b>r(V)</b>
      <b>r(N)</b>                number of observations
      <b>r(N_sub)</b>            subpopulation observations
      <b>r(N_clust)</b>          number of clusters
      <b>r(N_psu)</b>            number of samples PSUs, survey data only
      <b>r(N_strata)</b>         number of strata, survey data only
      <b>r(df_r)</b>             variance degrees of freedom, survey data only
      <b>r(N_poststrata)</b>     number of post strata, survey data only
      <b>r(k_margins)</b>        number of terms in <i>marginlist</i>
      <b>r(k_by)</b>             number of subpopulations
      <b>r(k_at)</b>             number of <b>at()</b> options (always 1)
      <b>r(level)</b>            confidence level of confidence intervals
<p>
    Macros         
      <b>r(atspec)</b>           <b>atspec()</b> option
<p>
    Matrices       
      <b>r(cimat)</b>            row vector containing estimates and confidence
                            limits for the untransformed marginal prevalence
      <b>r(b)</b>                vector of the logit of the marginal prevalence
      <b>r(V)</b>                estimated variance-covariance matrix of the logit
                            of the marginal prevalence
<p>
    If <b>post</b> is specified, <b>margprev</b> also saves the following in <b>e()</b>:
<p>
    Scalars        
      <b>e(rank)</b>             rank of <b>e(V)</b>
      <b>e(N)</b>                number of observations
      <b>e(N_sub)</b>            subpopulation observations
      <b>e(N_clust)</b>          number of clusters
      <b>e(N_psu)</b>            number of samples PSUs, survey data only
      <b>e(N_strata)</b>         number of strata, survey data only
      <b>e(df_r)</b>             variance degrees of freedom, survey data only
      <b>e(N_poststrata)</b>     number of post strata, survey data only
      <b>e(k_margins)</b>        number of terms in <i>marginlist</i>
      <b>e(k_by)</b>             number of subpopulations
      <b>e(k_at)</b>             number of <b>at()</b> options (always 1)
<p>
    Macros         
      <b>e(cmd)</b>              <b>margprev</b>
      <b>e(predict)</b>          program used to implement <b>predict</b>
      <b>e(atspec)</b>           <b>atspec()</b> option
      <b>e(properties)</b>       <b>b V</b>
<p>
    Matrices       
      <b>e(b)</b>                vector of the logit of the marginal prevalence
      <b>e(V)</b>                estimated variance-covariance matrix of the logit
                            of the marginal prevalence
      <b>e(V_srs)</b>            simple-random-sampling-without-replacement
                            (co)variance hat V_srswor, if <b>svy</b>
      <b>e(V_srswr)</b>          simple-random-sampling-with-replacement
                            (co)variance hat V_srswr, if <b>svy</b> and <b>fpc()</b>
      <b>e(V_msp)</b>            misspecification (co)variance hat V_msp, if <b>svy</b> and
                            available
<p>
    Functions      
      <b>e(sample)</b>           marks estimation sample
<p>
<p>
<b><u>Author</u></b>
<p>
    Roger Newson, National Heart and Lung Institute, Imperial College London,
    UK.
    Email: r.newson@imperial.ac.uk
<p>
<p>
<b><u>References</u></b>
<p>
<a name="hosmer_1988"></a>    Hosmer Jr., D. W., S. Lemeshow, and J. Klar.  1988.  Goodness-of-fit
        testing for the logistic regression model when the estimated
        probabilities are small.  <i>Biometrical Journal</i> <b>30</b>: 911–924.
<p>
<a name="lane_1982"></a>    Lane, P. W., and J. A. Nelder.  1982.  Analysis of covariance and
        standardization as instances of prediction.<i>  Biometrics</i> <b>38</b>: 613–621.
<p>
<p>
<b><u>Also see</u></b>
<p>
    Manual:  <b>[R] margins</b>, <b>[R] nlcom</b>, <b>[R] logistic</b>, <b>[R] logit</b>, <b>[R] probit</b>, <b>[R]</b>
             <b>glm</b>
<p>
      Help:  <b>[R] margins</b>, <b>[R] nlcom</b>, <b>[R] logistic</b>, <b>[R] logit</b>, <b>[R] probit</b>, <b>[R]</b>
             <b>glm</b>
             <b>marglmean</b>, <b>regpar</b>, <b>punaf</b>, <b>punafcc</b>, <b>parmest</b> if installed
</pre>