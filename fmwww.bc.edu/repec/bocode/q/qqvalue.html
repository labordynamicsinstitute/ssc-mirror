<pre>
-------------------------------------------------------------------------------
help for <b>qqvalue</b>                                                 (Roger Newson)
-------------------------------------------------------------------------------
<p>
<p>
<b><u>Generate frequentist </u></b><i><u>q</u></i><b><u>-values by inverting multiple-test procedures</u></b>
<p>
        <b>qqvalue</b> <i>varname</i> [<i>if</i>] [<i>in</i>] [ ,
               <b><u>me</u></b><b>thod(</b><i>method_name</i><b>)</b> <b><u>be</u></b><b>stof(</b><i>#</i><b>)</b>
               <b><u>qv</u></b><b>alue(</b><i>newvarname</i><b>)</b> <b><u>np</u></b><b>value(</b><i>newvarname</i><b>)</b> <b><u>ra</u></b><b>nk(</b><i>newvarname</i><b>)</b> <b><u>sv</u></b><b>alue(</b>
               <i>newvarname</i><b>)</b> <b><u>rv</u></b><b>alue(</b><i>newvarname</i><b>)</b>
               <b>float</b> <b>fast</b> ]
<p>
    where <i>method_name</i> is one of
<p>
    <b>bonferroni</b> | <b>sidak</b> | <b>holm</b> | <b>holland</b> | <b>hochberg</b> | <b>simes</b> | <b>yekutieli</b>
<p>
    <b>by</b> <i>varlist</i><b>:</b> can be used with <b>qqvalue</b>.  (See help for <b>by</b>.) If <b>by</b> <i>varlist</i><b>:</b>
    is used, then all generated variables are calculated using the specified
    multiple-test procedure within each by-group defined by the variables in
    the <i>varlist</i>.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>qqvalue</b> is similar to the R package <b>p.adjust</b>.  It inputs a single
    variable, assumed to contain <i>P</i>-values calculated for multiple
    comparisons, in a dataset with 1 observation per comparison.  It outputs
    a new variable, containing the frequentist <i>q</i>-values corresponding to
    these <i>P</i>-values, calculated by inverting a multiple-test procedure
    specified by the user.  These <i>q</i>-values represent, for each corresponding
    <i>P</i>-value, the minimum uncorrected <i>P</i>-value threshold for which that <i>P</i>-value
    would be in the discovery set, assuming that the specified multiple-test
    procedure was used on the same set of input <i>P</i>-values to generate a
    corrected <i>P</i>-value threshold.  These minimum uncorrected <i>P</i>-value
    thresholds may represent familywise error rates or false discovery rates,
    depending on the procedure used.  Optionally, <b>qqvalue</b> may output other
    variables, containing the various intermediate results used in
    calculating the <i>q</i>-values.  The multiple-test procedures available for
    <b>qqvalue</b> are a subset of those available using the <b>multproc</b> module of the 
    <b>smileplot</b> package, which can be downloaded from SSC.
<p>
<p>
<b><u>Options for </u></b><b><u>qqvalue</u></b>
<p>
    <b>method(</b><i>method_name</i><b>)</b> specifies the multiple-test procedure method to be
        used for calculating the <i>q</i>-values from the input <i>P</i>-values.  The
        <i>method_name</i> may be <b>bonferroni</b>, <b>sidak</b>, <b>holm</b>, <b>holland</b>, <b>hochberg</b>, <b>simes</b>,
        or <b>yekutieli</b>.  These method names specify that the <i>q</i>-values will be
        calculated from the input <i>P</i>-values by inverting the multiple-test
        procedure specified by the <b>method()</b> option of the same name for the 
        <b>multproc</b> option of the <b>smileplot</b> package, which can be downloaded
        from SSC.  If <b>method()</b> is unset, then it is set to <b>bonferroni</b>.
<p>
    <b>bestof(</b><i>#</i><b>)</b> specifies an integer number.  If the <b>bestof()</b> option is
        specified (and is greater than the number of input <i>P</i>-values), then
        the <i>q</i>-values are calculated assuming that the input <i>P</i>-values are a
        subset (usually the smallest) of a superset of <i>P</i>-values.  If the
        <b>method()</b> option specifies a one-step method (such as <b>bonferroni</b> or
        <b>sidak</b>), then the <i>q</i>-values do not depend on the other <i>P</i>-values in the
        superset, but only on the number of <i>P</i>-values in the superset.  If the
        <b>method()</b> option specifies a step-down method (such as <b>holm</b> or
        <b>holland</b>), then it is assumed that all the other <i>P</i>-values in the
        superset are greater than the largest of the input <i>P</i>-values.  If the
        <b>method()</b> option specifies a step-up method (such as <b>hochberg</b>, <b>simes</b>,
        or <b>yekutieli</b>), then it is assumed that all the other <i>P</i>-values in the
        superset are equal to 1, implying that the <i>q</i>-values will be
        conservative, and define an upper bound to the respective <i>q</i>-values
        that would have been calculated, if we knew the other <i>P</i>-values in the
        superset.  If <b>bestof()</b> is unspecified (or non-positive), then the
        input <i>P</i>-values are assumed to be the full set of <i>P</i>-values calculated.
        The <b>bestof()</b> option is useful if the input <i>P</i>-values are known (or
        suspected) to be the smallest of a greater set of <i>P</i>-values, which we
        do not know.  This often happens if the input <i>P</i>-values are from a
        genome scan reported in the literature.
<p>
    <b>qvalue(</b><i>newvarname</i><b>)</b> specifies the name of a new output variable to be
        generated, containing the <i>q</i>-values calculated from the input
        <i>P</i>-values, using the multiple-test procedure specified by the <b>method()</b>
        option.
<p>
    <b>npvalue(</b><i>newvarname</i><b>)</b> specifies the name of a new output variable to be
        generated, containing, in each observation, the total number of
        <i>P</i>-values in the sample of observations specified by the <b>if</b> and <b>in</b>
        qualifiers, or in the by-group containing that observation, if the
        <b>by:</b> prefix is specified.
<p>
    <b>rank(</b><i>newvarname</i><b>)</b> is the name of a new variable to be generated,
        containing, in each observation, the rank of the corresponding
        <i>P</i>-value, from the lowest to the highest.  Tied <i>P</i>-values are ranked
        according to their position in the input dataset.  If the <b>by:</b> prefix
        is specified, then the ranks are defined within the by-group.
<p>
    <b>svalue(</b><i>newvarname</i><b>)</b> specifies the name of a new output variable to be
        generated, containing the <i>s</i>-values calculated from the input
        <i>P</i>-values.  The <i>s</i>-values are an intermediate result, calculated in the
        course of calculating the <i>q</i>-values, and are used mainly for
        validation.  They are calculated from the input <i>P</i>-values by inverting
        the formulas used for the rank-specific critical <i>P</i>-value thresholds
        calculated by the <b>multproc</b> module of the <b>smileplot</b> package.  These
        rank-specific <i>P</i>-value thresholds are returned in the generated
        variable specified by the <b>critical()</b> option of <b>multproc</b>.  Note that
        the <i>s</i>-values may have values greater than 1.
<p>
    <b>rvalue(</b><i>newvarname</i><b>)</b> specifies the name of a new output variable to be
        generated, containing the <i>r</i>-values calculated from the input
        <i>P</i>-values.  The <i>r</i>-values are an intermediate result, calculated in the
        course of calculating the <i>q</i>-values, and are used mainly for
        validation.  They are calculated from the <i>s</i>-values by truncating the
        <i>s</i>-values to a maximum of 1.  The <i>q</i>-values are calculated from the
        <i>r</i>-values using a procedure dependent on the multiple-test procedure
        specified by the <b>method()</b> option.  If the multiple-test procedure is
        a one-step procedure, such as <b>bonferroni</b> or <b>sidak</b>, then the <i>q</i>-values
        are equal to the corresponding <i>r</i>-values.  If the multiple-test
        procedure is a step-down procedure, such as <b>holm</b> or <b>holland</b>, then the
        <i>q</i>-value for each <i>P</i>-value is equal to the cumulative maximum of all
        the <i>r</i>-values corresponding to <i>P</i>-values of rank equal to or less than
        that <i>P</i>-value.  If the multiple-test procedure is a step-up procedure,
        such as <b>hochberg</b>, <b>simes</b> or <b>yekutieli</b>, then the <i>q</i>-value for each
        <i>P</i>-value is equal to the cumulative minimum of all the <i>r</i>-values
        corresponding to <i>P</i>-values of rank equal to or greater than that
        <i>P</i>-value.
<p>
    <b>float</b> specifies that the output variables specified by the <b>qvalue()</b>,
        <b>rvalue()</b> and <b>svalue()</b> options will be created as variables of type
        <b>float</b>.  If <b>float</b> is absent, then these variables are created as
        variables of type <b>double</b>.  Whether or not <b>float</b> is specified, all
        generated variables are stored to the lowest precision possible
        without loss of information.
<p>
    <b>fast</b> is an option for programmers.  It specifies that <b>qqvalue</b> will not
        take any action so that it can restore the original data in the event
        of failure, or if the user presses <b>Break</b>.
<p>
<p>
<b><u>Remarks</u></b>
<p>
    The methods and formulas for <b>qqvalue</b> are given in Newson (2010).
    Multiple-test procedures are reviewed in Newson <i>et al.</i> (2003), and
    described in the on-line help for <b>multproc</b>.  All of these sources contain
    extensive references for further reading.
<p>
    The <b>qqplot</b> package is similar to the R package <b>p.adjust</b>, which also
    calculates frequentist <i>q</i>-values corresponding to multiple-test
    procedures.  Note that, in the on-line documentation for <b>p.adjust</b> in R,
    the <i>q</i>-values are referred to as "adjusted <i>P</i>-values", although a lot of
    users refer to them as "<i>q</i>-values".  There is no clear consensus regarding
    the correct terminology to use, even among statisticians.  The term
    "<i>q</i>-value" was introduced in Storey (2003) to describe a minimum positive
    false discovery rate (pFDR) under which a <i>P</i>-value will be included in a
    discovery set, assuming that this discovery set is defined to control the
    pFDR.  The pFDR is a quantity defined for empirical Bayesian methods.  By
    contrast, the multiple-test procedures used by <b>qqvalue</b> and <b>p.adjust</b>
    define the discovery set to control either the familywise error rate
    (FWER) or the false discovery rate (FDR), both of which are defined for
    purely frequentist methods.  For this reason, I originally used the term
    "quasi-<i>q</i>-values" to denote frequentist <i>q</i>-values, and chose the name
    <b>qqvalue</b> for the package to compute these.  However, I was later advised
    that the prefix "quasi-" was not really necessary.  I therefore now
    simply use the term "<i>q</i>-values", or "frequentist <i>q</i>-values" if I need to
    distinguish them from Bayesian <i>q</i>-values.
<p>
    <b>qqvalue</b>, <b>multproc</b> and <b>smileplot</b> all require input datasets with 1
    observation for each of a set of <i>P</i>-values, usually corresponding to a set
    of estimated parameters.  Such input datasets may be produced using the
    official Stata utilities <b>statsby</b> and <b>postfile</b>, or alternatively by the
    user-written Stata package <b>parmest</b>, which can be downloaded from SSC.
<p>
<p>
<b><u>Technical note</u></b>
<p>
    If the user specifies <b>method(sidak)</b>, then <b>qqvalue</b> uses the formula for
    <b>method(bonferroni)</b> to calculate the <i>s</i>-values, <i>r</i>-values and <i>q</i>-values
    corresponding to input <i>P</i>-values too small to be subtracted from 1 in
    double precision to give a result less than 1.  Similarly, if the user
    specifies <b>method(holland)</b>, then <b>qqvalue</b> uses the formula for <b>method(holm)</b>
    to calculate the <i>s</i>-values, <i>r</i>-values and <i>q</i>-values corresponding to input
    <i>P</i>-values too small to be subtracted from 1 in double precision to give a
    result less than 1.  This practice ensures that the <i>q</i>-values will be
    sensible, and no smaller than the corresponding <i>P</i>-values, even if these
    <i>P</i>-values are too small to be subtracted from 1 to give a result less than
    1.  It works because the Sidak <i>q</i>-value converges in ratio to the
    Bonferroni <i>q</i>-value in the limit as the corresponding <i>P</i>-value tends to
    zero.
<p>
<b><u>Examples</u></b>
<p>
    The following example uses the <b>auto</b> data, distributed with Stata.  The 
    <b>somersd</b> package is used to measure the Somers' <i>D</i> parameters for rank
    associations between a list of car-specific variables and non-US origin.
    The <b>parmest</b> package is then used to replace the dataset in memory with a
    new dataset, with 1 observation per estimated parameter and data on
    parameter estimates, confidence limits and <i>P</i>-values.  We then use <b>qqvalue</b>
    to calculate <i>q</i>-values corresponding to the <i>P</i>-values, using the Simes
    procedure.  The <b>parmest</b> and <b>somersd</b> packages can be downloaded from SSC.
<p>
                . sysuse auto, clear
                . somersd foreign price mpg headroom trunk weight length turn
                    displacement gear_ratio, tdist
                . parmest, norestore
                . qqvalue p, method(simes) qvalue(myqval)
                . list
<p>
    The following example also uses the <b>auto</b> data.  It first uses the <b>somersd</b>
    package, together with the <b>parmby</b> module of the <b>parmest</b> package, to
    create a new dataset in the memory, with 1 observation for each of a list
    of rank correlations involving car price in each car origin group (US and
    non-US cars).  We then use <b>qqvalue</b>, with the <b>by</b> <i>varlist</i><b>:</b> prefix, to
    demonstrate the calculation of 2 separate sets of <i>q</i>-values, one for
    US-made cars and one for non-US-made cars.
<p>
                . sysuse auto, clear
                . parmby "somersd price mpg headroom trunk weight length turn
                    displacement gear_ratio, tdist", by(foreign) norestore
                . by foreign: qqvalue p, method(simes) qvalue(myqval)
                . by foreign: list
<p>
<p>
<b><u>Author</u></b>
<p>
    Roger B. Newson, National Heart and Lung Institute, Imperial College
    London, UK.  Email: r.newson@imperial.ac.uk
<p>
<p>
<b><u>References</u></b> 
<p>
    Newson, R. B.  2010.  Frequentist <i>q</i>-values for multiple-test procedures.
        <i>The Stata Journal</i> 10(4): 568-584.  Download from <i>THe Stata Journal</i>
        website.
<p>
    Newson, R. and the ALSPAC Study Team.  2003.  Multiple-test procedures
        and smile plots.  <i>The Stata Journal</i> 3(2): 109-132.  Download from <i>THe</i>
        <i>Stata Journal</i> website.
<p>
    Storey, J. D.  2003.  The positive false discovery rate: a Bayesian
        interpretation and the <i>q</i>-value.  <i>The Annals of Statistics</i> 31(6):
        2013–2035.
<p>
<p>
<b><u>Also see</u></b>
<p>
 Manual:  <b>[R] by</b>, <b>[R] statsby</b>, <b>[P] postfile</b>.
On-line:  help for <b>[D] by</b>, <b>[D] statsby</b>, <b>[P] postfile</b>
          help for <b>multproc</b>, <b>smileplot</b>, <b>parmest</b>, <b>somersd</b> if installed
</pre>