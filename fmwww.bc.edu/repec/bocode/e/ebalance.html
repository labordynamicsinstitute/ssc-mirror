<pre>
<b>help ebalance</b>
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
    <b>ebalance</b> --    Entropy reweighting to create balanced samples
<p>
<b><u>Syntax</u></b>
<p>
        <b>ebalance</b> [<i>treat</i>] <i>covar</i> [<i>if</i>] [<i>in</i>] [<b>,</b> <i>options</i>]
<p>
    <i>options</i>                  Description
    -------------------------------------------------------------------------
<p>
    Main
      <b><u>tar</u></b><b>gets(</b><i>numlist</i><b>)</b>       set balance constraints for covariates; default
                               is <b>targets(1)</b>
      <b><u>manual</u></b><b>targets(</b><i>numlist</i><b>)</b> alternative for manual specification of balance
                               constraints
      <b><u>base</u></b><b>wt(</b><i>varname</i><b>)</b>        variable with base weights; default is base
                               weight of 1 for all units
      <b><u>norm</u></b><b>const(</b><i>real</i><b>)</b>        set normalization constant; default is
                               <b>normconst(1.0)</b>
<p>
    Advanced
      <b><u>wttr</u></b><b>eat</b>                accept base weights for treated units; <b>basewt()</b>
                               is required
      <b><u>g</u></b><b>enerate(</b><i>newvar</i><b>)</b>       specify varname for variable that stores the
                               entropy balancing weights
      <b><u>k</u></b><b>eep(</b><i>filename</i><b>)</b>         specify filename of a dataset that stores the
                               balance table
      <b><u>rep</u></b><b>lace</b>                overwrite existing dataset
      <b><u>maxi</u></b><b>ter(</b><i>#</i><b>)</b>             set maximum number of iterations; default is
                               <b>maxiter(20)</b>
      <b><u>tol</u></b><b>erance(</b><i>real</i><b>)</b>        set tolerance level for convergence; default is
                               <b>tolerance(.015)</b>
<p>
    -------------------------------------------------------------------------
    <i>covar</i> is a <i>varlist</i> that may include factor variables, see fvvarlist.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>ebalance</b> implements entropy balancing, a data preprocessing procedure
    that allows users to reweight a dataset such that the covariate
    distributions in the reweighted data satisfy a set of specified moment
    conditions (see Hainmueller 2012 for details). This can be useful to
    create balanced samples in observational studies with a binary treatment
    where the control group data can be reweighted to match the covariate
    moments in the treatment group. Entropy balancing can also be used to
    reweight a survey sample to known characteristics from a target
    population. <b>ebalance</b> can be used to adjust differences in the first,
    second, and third moment of the covariate distributions (ie. covariate
    means, variances, and skewness). Moments of the joint distribution can
    also be adjusted by including interaction terms for the covariates. The
    weights that result from entropy balancing can be passed to any standard
    model to subsequently analyze the reweighted data.
<p>
<b><u>Required</u></b>
<p>
    <b>treat</b> <i>varname</i> that specifies the binary treatment variable. Values should
        be 1 for treated and 0 for control units. By default <b>ebalance</b> will
        reweight the data from the control units to match the moments
        computed from the data of the treated units. If the user just has a
        single data group (eg. a survey sample) that should be reweighted to
        match some known moments (eg. from a target population), then the
        <b>manualtargets()</b> option should be used and in this case the <i>treat</i>
        variable should be omitted (see <b>manualtargets()</b> for details).
<p>
    <b>covar</b> <i>varlist</i> that specifies the covariates to be balanced on. At least
        one variable should be specified.
<p>
<p>
<b><u>Options</u></b>
<p>
        +------+
    ----+ Main +-------------------------------------------------------------
<p>
    <b>targets(</b><i>numlist</i><b>)</b> specifies the highest order of moment constraints (1, 2,
        or 3) for each variable specified in <i>covar</i>. For example, <b>tar(3 1 2)</b>
        means that the adjustment includes the 1st, 2nd, and 3rd moment for
        the first covariate, the 1st moment for the second covariate, and the
        1st and 2nd moment for the third covariate. By adjustment we mean
        that the control group data will be reweighted such that the
        specified moments match the values of the same moments in the
        treatment group data.  The length of <i>numlist</i> should be identical to
        the number of covariates specified in <i>covar</i> except when only a single
        number is specified, which means that all the covariates will be
        adjusted to the same highest order as specified by that number, e.g.
        <b>tar(1)</b> is equivalent to <b>tar(1 1 1)</b> if three covariates are used in
        <i>covar</i>. Note that for a binary covariate only its first moment will be
        considered, regardless what number is specified for it in <b>targets()</b>,
        since matching the 1st moment is sufficient to balance higher
        moments.
<p>
 
    <b>manualtargets(</b><i>numlist</i><b>)</b> if the user just has a single data group (eg. a
        survey sample), the <b>manualtargets()</b> option can be used to reweight
        the data such that it matches some user specified target moments for
        the covariates.  For example, <b>manualtargets(25 10 0.8)</b> implies that
        the balancing weights will be chosen such that the means of the 1st,
        2nd, and 3rd covariate in<i> covar</i> will match 25, 10, and 0.8,
        respectively. The length of <i>numlist</i> should be identical to the number
        of covariates specified in <i>covar</i>. Since there is only a single group,
        no<i> treat</i> variable should be used. The <b>manualtargets()</b> option is not
        compatible with <b>targets()</b> and <b>wttreat</b>.
<p>
    <b>basewt(</b><i>varname</i><b>)</b> a <i>varname</i> that specifies a variable with survey base
        weights. If not specified, the default is to set all base weights to
        1. If specified, the base weights for the control units are taken
        from <b>basewt(varname)</b>, but the base weights for the treated units are
        still set to 1 unless <b>wttreat</b> is also specified. In the latter case,
        the base weights for all units are taken from <b>basewt(varname)</b>.
<p>
    <b>normconst(</b><i>real</i><b>)</b> a real number that specifies the normalizing constant
        (the default is 1). The resulting <b>ebalance</b> weights for the control
        units are multiplied with this specified real number, e.g.
        <b>normconst(2)</b> means that the total of the <b>ebalance</b> weights for the
        control units is two times the total of the weights for the treated
        units.
<p>
        +----------+
    ----+ Advanced +---------------------------------------------------------
<p>
    <b>wttreat</b> specifies that survey weights for treated units should be taken
        into consideration.  The weights are stored in the variable specified
        by <b>basewt()</b>. Not compatible with <b>manualtargets()</b>. See <b>basewt()</b>.
<p>
    <b>generate(</b><i>newvar</i><b>)</b> creates a new variable <i>newvar</i> that stores the estimated
        balancing weights. If not specified, the weights are stored in a
        variable named <i>_webal</i> by default. Note that <i>_webal</i> will be replaced
        when <b>ebalance</b> is called again.
<p>
    <b>keep(</b><i>filename</i><b>)</b> saves a dataset with the balance table in the file
        <i>filename</i><b>.dta</b>, which will hold the following variables (balance table
        for a single group is slightly different):
<p>
        <b>Xname:</b> covariate that was balanced on
<p>
        <b>mean_Tr:</b> mean of the treated units
<p>
        <b>mean_Co_Pre:</b> mean of the raw control units
<p>
        <b>mean_Co_Post:</b> mean of the reweighted control units
<p>
        <b>var_Tr:</b> variance of the treated units
<p>
        <b>var_Co_Pre:</b> variance of the raw control units
<p>
        <b>var_Co_Post:</b> variance of the reweighted control units
<p>
        <b>skew_Tr:</b> skewness of the treated units
<p>
        <b>skew_Co_Pre:</b> skewness of the raw control units
<p>
        <b>skew_Co_Post:</b> skewness of the reweighted control units
<p>
        <b>sdiff_Pre:</b> standardized difference between treated and
                 raw control groups
<p>
        <b>sdiff_Post:</b> standardized difference between treated and
                 reweighted control groups
<p>
    <b>replace</b> permits <b>keep()</b> to overwrite an existing dataset.
<p>
    <b>maxiter(</b><i>#</i><b>)</b> specifies the maximum number of iterations for the algorithm.
        Usually the default setting of 20 iterations should be sufficient,
        but the maximum number of iterations can be increased if no
        convergence is achieved. Notice that increasing the number of
        iterations will not help to achieve convergence if the algorithm
        fails because too many potentially collinear moment constraints are
        specified. In such cases, one should lower the order of the moment
        conditions by resetting <b>targets()</b> or dropping variables in<i> covar</i>.
        Another option is to relax the tolerance level. Note that even if
        convergence is not achieved within the maximum number of iterations,
        <b>ebalance</b> will still return the weights obtained in the last
        iteration.
<p>
    <b>tolerance(</b><i>real</i><b>)</b> specifies the tolerance level for the convergence of the
        algorithm. The tolerance level refers to the maximum deviation across
        the specified moment constraints. Convergence is achieved if all
        specified moments match within the specified tolerance level.
<p>
<b><u>Examples</u></b>
<p>
    Load example data (Lalonde Dataset)
    . sysuse cps1re74
<p>
    Basic syntax
    . ebalance treat age educ black, tar(1)
<p>
      tar(1), short for tar(1 1 1), means that the control units are
      reweighted to satisfy the balance constraints that the 1st moments
      (means) of <i>age</i>, <i>educ</i> and <i>black</i> match the corresponding moments of the
      treated units.
<p>
    . ebalance treat age educ black, tar(3 2 1)
<p>
      control units are reweighted to satisfy the balance constraints that
      the 1st, 2nd, and 3rd moment (means, variances, and skewness) of <i>age</i>,
      the 1st and 2nd moment of<i> educ</i>, and the 1st moment of<i> black</i> match the
      corresponding moments of the treated units. Since<i> black</i> is binary,
      adjusting its 1st moment is sufficient to adjust the higher moments.
<p>
    New variable and higher order constraints
    . ebalance treat age educ black, g(ebw1) tar(1)
    . ebalance treat age educ black, g(ebw2) tar(3 1 1)
<p>
      The two commands store the estimated balancing weights in the newly
      generated variables <i>ebw1</i> and <i>ebw2</i> respectively. figure1 and figure2
      display the kernel densities of <i>age</i> for the treatment and control group
      data in the two cases and show how balancing constraints may affect the
      reweighted covariate distributions.
<p>
    Interactions
    . gen ageXblack = age*black
    . ebalance treat educ age black ageXblack, tar(1)
    . bysort black: tabstat age [aweight=_webal], by(treat) s(N me v) nototal
<p>
      By including interaction terms, covariates will be balanced across
      subsample groups. In the above case, for example, <i>age</i> is balanced
      within both black and non-black subgroups. It can also be achieved by
      using the functionality for factor variables (see fvvarlist for
      details) as follows:
 
    <b>. ebalance treat educ black##c.age, tar(1)</b>
    . bysort black: tabstat age [aweight=_webal], by(treat) s(N me v) nototal
<p>
    Save balance table
    . ebalance treat age educ black, tar(2) k(baltable) rep
<p>
      The balance table for treated and control units of both raw data and
      reweighted data is saved as <i>baltable.dta</i> for further use.
<p>
    Estimation after reweighting
    . reg re78 treat age educ black re74 re75 u74 u75
    . ebalance treat age educ black re74 re75 u74 u75, tar(2)
    . svyset [pweight= _webal]
    . svy: reg re78 treat
<p>
      We first run a simple regression controlling for all the covariates in
      the Lalonde dataset. The estimate of the treatment effect is rather far
      from the experimental target answer of $1,794. Then we use <b>ebalance</b> to
      adjust 1st and 2nd moments of the covariates for the control group. The
      following regression based on the reweighted data generates an estimate
      with much less bias (see Hainmueller 2012 for details).
  
    Example for Single Group
    . ebalance age educ black hispan if treat==0, manual(28 10 0.1 0.1)
 
      If the user only has a single data group, for example a survey sample
      that should be reweighted to match some known target moments, then the
      <b>manualtargets()</b> option should be used to specify the moment
      constraints. Here we use this option such that the control units are
      reweighted such that the means of <i>age</i>, <i>educ</i>, <i>black</i> and <i>hisp</i> are equal
      to 25, 10, 0.1 and 0.1, respectively. Note that no treatment variable
      is specified in this case since there is only one group.
 
    Base Weights
    . gen basew=1
    . ebalance treat age educ black, tar(3) basewt(basew) norm(2)
<p>
      <b>basewt(basew)</b> option is used to pass user supplied base weights.
      Moreover, the<b> norm(2)</b> option is used to set the total of the weights
      for the control units to two times the total of the weights for the
      treated units.
 
    . replace basew=5 if treat==1 &amp; age&gt;30
    . ebalance treat age educ black, tar(3) basewt(basew) norm(2) wttr
<p>
      When<b> wttreat</b> is also specified, the base weights for treated units are
      also taken from<b> basewt(basew)</b>.  Because of this, the result is slightly
      different from above.
 
    Optimization settings
    . ebalance treat age educ black, tar(3) maxi(15)
    . ebalance treat age educ black, tar(3) maxi(15) tol(1)
<p>
      In the first example, the optimization does not converge within the
      default tolerance, so<b> ebalance</b> returns the weights from the last
      iteration which already come pretty close. In the second example, the
      <b>tol()</b> is increased to relaxing the convergence criterion.
<p>
<b><u>Saved results</u></b>
<p>
    By default, <b>ebalance</b> ereturns the following results, which can be
        displayed by typing<b> ereturn list</b> after <b>ebalance</b> is finished (also see
        ereturn).
<p>
    Scalars   
      <b>e(convg)</b>       whether convergence is achieved (1 = achieved; 0 = not)
      <b>e(maxdiff)</b>     maximum deviation across the specified moment
                       constraints
<p>
    Macros    
      <b>e(cmd)</b>         <b>ebalance</b>
      <b>e(title)</b>       Entropy Balance
      <b>e(cmdline)</b>     command as typed
<p>
    Matrices  
      <b>e(lambdas)</b>     coefficient vector
      <b>e(moments)</b>     sample moments of the treated
      <b>e(preBal)</b>      balance table before reweighting
      <b>e(postBal)</b>     balance table after reweighting
<p>
    Functions 
      <b>e(sample)</b>      marks estimation sample
<p>
  -----------------------------------------------------------------------------
    <b>e(lambdas)</b> and <b>e(moments)</b> are in the same order as the adjusted
      covariates are shown in the <i>Data Setup</i> section, i.e. the first order
      moment constraints come first; then the second; then the third.
<p>
<b><u>References</u></b>
<p>
    Hainmueller, J. 2012, "Entropy Balancing: A Multivariate Reweighting
        Method to Produce Balanced Samples in Observational Studies."
        Political Analysis, 20(1), 25-46.
<p>
    Zaslavsky, A. 1988, "Representing local reweighting area adjustments of
        households", Survey Methodology 14(2), 265-288.
<p>
    Ireland, C. and Kullback, S. 1968, "Contingency tables with given
        marginals", Biometrika 55, 179--188.
<p>
    Kullback, S. 1959, "Information Theory and Statistics", Wiley, NY.
<p>
<b><u>Authors</u></b>
<p>
      Jens Hainmueller, jhainm@mit.edu
      MIT
<p>
      Yiqing Xu, xyq@mit.edu
      MIT
</pre>