<pre>
<b>help cqiv</b>
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
    <b>Censored quantile instrumental variable (regression)</b>
<p>
<p>
<b><u>Syntax</u></b>
<p>
        <b>cqiv</b> <i>depvar</i> [<i>varlist</i>] <b>(</b><i>endogvar</i> <b>=</b> <i>instrument</i><b>)</b> [<i>if</i>] [<i>in</i>] [<i>weight</i>] [<b>,</b>
                 <i>options</i>]
<p>
<p>
    <i>options</i>                    Description
    -------------------------------------------------------------------------
<p>
    Model
      <b><u>q</u></b><b>uantiles(</b><i>numlist</i><b>)</b>       sets the quantile(s) (values between 0 to 100)
                                 at which the model is estimated.
      <b><u>c</u></b><b>ensorpt(</b><i>#</i><b>)</b>              censoring point of the dependent variable;
                                 default is 0.
      <b><u>t</u></b><b>op</b>                      right censoring of the dependent variable;
                                 otherwise, left censoring as default.
      <b><u>u</u></b><b>ncensored</b>               uncensored quantile IV (QIV) estimation.
      <b><u>e</u></b><b>xogenous</b>                censored quantile regression (CQR) with no
                                 endogeneity.
      <b><u>f</u></b><b>irststage(</b><i>string</i><b>)</b>       determine the first stage estimation
                                 procedure, where <i>string</i> is <b>quantile</b>
                                 (default), <b>distribution</b>, <b>ols</b>.
      <b><u>exc</u></b><b>lude</b>                  excludes exogenous regressors other than
                                 instruments from the first stage estimation.
      <b>nquant(</b><i>#</i><b>)</b>                determines the number of quantiles used in the
                                 first stage estimation when the estimation
                                 procedure is <b>quantile</b>; default is 50; it is
                                 advisable to choose a value between 20 to
                                 100.
      <b>nthresh(</b><i>#</i><b>)</b>               determines the number of thresholds used in
                                 the first stage estimation when the
                                 estimation procedure is <b>distribution</b>;
                                 default is 50; it is advisable to choose a
                                 value between 20 up to the value of the
                                 sample size.
      <b>ldv1(</b><i>string</i><b>)</b>             determines the limited dependent variable
                                 (LDV) model used in the first stage
                                 estimation when the estimation procedure is
                                 <b>distribution</b>, where <i>string</i> is <b>probit</b>
                                 (default), <b>logit</b>.
      <b>ldv2(</b><i>string</i><b>)</b>             determines the LDV model used in the first
                                 step of the second stage estimation, where
                                 <i>string</i> is <b>probit</b> (default), <b>logit</b>.
<p>
    CQIV estimation
      <b><u>cor</u></b><b>ner</b>                   calculates the (average) marginal quantile
                                 effects for censored dependent variable when
                                 the censoring is due to economic reasons
                                 such are corner solutions; only applicable
                                 to linear models.
      <b>drop1(</b><i>#</i><b>)</b>                 sets the proportion of observations <i>q0</i> with
                                 probabilities of censoring above the
                                 quantile index that are dropped in the first
                                 step of the second stage (See Chernozhukov,
                                 Fernandez-Val and Kowalski (2010) for
                                 details); default is 10.
      <b>drop2(</b><i>#</i><b>)</b>                 sets the proportion of observations <i>q1</i> with
                                 estimate of the conditional quantile above
                                 (below for right censoring) that are dropped
                                 in the second step of the second stage (See
                                 Chernozhukov, Fernandez-Val and Kowalski
                                 (2010) for details); default is 3.
      <b><u>viewl</u></b><b>og</b>                  shows the intermediate estimation results;
                                 default is no log.
<p>
    Inference
      <b><u>co</u></b><b>nfidence(</b><i>string</i><b>)</b>       type of confidence intervals, where <i>string</i> is
                                 <b>no</b> (no confidence intervals, the default),
                                 <b>boot</b>, <b>weightboot</b>.
      <b><u>b</u></b><b>ootreps(</b><i>#</i><b>)</b>              number of repetition of bootstrap or weighted
                                 bootstrap; default is 100.
      <b><u>s</u></b><b>etseed(</b><i>#</i><b>)</b>               initial seed number in repetition of bootstrap
                                 or weighted bootstrap; default is 777.
      <b><u>le</u></b><b>vel(</b><i>#</i><b>)</b>                 sets confidence level; default is 95.
<p>
    Robustness check
      <b><u>no</u></b><b>robust</b>                 suppresses the robustness diagnostic test
                                 results.
    -------------------------------------------------------------------------
<p>
    <b>cqiv</b> allows <b>weight</b>s, <b>aweight</b>s and <b>pweight</b>s; see weight. No matter which
        weights are specified by the users, note that <b>pweight</b> is
        automatically forced for the probit or logit estimation in the
        procedure, and <b>aweight</b> for the quantile regression estimation.  When
        <b>confidence(weightboot)</b> is implemented the multiplication of the
        bootstrap weights and the user-specified weights is used as the
        weights in the bootstrap procedure.
 
    <b>break</b> command pressed in the middle of the execution may not restore the
        original dataset.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>cqiv</b> conducts censored quantile instrumental variable (CQIV) estimation.
    This command can implement both censored and uncensored quantile IV
    estimation either under exogeneity or endogeneity.  The estimator
    proposed by Chernozhukov, Fernandez-Val and Kowalski (2010) is used if
    CQIV estimation is implemented. A parametric version of the estimator
    proposed by Lee (2007) is used if quantile IV estimation without
    censoring is implemented.  The estimator proposed by Chernozhukov and
    Hong (2002) is used if censored quantile regression (CQR) is estimated
    without endogeneity.  Note that all the variables in the parentheses of
    the syntax are those involved in the first stage estimation of CQIV and
    QIV.
<p>
<p>
<b><u>Options</u></b>
<p>
        +-------+
    ----+ Model +------------------------------------------------------------
<p>
    <b>quantiles(</b><i>numlist</i><b>)</b> specifies the quantiles at which the model is
        estimated and should contain percentage numbers between 0 and 100.
        Note that this is not the list of quantiles for the first stage
        estimation with quantile specification.
<p>
    <b>censorpt(</b><i>#</i><b>)</b> specifies the censoring point of the dependent variable,
        where the default is 0; inappropriately specified censoring point
        will generate errors in estimation.
<p>
    <b>top</b> sets right censoring of the dependent variable; otherwise, left
        censoring is assumed as default.
<p>
    <b>uncensored</b> selects uncensored quantile IV (QIV) estimation.
<p>
    <b>exogenous</b> selects censored quantile regression (CQR) with no endogeneity,
        which is proposed by Chernozhukov and Hong (2002).
<p>
    <b>firststage(</b><i>string</i><b>)</b> determines the first stage estimation procedure, where
        <i>string</i> is either <b>quantile</b> for quantile regression (the default),
        <b>distribution</b> for distribution regression (either probit or logit), or
        <b>ols</b> for ols estimation. Note that <b>firststage(distribution)</b> can take a
        considerable amount of time to execute.
<p>
    <b>exclude</b> excludes exogenous regressors other than instruments from the
        first stage estimation.
<p>
    <b>nquant(</b><i>#</i><b>)</b> determines the number of quantiles used in the first stage
        estimation when the estimation procedure is <b>quantile</b>; default is 50,
        that is, total 50 evenly-spaced quantiles are chosen in the
        estimation; it is advisable to choose a value between 20 to 100.
<p>
    <b>nthresh(</b><i>#</i><b>)</b> determines the number of thresholds used in the first stage
        estimation when the estimation procedure is <b>distribution</b>; default is
        50, that is, total 50 evenly-spaced thresholds are chosen in the
        estimation; it is advisable to choose a value between 20 and the
        value of the sample size; when the value is smaller than this range,
        the estimation may be subject to multicollinearity.
<p>
    <b>ldv1(</b><i>string</i><b>)</b> determines the LDV model used in the first stage estimation
        when the estimation procedure is <b>distribution</b>, where <i>string</i> is either
        <b>probit</b> for probit estimation (the default), or <b>logit</b> for logit
        estimation.
<p>
    <b>ldv2(</b><i>string</i><b>)</b> determines the LDV model used in the first step of the
        second stage estimation, where <i>string</i> is either <b>probit</b> (the default),
        or <b>logit</b>.
<p>
<p>
        +-----------------+
    ----+ CQIV estimation +--------------------------------------------------
<p>
    <b>corner</b> calculates the (average) marginal quantile effects for censored
        dependent variable when the censoring is due to economic reasons such
        are corner solutions. Under this option, the reported coefficients
        are the average corner solution marginal effects if the underlying
        function is linear in the endogenous variable. For each observation,
        if the predicted value of depvar is beyond the censoring point, the
        marginal effect is set to zero; otherwise, it is set to the
        coefficient. The reported average corner solution marginal effect
        averages the marginal effects over all observations. If the
        underlying function is nonlinear in the endogenous variable, average
        marginal effects must be calculated directly from the coefficients
        without <b>corner</b> option. For details of the related concepts, see
        Section 2.1 of Chernozhukov, Fernandez-Val and Kowalski (2010). The
        relevant example can be found in the examples section of this help
        file.
<p>
    <b>drop1(</b><i>#</i><b>)</b> sets the proportion of observations <i>q0</i> with probabilities of
        censoring above the quantile index that are dropped in the first step
        of the second stage (See Chernozhukov, Fernandez-Val and Kowalski
        (2010) for details); default is 10.
<p>
    <b>drop2(</b><i>#</i><b>)</b> sets the proportion of observations <i>q1</i> with estimate of the
        conditional quantile above (below for right censoring) that are
        dropped in the second step of the second stage (See Chernozhukov,
        Fernandez-Val and Kowalski (2010) for details); default is 3.
<p>
    <b>viewlog</b> shows the intermediate estimation results; the default is no log.
<p>
<p>
        +-----------+
    ----+ Inference +--------------------------------------------------------
<p>
    <b>confidence(</b><i>string</i><b>)</b> specifies the type of confidence intervals. With
        <i>string</i> being <b>no</b>, which is the default, no confidence intervals are
        calculated. With <i>string</i> being <b><u>b</u></b><b>oot</b> or <b><u>w</u></b><b>eightedboot</b>, either
        nonparametric bootstrap or weighted bootstrap (respectively)
        confidence intervals are calculated. The weights of the weighted
        bootstrap are generated from the standard exponential distribution.
        Note that <b>confidence(boot)</b> and <b>confidence(weightboot)</b> can take a
        considerable amount of time to execute.
<p>
    <b>bootreps(</b><i>#</i><b>)</b> sets the number of repetitions of bootstrap or weighted
        bootstrap if the <b>confidence(boot)</b> or <b>confidence(weightboot)</b> is
        selected. The default number of repetitions is 100.
<p>
    <b>setseed(</b><i>#</i><b>)</b> sets the initial seed number in repetition of bootstrap or
        weighted bootstrap; the default is 777.
<p>
    <b>level(</b><i>#</i><b>)</b> sets confidence level, and default is 95.
<p>
<p>
        +------------------+
    ----+ Robustness check +-------------------------------------------------
<p>
    <b>norobust</b> suppresses the robustness diagnostic test results.  No
        diagnostic test results to suppress when <b>uncensored</b> is employed.
<p>
<p>
<b><u>Saved results</u></b>
<p>
    <b>cqiv</b> saves the following results in <b>e()</b>:
<p>
    Scalars
         <b>e(obs)</b>         Number of observations
         <b>e(censorpt)</b>    Censoring point
         <b>e(drop1)</b>       <i>q0</i>
         <b>e(drop2)</b>       <i>q1</i>
         <b>e(bootreps)</b>    Number of bootstrap or weighted bootstrap repetitions
         <b>e(level)</b>       Significance level of confidence interval
<p>
    Macros
         <b>e(command)</b>     Name of the command: cqiv
         <b>e(regression)</b>  Name of the implemented regression: either cqiv, qiv, o
&gt; r cqr
         <b>e(depvar)</b>      Name of the dependent variable
         <b>e(endogvar)</b>    Name of the endogenous regressor
         <b>e(instrument)</b>  Names of the instrumental variables
         <b>e(regressors)</b>  Names of the regressors
         <b>e(firststage)</b>  Type of the first stage estimation
         <b>e(confidence)</b>  Type of confidence intervals
<p>
    Matrices
         <b>e(results)</b>     Matrix containing the estimated coefficients, mean, and
&gt;  lower and upper bounds of confidence intervals.
         <b>e(quantiles)</b>   Row vector containing the quantiles at which CQIV have 
&gt; been estimated.
         <b>e(robustcheck)</b> Matrix containing the results for the robustness diagno
&gt; stic test results. (See Table B1 of Chernozhukov, Fernandez-Val and Kowalski 
&gt; (2010).)
         Note that the entry <i>complete</i> denotes whether all the steps are include
&gt; d in the procedure; 1 when they are, and 0 otherwise. For other entries consu
&gt; lt the paper.
<p>
<b><u>Examples</u></b>
<p>
    <b>. webuse set http://www.econ.yale.edu/~ak669/</b>               (to specify
        URL from which dataset will be obtained)
    <b>. webuse alcoholengel</b>                                       (to load the
        dataset over the URL; See Blundell, Chen and Kristensen (2007) for
        data descriptions.)
    <b>. cqiv alcohol logexp2 nkids (logexp = logwages nkids), quantiles(25 50</b>
        <b>75)</b>   (This generates part of the empirical results of Chernozhukov,
        Fernandez-Val and Kowalski (2010).)
<p>
    <b>. cqiv alcohol logexp2 (logexp = logwages), quantiles(20 25 70(5)90)</b>
        <b>firststage(ols)</b>
<p>
    <b>. cqiv alcohol logexp2 (logexp = logwages), firststage(distribution)</b>
        <b>ldv1(logit)</b>
<p>
    <b>. cqiv alcohol logexp2 nkids (logexp = logwages nkids), uncensored</b>    
        (to run QIV)
<p>
    <b>. cqiv alcohol logexp logexp2 nkids, exogenous</b>                        
        (to run CQR)
<p>
    <b>. cqiv alcohol logexp2 nkids (logexp = logwages nkids),</b>
        <b>confidence(weightboot) bootreps(10)</b>
<p>
    <b>. cqiv alcohol nkids (logexp = logwages nkids), corner</b>        
<p>
<p>
<b><u>Version requirements</u></b>
<p>
    This command requires Stata 10 or upper.
<p>
<p>
<b><u>Methods and Formulas</u></b>
<p>
    See Chernozhukov, Fernandez-Val and Kowalski (2010).
<p>
<p>
<b><u>References</u></b>
<p>
    Blundell, Chen and Kristensen (2007): Semi-nonparametric IV Estimation of
      Shape-Invariant Engel Curves, Econometrica, 75(6), 1613-1669.
<p>
    Chernozhukov, Fernandez-Val and Kowalski (2010): Quantile Regression with
      Censoring and Endogeneity, Boston University Department of Economics
      Working Paper 2009-012.
<p>
    Chernozhukov and Hong (2002): Three-Step Censored Quantile Regression and
      Extramarital Affairs, Journal of the American Statistical Association,
      97, 872-882.
<p>
    Kowalski (2010): Censored Quantile Instrumental Variable Estimates of the
      Price Elasticity of Expenditure on Medical Care, NBER Working Paper
      15085.
<p>
    Lee (2007): Endogeneity in Quantile Regression Models: A Control Function
      Approach, Journal of Econometrics, 141, 1131-1158.
<p>
<p>
<b><u>Remarks</u></b>
<p>
    This is a preliminary version. Please feel free to share your comments,
    reports of bugs and propositions for extensions. We thank Richard Blundell
    for sharing the data used in the examples above.  The data were derived by
    Richard Blundell from the 1995 U.K. Family Expenditure Survey (FES),
    following the criteria set forth in Blundell, Chen and Kristensen (2007).
<p>
<p>
<b><u>Disclaimer</u></b>
<p>
    THIS SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER
    EXPRESSED OR IMPLIED. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE
    OF THE PROGRAM IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU
    ASSUME THE COST OF ALL NECESSARY SERVICING, REPAIR OR CORRECTION.
<p>
    IN NO EVENT WILL THE COPYRIGHT HOLDERS OR THEIR EMPLOYERS, OR ANY OTHER
    PARTY WHO MAY MODIFY AND/OR REDISTRIBUTE THIS SOFTWARE, BE LIABLE TO YOU
    FOR DAMAGES, INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL
    DAMAGES ARISING OUT OF THE USE OR INABILITY TO USE THE PROGRAM.
<p>
<p>
<b><u>Authors</u></b>
<p>
    Victor Chernozhukov, Ivan Fernandez-Val, Sukjin Han, and Amanda Kowalski
    MIT, Boston University, and Yale University
    vchern@mit.edu / ivanf@bu.edu / sukjin.han@yale.edu /
      amanda.kowalski@yale.edu
    Latest Version: August 2011 / First Version: December 2010
<p>
</pre>