<pre>
<b>help calibrate</b>
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
    <b>calibrate</b> --  Calibrates survey datasets to population totals
<p>
<p>
<b><u>Syntax</u></b>
<p>
        <b>calibrate</b>, <b><u>mar</u></b><b>ginals</b>(<i>varlist</i>) <b><u>popt</u></b><b>ot</b>(<i>matrix</i>) <b><u>ent</u></b><b>rywt</b>(<i>varname</i>)
                  <b><u>exit</u></b><b>wt</b>(<i>varname</i>) [<i>options</i>]
<p>
<b>calibrate</b> takes a sampling weight and converts it to a calibration weight. The
variables being calibrated to are listed in <i>marginals</i>, and the population
totals used in the calibration are in a row matrix <i>poptot</i>.
<p>
    <i>options</i>                         Description
    -------------------------------------------------------------------------
    <i>Required</i>
      <b><u>ent</u></b><b>rywt(</b><i>varname</i><b>)</b>              the entry weight (selection weight)
      <b><u>exit</u></b><b>wt(</b><i>varname</i><b>)</b>               the exit (calibrated) weight
      <b><u>mar</u></b><b>ginals(</b><i>varlist</i><b>)</b>            variables used for calibration
      <b><u>popt</u></b><b>ot(</b><i>matrix</i><b>)</b>                row matrix of population totals
<p>
    <i>Options</i>
      <b><u>meth</u></b><b>od(</b><i>method</i><b>)</b>                specifies the calibration method
      <b><u>qv</u></b><b>ar(</b><i>varname</i><b>)</b>                 scaling variable (default equals 1)
      <b><u>pri</u></b><b>nt(</b><i>print</i><b>)</b>                  controls the amount of printing
      <b><u>graph</u></b><b>s(</b><i>graphs</i><b>)</b>                controls the graphs produced
      <b>outc(</b><i>varname</i><b>)</b>                 binary variable used for method <i>nonresp</i>
                                      to indicate response
      <b><u>samp</u></b><b>vars(</b><i>varlist</i><b>)</b>             additional variables used for the
                                      non-response methods
      <b><u>tol</u></b><b>erance(</b><i>real</i><b>)</b>               tolerance used in the iterative methods
                                      (<i>logistic</i> and <i>blinear</i>)
      <b>maxit(</b><i>real</i><b>)</b>                   maximum number of iterations used in the
                                      iterative methods (<i>logistic</i> and
                                      <i>blinear</i>)
      <b><u>lb</u></b><b>ound(</b><i>real</i><b>)</b>                  minmum value of the ratio <i>exitwt</i> to
                                      <i>entrywt</i> for method <i>blinear</i>
      <b><u>ub</u></b><b>ound(</b><i>real</i><b>)</b>                  maximum value of the ratio <i>exitwt</i> to
                                      <i>entrywt</i> for method <i>blinear</i>
    -------------------------------------------------------------------------
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>calibrate</b> calibrates survey datasets to external totals. Seven possible
    methods are available. The <i>linear</i> and <i>logistic</i> methods are the equivalent
    to Methods 1 and 2 of Deville and Särndal (1992).  The bounded linear
    method (<i>blinear</i>) is an iterative method that uses the linear method while
    also constraining the ratio of the exit weight to the entry weight to be
    between specified limits (c.f. Singh and Mohl, 1996).  The non-response
    methods (<i>nrSS</i>, <i>nr2A</i>, <i>nr2B</i> and <i>nr2C</i>) assume the dataset contains both
    responders and non-responders.  They calibrate the responders to
    population-level information on the variables in <i>marginals</i>, while using
    information about the selected sample on the variables in <i>sampvars</i>.
    Method <i>nrSS</i> is the single-step procedure in Chapter 8 of Särndal and
    Lundström (2005). Methods <i>nr2A</i> and <i>nr2B</i> are their two-step procedures
    with one difference: the intermediate weights obtained after the first
    step have any negative weights set to zero. Method <i>nr2C</i> is related to the
    other two-step methods. Details of method <i>nr2C</i> are available on request.
<p>
<p>
    In the special case where the calibration variables are all categorical
    and the scaling variable is a constant, the logistic method is equivalent
    to raking (Demming and Stephan, 1940). This case can also be dealt with
    using the <i>maxentropy</i> program.
<p>
    <i>entrywt</i> is the selection weight of the individual case. It will usually
    be the reciprocal of the selection probability.  If it has been scaled
    (for example to sum to the sample size) it will usually be advisable to
    rescale it to sum to the population size.  The weight <i>exitwt</i> will be
    generated (or replaced if it already exits). The population totals are
    held in the row matrix <i>poptot</i>. The calibration variables (<i>marginals</i>)
    should be numeric. Categorical variables will usually need to be
    converted to indicator variables.
<p>
<b><u>Options</u></b>
<p>
    <b><u>meth</u></b><b>od(</b><i>method</i><b>)</b> specifies the calibration method. <i>linear</i> is the default.
        Other methods are <i>logistic</i>, <i>blinear</i>, or the non-response methods:
        <i>nrSS</i>, <i>nr2A</i>, <i>nr2B</i> and <i>nr2C</i>.
<p>
    <b><u>qv</u></b><b>ar(</b><i>varname</i><b>)</b> is related to the importance of the observation. See
        (Deville and Särndal, 1992) for further details.  When using one of
        the non-response methods, it is usually advisable to use the default
        value of <i>qvar</i>.
<p>
    <b><u>pri</u></b><b>nt(</b><i>print</i><b>)</b> controls the amount of printing. Options are <i>none</i> (the
        default), <i>final</i> (which summarises the final weights) and <i>all</i> (which
        summarises the weights after each iteration). When the method is
        <i>linear</i> or <i>nonresp</i> the options <i>final</i> and <i>all</i> are equivalent.
<p>
    <b><u>graph</u></b><b>s(</b><i>graphs</i><b>)</b> controls the number of graphs produced. Options are <i>none</i>
        (the default), <i>final</i> (which produces a histogram of the exit weight)
        and <i>all</i>. The option <i>all</i> produces two additional graphs: a scatterplot
        of the exit weight against the entry weight, and a histogram either
        of the ratio of the exit weight to the entry weight (for methods
        <i>linear</i>, <i>blinear</i> or <i>nonresp</i>) or of the logarithm of the ratio of the
        exit weight to the entry weight (for method <i>logistic</i>).
<p>
<p>
    <b>outc(</b><i>varname</i><b>)</b> is a binary variable equal to 1 if the case corresponds to
        a responder and 0 otherwise.  This is required when a non-response
        method is used and is ignored otherwise.
<p>
    <b><u>samp</u></b><b>vars(</b><i>varlist</i><b>)</b> is a list of variables that are available on the
        complete sample, both responders and non-reponders.  This is required
        when a non-response method is used and is ignored otherwise.
        Variables in <i>marginals</i> should not be included in <i>sampvars</i>.
<p>
    <b><u>tol</u></b><b>erance(</b><i>real</i><b>)</b> specifies the tolerance for the iterative methods.
<p>
    <b>maxit(</b><i>real</i><b>)</b> specifies the maximum number of iterations to be used by the
        iterative methods. The default is 15.
<p>
    <b><u>lb</u></b><b>ound(</b><i>real</i><b>)</b> Puts a lower bound on the ratio <i>exitwt</i> to <i>entrywt</i> for method
        <i>blinear</i>. The default is 0.2.
<p>
    <b><u>ub</u></b><b>ound(</b><i>real</i><b>)</b> Puts an upper bound on the ratio <i>exitwt</i> to <i>entrywt</i> for
        method <i>blinear</i>. The default is 5.
<p>
<p>
<p>
<b><u>Warnings and problems</u></b>
<p>
    Calibration can result in negative weights. If this happens <b>calibrate</b>
    will give a warning. (Note that the method <i>logistic</i> ensures that
    calibration weights are positive). It will also give a warning if the
    calibration matrix is found to be singular.  This is usually a
    consequence of collinearity among the marginal variables and the solution
    is usually to re-calibrate after omitting variables.
<p>
    Note also that there is no guarantee that a solution to the calibration
    equations exits.
<p>
    It is also worth noting that the method <b>calibrate</b> uses to solve the
    calibration equations involves calculating the inverse of a matrix using
    the command <i>invsym</i>.  This limits the number of calibration constraints
    that can be used to the maximum size of the matrix.  There could also be
    some problems if the problem is almost singular.
<p>
    A further problem might occur when using the logistic method. This method
    uses Newton-Raphson to solve the calibration equations, and might fail to
    converge, especially if the initial estimate is not close to the
    solution. The initial estimate <b>calibrate</b> uses is calculated from the
    selection weights. Newton-Raphson might fail if the selection weights
    have been scaled (for example to sum to the sample size).  Rescaling them
    to sum to the population size will sometimes be a solution.
<p>
<p>
<b><u>Examples</u></b>
<p>
    To calibrate the <b>multistage</b> dataset. The population consists of 8,000,000
    high school seniors. Assume it is known that it is 50% male and 50%
    female, and contains 7,000,000 white seniors.
<p>
        <b>. use http://www.stata-press.com/data/r9/multistage</b>
<p>
    Convert the categorical variables <b>sex</b> and <b>race</b> into binary indicator
    variables.
<p>
        <b>. tab sex, gen(isex)</b>
        <b>. tab race, gen(irace)</b>
<p>
    Make a row matrix of popultaion totals (male, female, white).
<p>
        <b>. matrix M=[4000000, 4000000, 7000000]</b>
<p>
    An example of linear calibration creating an exit weight called wt1:
<p>
        <b>. calibrate , marginals(isex1 isex2 irace1) poptot(M)</b>
            <b>entrywt(sampwgt) exitwt(wt1)</b>
<p>
    An example of linear calibration with additional printing:
<p>
        <b>. calibrate , marginals(isex1 isex2 irace1) poptot(M)</b>
            <b>entrywt(sampwgt) exitwt(wt1) print(all) graphs(all)</b>
<p>
    To check that the weighted sex and race distributions are correct:
<p>
        <b>. tab sex [iweight=wt1]</b>
        <b>. tab race [iweight=wt1]</b>
<p>
    It is possible to calibrate to continuous variables. Suppose it is also
    known that the average weight is 160lbs (so the total weight is
    1,280,000,000lbs).
<p>
        <b>. matrix M=[4000000, 4000000, 7000000, 1280000000]</b>
<p>
    Linear, logistic or bounded linear calibration can be used. An example of
    logistic (with printing turned on) is:
<p>
        <b>. calibrate , marginals(isex1 isex2 irace1 weight) poptot(M)</b>
            <b>entrywt(sampwgt) exitwt(wt2) method(logistic) print(all)</b>
<p>
    Checks:
<p>
        <b>. tab sex [iweight=wt2]</b>
        <b>. tab race [iweight=wt2]</b>
        <b>. summ weight [iweight=wt2]</b>
<p>
<p>
<b><u>Saved results</u></b>
<p>
    <b>calibrate</b> saves the following in <b>r()</b>:
<p>
    Scalars        
      <b>r(N)</b>                number of observations
      <b>r(mean)</b>             mean exit weight
      <b>r(min)</b>              minimum exit weight
      <b>r(max)</b>              maximum exit weight
      <b>r(entdeff)</b>          approximate design effect (one plus the coefficient
                            of variation) of the entry weights
      <b>r(exitdeff)</b>         approximate design effect (one plus the coefficient
                            of variation) of the exit weights
      <b>r(sclmin)</b>           minimum exit weight after re-scaling to have a mean
                            of one
      <b>r(sclmax)</b>           maximum exit weight after re-scaling to have a mean
                            of one
      <b>r(sclsd)</b>            standard deviation of exit weights after re-scaling
                            to have a mean of one
<p>
<p>
    Matrices       
      <b>r(Bhat)</b>             coefficients of the variables in <i>marginals</i> used in
                            the equation calculating the exit weight
<p>
<p>
<b><u>Also see</u></b>
<p>
Calibration can be thought of as a generalisation of post-stratification. The p
&gt; rogram <b>calibest</b> generalises Stata's post-stratification
estimation commands.
<p>
<p>
<b><u>References</u></b>
<p>
    Deming, W. E., and F. F. Stephan.  1940.  On a least squares adjustment
        of a sample frequency table when the expected marginal totals are
        known.  <i>Annals of Mathematical Statistics</i> 11: 427-444.
<p>
    Deville, J.-C., and C.-E. Särndal.  1992.  Calibration estimators in
        survey sampling.  <i>Journal of the American Statistical Association</i> 87:
        376-382.
<p>
    Särndal, C.-E., and S. Lundström.  2005.  {it Estimation in Surveys with
        Nonresponse} New York, Wiley.
<p>
    Singh, A., C. and C. A. Mohl.  1996. Understanding calibration estimators
        in survey sampling <i>Survey Methodology</i> 22: 107-115.  Chichester, UK:
        Wiley.
<p>
<p>
<b><u>Author</u></b>
<p>
    John D'Souza
    National Centre for Social Research
    London, England, UK
    John.D'Souza@natcen.ac.uk
<p>
<p>
<p>
</pre>