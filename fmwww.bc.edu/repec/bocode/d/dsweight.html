<pre>
-------------------------------------------------------------------------------
help for <b>dsweight</b> and <b>scdsweight</b>                                 (Roger Newson)
-------------------------------------------------------------------------------
<p>
<b><u>Generate direct standardization weights for input to estimation commands</u></b>
<p>
        <b>dsweight</b> <i>stanvarlist</i> [<i>if</i>] [<i>in</i>] [<i>weight</i>] <b>using</b> <i>filename</i> ,
                     <b><u>g</u></b><b>enerate(</b><i>newvarname</i><b>)</b> [
                     <b><u>gr</u></b><b>oupvars(</b><i>varlist</i><b>)</b> <b>by(</b><i>varlist</i><b>)</b> <b><u>noco</u></b><b>mplete</b> <b><u>m</u></b><b>issing</b>
                     <b><u>tfr</u></b><b>eqvar(</b><i>varname</i><b>)</b> <b>sorted</b> <b>float</b> <b>fast</b> ]
<p>
        <b>scdsweight</b> <i>stanvarlist</i> [<i>if</i>] [<i>in</i>] [<i>weight</i>] <b>using</b> <i>filename</i> ,
                     <b><u>g</u></b><b>enerate(</b><i>newvarname</i><b>)</b> <b><u>sc</u></b><b>envar(</b><i>varname</i><b>)</b> [
                     <b>by(</b><i>varlist</i><b>)</b> <b><u>noco</u></b><b>mplete</b> <b><u>m</u></b><b>issing</b>
                     <b><u>tfr</u></b><b>eqvar(</b><i>varname</i><b>)</b> <b>sorted</b> <b>float</b> <b>fast</b> ]
<p>
    where <i>stanvarlist</i> is a <i>varlist</i> specifying a list of standardization
    variables.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>dsweight</b> generates direct standardization weights for input as pweights
    to estimation commands, standardizing the joint distribution of a list of
    standardization variables to a standard target population, possibly
    within groups defined by value combinations of a list of group variables.
    A direct standardization weight is defined as a ratio between the
    frequency of a combination of values of standardization variables in a
    target standard population and the frequency of the same combination of
    values of standardization variables in the sample or group.  The standard
    target population may be the full sample, or a by-group defined by a
    combination of values of by-variables, or it may be defined using a
    dataset with 1 observation per combination of the group variables, and
    data on the frequencies of these combinations in the standard target
    population.  <b>scdsweight</b> is a version of <b>dsweight</b> for generating scenario
    direct standardization weights, which can be input as scenario weights to
    the SSC package <b>scsomersd</b>.
<p>
<p>
<b><u>Options for </u></b><b><u>dsweight</u></b><b><u> and </u></b><b><u>scdsweight</u></b>
<p>
    <b>generate(</b><i>newvarname</i><b>)</b> must be present.  It specifies the name of a new
        variable to be generated, containing the direct standardization
        weights.
<p>
    <b>groupvars(</b><i>varlist</i><b>)</b> (<b>dsweight</b> only) specifies a list of variables, whose
        value combinations will be groups, within which the joint
        distribution of the standardization variables in the <i>stanvarlist</i> will
        be standardized, using the sampling probability weights, to the joint
        distribution of the standardization variables in the target
        population.  If <b>groupvars()</b> is absent, then the standardization
        weights will standardize the joint distribution of the
        standardization variables in the full input sample to the standard
        target population.  The full input sample is the set of all
        observations in the dataset (or in the by-group if <b>by()</b> is specified)
        for which the values of all standardization variables and all group
        variables are non-missing, and which are not excluded by the <b>if</b>
        and/or <b>in</b> qualifiers.
<p>
    <b>scenvar(</b><i>varname</i><b>)</b> (<b>scdsweight</b> only) specifies a binary scenario-indicator
        variable, with values 0 and 1, indicating that an observation is
        present in a scenario, for which the scenario direct standardization
        weights will be calculated.  These scenario direct standardization
        weights are equal to zero for observations not in the scenario, and
        equal to direct standardization weights for observations in the
        scenario, standardizing the distribution of the standardization
        variables for observations in the scenario to the standard
        population.  These scenario direct standardization weights may be
        input, as scenario-specific weights, to the <b>scsomersd</b> package,
        downloadable from SSC.  The <b>scsomersd</b> package uses rank methods to
        compare the distributions of outcomes between scenarios.  An example
        of a scenario-comparison rank statistic is the population
        attributwble risk, which may be either crude or age-standardized.
<p>
    <b>by(</b><i>varlist</i><b>)</b> specifies a list of by-variables, whose combinations (missing
        or non-missing) specify the by-groups.  The standardization weights
        are calculated independently within each by-group.  If a <b>using</b>
        dataset is specified, then the by-variables must be present in this
        <b>using</b> dataset, and, together with the standardization variables, they
        must uniquely identify the observations in the <b>using</b> dataset.  If a
        <b>using</b> dataset is not specified, then the generated standardization
        weights will standardize the joint distribution of the
        standardization variables to the subset of the total sample within
        each by-group.
<p>
    <b>nocomplete</b> specifies that each group specified by the <b>groupvars()</b> option
        (or the scenario specified by the <b>scenvars()</b> option) does not have to
        contain the full list of value combinations of the standardization
        variables.  If <b>nocomplete</b> is absent, then <b>dsweight</b> and <b>scdsweight</b>
        checks that each combination of values of the standardization
        variables (within each by-group if <b>by()</b> is specified) is present in
        each combination of values of the <b>groupvars()</b> variables, or in the
        scenario specified by the <b>scenvar()</b> variable, within each by-group if
        <b>by()</b> is specified.  If this condition is not met, then <b>dsweight</b> or
        <b>scdsweight</b> will fail.
<p>
    <b>missing</b> specifies that the generated standardization weights, in the
        variable named by <b>generate()</b>, may have missing values in the input
        sample, even if the group (or scenario) variables and standardization
        variables are non-missing.  This may be because the sum of weights in
        the sample, group or scenario is zero, or because a <b>using</b> dataset is
        specified and does not contain an observation with the current
        combination of the standardization variables.  If <b>missing</b> is not
        specified, and some standardization weights in the input sample are
        missing, then <b>dsweight</b> or <b>scdsweight</b> will fail.
<p>
    <b>tfreqvar(</b><i>varname</i><b>)</b> specifies the name of a variable, in the <b>using</b> dataset,
        containing the frequencies (or sums of weights) of the corresponding
        combination of standardization variables in the standard target
        population.  If <b>tfreqvar()</b> is not specified, and a <b>using</b> dataset is
        specified, then <b>dsweight</b> or <b>scdsweight</b> looks for a variable named
        <b>_freq</b>.  Such a variable will usually be present if the <b>using</b> dataset
        has been created by the Stata command <b>contract</b>, or by the SSC package
        <b>xcontract</b>.
<p>
    <b>sorted</b> functions as the option of the same name for <b>merge</b>.  It specifies
        that the observations in the <b>using</b> dataset are already sorted by the
        standardization variables (or by the by-variables and the
        standardization variables if <b>by()</b> is specified), so there is no need
        for Stata to sort them before use.  This may save some computational
        time.
<p>
    <b>float</b> specifies that the output variable specified by <b>generate()</b> will be
        of storage type <b>float</b> or lower.  If <b>float</b> is not specified, then the
        output variable will be generated as type <b>double</b>.  Note that the
        output variable will be compressed after being generated (using 
        <b>compress</b>) to the lowest type possible without loss of precision,
        whether or not the user specifies <b>float</b>.
<p>
    <b>fast</b> is an option for programmers.  It specifies that <b>dsweight</b> or
        <b>scdsweight</b> will take no action to restore the existing dataset in
        memory in the event of failure, or if the user presses Break.  If
        <b>fast</b> is not specified, then <b>dsweight</b> and <b>scdsweight</b> will take this
        action, which uses an amount of time depending on the size of the
        dataset in memory.
<p>
<p>
<b><u>Remarks</u></b>
<p>
    <b>dsweight</b> works on the same principle as <b>dstdize</b>.  However, <b>dsweight</b>
    creates weights that can be input to estimation commands as <b>pweights</b>, in
    order to estimate a wide range of directly-standardized parameters (not
    only rates and proportions).  <b>scdsweight</b> is intended for use with the 
    <b>scsomersd</b> package, which the user can download from SSC, and which
    calculates rank statistics for comparing scenarios.  The user must also
    download the SSC packages <b>somersd</b> and <b>expgen</b>, if <b>scsomersd</b> is to work.
<p>
<p>
<b><u>Examples</u></b>
<p>
    The following examples make use of the <b>xcontract</b> command, which can be
    downloaded from SSC, and is an extended version of <b>contract</b>.
<p>
    Set-up:
<p>
        <b>. use http://www.stata-press.com/data/r11/lbw.dta, clear</b>
        <b>. gene agegp=age</b>
        <b>. recode agegp (0/19=1) (20/29=2) (30/max=3)</b>
        <b>. lab def agegp 1 "&lt;20" 2 "20-29" 3 "30+"</b>
        <b>. lab val agegp agegp</b>
        <b>. lab var agegp "Age group"</b>
        <b>. describe</b>
        <b>. tab agegp, m</b>
<p>
    The following example creates and lists standardization weights,
    standardizing the children of smoking and non-smoking mothers to the age
    group distribution in the total sample, and then uses <b>regress</b>, with the
    standardization weights as sampling probability weights, to estimate an
    effect of maternal smoking on birth weight, standardized by age group.
    We then use <b>censlope</b>, part of the SSC package <b>somersd</b>, to estimate an
    age-standardized median difference in birth weight between the babies of
    smoking and non-smoking mothers.
<p>
        <b>. dsweight agegp, groupvars(smoke) gene(swei1)</b>
        <b>. xcontract smoke agegp swei1, list(, abbr(32) sepby(smoke))</b>
        <b>. regress bwt smoke [pweight=swei1]</b>
        <b>. censlope bwt smoke [pweight=swei1], transf(z) tdist</b>
<p>
    The following example creates a dataset <b>agpfreq1</b>, with 1 observation per
    maternal age group and data on the frequencies of that maternal age group
    in the children of non-smoking mothers.  We then use <b>dsweight</b> to create
    sampling probability weights, standardizing the children of smokers and
    non-smokers to the maternal age group distribution of non-smokers, and
    display these weights using <b>xcontract</b>.  We then use <b>regress</b> to estimate
    the effect of smoking, in a hypothetical population, where smoking and
    non-smoking mothers have the age distribution of non-smokers in the
    sample.  Finally, we use <b>censlope</b> to estimate an age-standardized median
    difference in birth weight between the babies of smoking and non-smoking
    mothers.
<p>
        <b>. xcontract agegp if smoke==0, list(, abbr(32)) saving(agpfreq1,</b>
            <b>replace)</b>
        <b>. dsweight agegp using agpfreq1, groupvars(smoke) gene(swei2)</b>
        <b>. xcontract smoke agegp swei2, list(, abbr(32) sepby(smoke))</b>
        <b>. regress bwt smoke [pweight=swei2]</b>
        <b>. censlope bwt smoke [pweight=swei2], transf(z) tdist</b>
<p>
    The following example demonstrates the use of the <b>scdsweight</b> module to
    compute scenario direct standardization weights for use with the 
    <b>scsomersd</b> package, downloadable from SSC.  We define a scenario indicator
    variable <b>nonsmoke</b>, indicating that a subject is a non-smoker.  We then
    use <b>scsomersd</b> to define scenario direct-standardization weights, stored
    in a new variable <b>swei3</b>, and equal to age-standardization weights for
    children of non-smokers and to zero for children of smokers.  We then use
    <b>scsomersd</b> to compare two scenarios, the real-world scenario and a fantasy
    scenario where all mothers are non-smoking and the age-group distribution
    stays the same, and estimate a population attributable risk, equal to the
    difference between the proportions of babies with low birth weight in the
    real-world scenario and in the fantasy scenario.
<p>
        <b>. gene nonsmoke=1-smoke</b>
        <b>. scdsweight agegp, scenvar(nonsmoke) gene(swei3)</b>
        <b>. xcontract smoke nonsmoke agegp swei3, list(, abbr(32) sepby(smoke))</b>
        <b>. scsomersd low [pwei=1], sweight(swei3) transf(z) tdist</b>
<p>
<p>
<b><u>Author</u></b>
<p>
    Roger Newson, National Heart and Lung Institute, Imperial College London,
    UK.
    Email: r.newson@imperial.ac.uk
<p>
<p>
<b><u>Also see</u></b>
<p>
     Manual: <b>[D] merge</b>, <b>[D] contract</b>, <b>[R] dstdize</b>
    On-line: help for <b>merge</b>, <b>contract</b>, <b>dstdize</b>
             help for <b>xcontract</b>, <b>somersd</b>, <b>censlope</b>, <b>scsomersd</b>, <b>expgen</b> if
             installed
</pre>