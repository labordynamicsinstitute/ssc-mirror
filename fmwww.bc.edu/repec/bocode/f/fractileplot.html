<pre>
-------------------------------------------------------------------------------
help for <b>fractileplot</b>
-------------------------------------------------------------------------------
<p>
<b><u>Smoothing with respect to distribution function predictors</u></b>
<p>
        <b>fractileplot</b> <i>yvar xvarlist</i> [<i>if</i>] [<i>in</i>] [<b>,</b> <b>a(</b><i>#</i><b>)</b> <b>combine(</b><i>combine_options</i><b>)</b>
            <b><u>cyc</u></b><b>les(</b><i>#</i><b>)</b> <b><u>dr</u></b><b>aw(</b><i>numlist</i><b>)</b> <b><u>gen</u></b><b>erate(</b><i>stub</i><b>)</b> <b>nograph</b>
            <b>locpoly</b>[<b>(</b><i>locpoly_options</i><b>)</b>] <b>log</b> <b>lowess(</b><i>lowess_options</i><b>)</b>
            <b><u>om</u></b><b>it(</b><i>numlist</i><b>)</b> <b><u>p</u></b><b>redict(</b><i>newvar</i><b>)</b> <b><u>nopt</u></b><b>s</b> <b>replace</b>
            <b><u>sc</u></b><b>atter(</b><i>scatter_options</i><b>)</b> <i>line_options</i>]
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>fractileplot</b> computes smooths of <i>yvar</i> on all predictors in <i>xvarlist</i>
    simultaneously; that is, each smooth is adjusted for the others.  Each
    predictor x_j is treated on the scale of its distribution function,
    F(x_j), estimated for a sample of n as (rank of x_j - a) / (n - 2a + 1).
    a defaults to 0.5. By default smoothing is with <b>lowess</b>. Optionally
    smoothing may be with <b>locpoly</b>, so long as that has been installed.
    Fitted values may be saved in new variables with names beginning with
    <i>stub</i>, as specified in the <b>generate()</b> option.
<p>
    By default, for each <i>xvar</i> in <i>xvarlist</i> adjusted values of <i>yvar</i> and the
    smooth for F(<i>xvar</i>) are plotted against F(<i>xvar</i>).  See <b>Remarks</b> for more
    details.
<p>
<p>
<b><u>Options</u></b> 
<p>
    <b>a(</b><i>#</i><b>)</b> specifies a in the formula for F.  The default is a = 0.5, giving (i
        - 0.5) / n. Other choices include a = 0, giving i / (n + 1), and a =
        1/3, giving (i - 1/3) / (n + 1/3). More discussion on this is
        available at http://www.stata.com/support/faqs/stat/pcrank.html.
<p>
    <b>combine(</b><i>combine_options</i><b>)</b> specifies any of the options allowed by the 
        <b>graph combine</b> command.  Useful examples are <b>combine(ycommon)</b> and
        <b>combine(saving(</b><i>graphname</i><b>))</b>.
<p>
    <b>cycles(</b><i>#</i><b>)</b> sets the number of cycles. The default is <b>cycles(3)</b>.
<p>
    <b>draw(</b><i>numlist</i><b>)</b> specifies that smooths for a subset of the variables in
        <i>xvarlist</i> be plotted. The elements of <i>numlist</i> are indexes determined
        by the order of the variables in <i>xvarlist</i>.  For example, <b>fractileplot</b>
        <b>y x1 x2 x3, draw(2 3)</b> would plot smooths only for F(<b>x2</b>) and F(<b>x3</b>). By
        default results for all variables in <i>varlist</i> are plotted. <b>draw()</b>
        takes precedence over <b>omit()</b> in the sense that results for variables
        included (by index) in <i>numlist</i> are plotted, even if they are excluded
        by <b>omit()</b>. See also <b>omit()</b>.
<p>
    <b>generate(</b><i>stub</i><b>)</b> specifies that fitted values for each member of <i>xvarlist</i>
        be saved in new variables with names beginning with <i>stub</i>.
<p>
    <b>nograph</b> suppresses the graph.
<p>
    <b>locpoly</b> specifies that <b>locpoly</b> (Gutierrez, Linhart and Pitblado 2003,
        2005a, 2005b) should be used for smoothing. This should be installed
        beforehand. <b>locpoly</b> may be specified with options. Key are
<p>
        <b><u>d</u></b><b>egree(</b><i>#</i><b>)</b> specifies the degree of the polynomial to be used in the
        smoothing.  Zero is the default, meaning local mean smoothing.
<p>
        <b><u>w</u></b><b>idth(</b><i>#</i><b>)</b> specifies the halfwidth of the kernel, the width of the
        smoothing window around each point.  If <b>width()</b> is not specified,
        then the "default" width is used; see <b>[R] kdensity</b>.  This default is
        entirely inappropriate for local polynomial smoothing.  Choose your
        own.
<p>
        <b><u>ep</u></b><b>anechnikov</b>, <b><u>bi</u></b><b>weight</b>, <b><u>cos</u></b><b>ine</b>, <b><u>gau</u></b><b>ssian</b>, <b><u>par</u></b><b>zen</b>, <b><u>rec</u></b><b>tangle</b>, and
        <b><u>tri</u></b><b>angle</b> specify the kernel.  By default, <b>epanechnikov</b>, meaning the
        Epanechnikov kernel, is used.
<p>
    <b>log</b> displays the squared correlation coefficient between the overall
        fitted values and <i>yvar</i> at each cycle for monitoring convergence.
        This option is provided mainly for pedagogic interest.
<p>
    <b>lowess(</b><i>lowess_options</i><b>)</b> control the operation of <b>lowess</b> in generating
        smooths. Key are
<p>
        <b><u>m</u></b><b>ean</b> specifies running-mean smoothing; the default is running-line
        least-squares smoothing.
<p>
        <b><u>now</u></b><b>eight</b> prevents the use of Cleveland's tricube weighting function;
        the default is to use the weighting function.
<p>
        <b><u>bw</u></b><b>idth(</b><i>#</i><b>)</b> specifies the bandwidth.  Centred subsets of <b>bwidth()</b> * n
        observations are used for calculating smoothed values for each point
        in the data except for end points, where smaller, uncentred subsets
        are used.  The greater the <b>bwidth()</b>, the greater the smoothing.  The
        default is 0.8.
<p>
    <b>omit(</b><i>numlist</i><b>)</b> specifies that smooths for a subset of the variables in
        <i>xvarlist</i> not be plotted. The elements of <i>numlist</i> are indexes
        determined by the order of the variables in <i>varlist</i>. For example,
        <b>fractileplot y x1 x2 x3, omit(3)</b> would plot smooths only for F(<b>x1</b>)
        and F(<b>x2</b>). By default results for no variables in <i>varlist</i> are
        omitted.  <b>draw()</b> takes precedence over <b>omit()</b>.  See also <b>draw()</b>.
<p>
    <b>predict(</b><i>newvar</i><b>)</b> specifies that the predicted values be saved in new
        variable <i>newvar</i>.
<p>
    <b>nopts</b> suppresses the points in the plots. Only the lines representing the
        smooths are drawn.
<p>
    <b>replace</b> allows variables specified by any of the <b>generate()</b> and <b>predict()</b>
        options to be replaced if they already exist.
<p>
    <b>scatter(</b><i>scatter_options</i><b>)</b> specifies any of the options allowed by the 
        <b>scatter</b> command.  These should be specified to control the rendering
        of the data points.  The default includes <b>msymbol(oh)</b>, or <b>msymbol(p)</b>
        with over 299 observations.
<p>
    <i>line_options</i> are any of the options allowed with <b>line</b>.  These should be
        specified to control the rendering of the smoothed lines or the
        overall graph.
<p>
<p>
<b><u>Remarks</u></b>
<p>
    Smoothing with respect to distribution functions has various elementary
    attractions. An F scale provides a common scale for variables with
    different level and spread and even different units.  Subject to the
    occurrence of ties, values are equally spaced on the F scale and so in
    good condition for smoothing. This can be especially useful when
    predictors are highly skewed.  F is invariant under strictly increasing
    transformations, so that for example F(log x) is identical to F(x) so
    long as x &gt; 0. This can be useful when it is not clear whether predictors
    should be transformed.
<p>
    Sen (2005) gives a useful recent account of kernel smoothing of responses
    with respect to distribution functions of predictors. The canonical
    reference is Mahalanobis (1960), which introduced the term "fractile
    graphical analysis". Mahalanobis plotted means of one variable for bins
    defined by selected fractiles of the other variable.  Binning and
    averaging now appear arbitrary and awkward, and some kind of kernel-based
    smoothing is more appealing. The approach in <b>fractileplot</b> is based on
    methodology for generalised additive models (Hastie and Tibshirani 1990).
<p>
    Terminology is problematic here.  Terms such as "fractile graph" (Sen
    2005) and "fractile plot" (Nordhaus 2006) persist in recent literature
    for modern versions of Mahalanobis' plots, even though neither ordinate
    nor abscissa in the resulting graphs is a fractile.  The term "fractile"
    was introduced to the English literature by Hald (1952) with the sense of
    "quantile", but it has never supplanted "quantile" and is often
    misunderstood to mean fraction or cumulative probability or plotting
    position (e.g. Nordhaus 2006). Hald used "fractile diagram" for normal
    probability plots - in Stata terms, his examples are equivalent to <b>qnorm</b>
    with axes reversed - and this usage also continues in recent literature
    (e.g. Blæsild and Granfeldt 2003). In the absence of an obvious
    alternative, customary terminology is used here under protest.
<p>
    An R-square (squared correlation coefficient) is provided as a goodness
    of fit indicator. However, this R-square can typically be increased
    simply by just smoothing less, which is often likely to be unhelpful. As
    the resulting predictions come closer to interpolating the data, R-square
    will approach 1, but scientific usefulness and the possibility of insight
    will usually diminish.
<p>
    Note that you do not need the machinery here to do this for just one
    predictor. The following is a basic recipe:
<p>
        <b>. gen touse = (</b><i>y</i><b> &lt; .) &amp; (</b><i>x</i><b> &lt; .)</b>
        <b>. egen abscissa = rank(</b><i>x</i><b>) if touse</b>
        <b>. count if touse</b>
        <b>. replace abscissa = (abscissa - 0.5) / r(N)</b>
        <b>. lowess </b><i>y</i><b> abscissa, xti("fraction of data")</b>
<p>
    Suppose that there are p &gt;= 1 predictors.  <b>fractileplot</b> estimates the
    smooths f_1,...,f_p by using a backfitting algorithm and a lowess or
    local polynomial smoother S[y|F(x_j)] for each predictor, as follows:
<p>
    1.  Initialize: alpha = mean(<i>yvar</i>), f_1,...,f_p estimated by multiple
        linear regression.
<p>
    2.  Cycle: j = 1,...,p, 1,...,p, ...
<p>
        f_j = S[y - alpha - sum_{i != j} f_i|F(x_j)]
<p>
    3.  Continue for <b>cycles()</b> rounds.
<p>
    No convergence criterion is applied. In practice, three cycles are
    usually more than sufficient to get results adequate for exploratory
    work.
<p>
    The smooths are adjusted so that the mean of each equals the mean of
    <i>yvar</i>.
<p>
    The points in the plots provided by <b>fractileplot</b> depict y - sum_{i != j}
    f_i|F(x_j), i.e., the partial residuals plus alpha.
<p>
<p>
<b><u>Examples</u></b> 
<p>
    <b>. fractileplot mpg weight displ length</b>
<p>
    <b>. fractileplot mpg weight displ length, lowess(mean)</b>
<p>
    <b>. fractileplot mpg weight displ length, locpoly(degree(1) biweight</b>
        <b>width(0.4))</b>
<p>
    <b>. fractileplot mpg weight displ length, generate(S) nograph</b>
<p>
    <b>. fractileplot mpg weight displ length, omit(2) combine(saving(graph1))</b>
<p>
    For comparison, bivariate smooths may be compared like this:
<p>
    <b>. foreach v in weight displ length {</b>
    <b>.         fractileplot mpg `v', combine(saving(fl_`v'))</b>
    <b>. }</b>
    <b>. graph combine "fl_weight" "fl_displ" "fl_length"</b>
<p>
<p>
<b><u>Author</u></b> 
<p>
    Nicholas J. Cox
    Durham University
    n.j.cox@durham.ac.uk
<p>
<p>
<b><u>Acknowledgements</u></b> 
<p>
    The main features of the implementation here depend on the work of
    Patrick Royston, as reported by Royston and Cox (2005).
<p>
<p>
<b><u>References</u></b>
<p>
    Blæsild, P. and Granfeldt, J. 2003.  <i>Statistics with applications in</i>
        <i>geology and biology.</i>  Boca Raton, FL: Chapman &amp; Hall/CRC.
<p>
    Gutierrez, R.G., Linhart, J.M. and Pitblado, J.S. 2003.  From the help
        desk: Local polynomial regression and Stata plugins.  <i>Stata Journal</i>
        3(4): 412-419. Software Updates: 2005a. 5(1): 139 and 2005b. 5(2):
        285.
<p>
    Hald, A. 1952.  <i>Statistical theory with engineering applications.</i>  New
        York: John Wiley.
<p>
    Hastie, T. and Tibshirani, R. 1990.  <i>Generalized additive models.</i>
        London: Chapman and Hall.
<p>
    Mahalanobis, P.C. 1960. A method of fractile graphical analysis.
        <i>Econometrica</i> 28: 325-351. Reprinted 1961.  <i>Sankhya</i> Series A 23:
        41-64.
<p>
    Nordhaus, W.D. 2006. Geography and macroeconomics: new data and new
        findings. <i>Proceedings, National Academy of Sciences</i> 103(10):
        3510-3517.
<p>
    Royston, P. and Cox, N.J. 2005.  A multivariable scatterplot smoother.
        <i>Stata Journal</i> 5(3): 405-412.
<p>
    Sen, B. 2005. Estimation and comparison of fractile graphs using kernel
        smoothing techniques. <i>Sankhya</i> 67: 305-334.  
        http://sankhya.isical.ac.in/search/67_2/2005014.pdf
<p>
    Note: <i>Sankhya</i> should carry a bar accent on its final "a".
<p>
<p>
<b><u>Also see</u></b>
<p>
    Online:  <b>lowess</b>, <b>locpoly</b> (if installed)
<p>
</pre>