<pre>
-------------------------------------------------------------------------------
help for <b>funnelcompar</b>                                 (Silvia Forni, Rosa Gini)
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
    <b>funnelcompar</b>   Funnel plot for institutional comparison
<p>
<b><u>Syntax</u></b>
<p>
        <b>funnelcompar</b> <i>value pop unit [sdvalue]</i> [<i>if</i>] [<i>in</i>] <b>,</b>
             <b><u>cont</u></b><b>inuous/</b><b><u>binom</u></b><b>ial/</b><b><u>pois</u></b><b>son</b> [<b>smr</b>] [ <i>options</i>]
<p>
    <i>options</i>                       Description
    -------------------------------------------------------------------------
    Distribution (mandatory)
      <b><u>cont</u></b><b>inuous</b>                  normal distribution
      <b><u>binom</u></b><b>ial</b>                    binomial distribution
      <b><u>pois</u></b><b>son</b>                     Poisson distribution
      <b>smr</b>                         values are indirectly standardised rates
<p>
    Distribution parameters
      <b><u>nowei</u></b><b>ght</b>                    specify that target value and/or standard
                                    deviation of the target distribution must
                                    be computed from the data, but without
                                    using <i>pop</i> as weights
      <b>ext_stand(</b><i>num</i><b>)</b>              specify target value as an external
                                    standard, instead of weighted mean of
                                    <i>value</i>
      <b>ext_sd(</b><i>num</i><b>)</b>                 specify standard deviation as an external
                                    value, instead of weighted mean of
                                    <i>sdvalue</i>
<p>
    Contours
      <b><u>c</u></b><b>ontours(</b><i>numlist</i><b>)</b>            specify significance levels (in
                                    percentage) of the contours to be
                                    plotted; default is 5% and 0.2%, that is
                                    c(5 .2)
 
      <b><u>exac</u></b><b>t</b>                        specify that contours are computed using
                                    an exact formula instead of the normal
                                    approximation (only valid for discrete
                                    distributions; implies Stata version
                                    10.0)
      <b><u>contcol</u></b><b>or(</b><i>color</i><b>)</b>            specify colour of the contour lines if
                                    <b>shadedcontours</b> is not specified
      <b><u>shadedc</u></b><b>ontours</b>               specify shaded, instead of black, contour
                                    lines
      <b><u>solidc</u></b><b>ontours</b>                specify solid, instead of dashed, contour
                                    lines
<p>
    Constant
      <b><u>const</u></b><b>ant(</b><i>num</i><b>)</b>               contains the multiplicative constant by
                                    which the indicators contained in <i>value</i>
                                    are multiplied, e.g. 100 if they are
                                    percentages
<p>
    Legend
      <b><u>legendcont</u></b><b>our</b>               specify that contours should be labeled
                                    with labels of the form "Sign. 5%"
 
      <b><u>legendmor</u></b><b>e(</b><i>options</i><b>)</b>         specify any additional graph to be labeled;
                                    the <i>options</i> string must be contained in
                                    compound double quotes, e.g. `"3 "lower
                                    bound""'
 
      <b><u>legend</u></b><b>options(</b><i>options</i><b>)</b>      specify any <b>legend_options</b>
 
<p>
<p>
    Marking options: principal scatter
      <b><u>scattercol</u></b><b>or(</b><i>color</i><b>)</b>         colour of scatter points
      <b><u>scatter</u></b><b>opts(</b><i>options</i><b>)</b>        other <b>marker_options</b>
      <b><u>unitlab</u></b><b>el(</b><i>string</i><b>)</b>           string to be used in the legend of the
                                    scatter points, instead of the variable
                                    label of <i>unit</i> or the string "Units"
      <b>markall</b>                     specify that all scatter points should be
                                    labeled with the value label or, if there
                                    is no value label, with the actual value
                                    of the <i>unit</i> they represent
<p>
<p>
    Marking options: contours
      <b>markup</b>                      specify that points upper the countour at
                                    significance <b>markcontour</b> should be
                                    coloured in <b>markupcolor</b> and labeled with
                                    the label or value of the <i>unit</i> they
                                    represent
      <b><u>markupcol</u></b><b>or(</b><i>color</i><b>)</b>          option of <b>markup</b>
      <b>marklow</b>                      specify that points lower the countour at
                                    significance <b>markcontour</b> should be
                                    coloured in <b>marklowcolor</b>
      <b><u>marklowcol</u></b><b>or(</b><i>color</i><b>)</b>         option of <b>marklow</b>
      <b><u>markcon</u></b><b>tour(</b><i>num</i><b>)</b>             option of <b>markup</b> and/or <b>marklow</b>, the
                                    default is the first contour of the
                                    numlist in <b>contours(</b><i>numlist</i><b>)</b> - if
                                    <b>contours</b> is not specified, the default is
                                    significance 5%
<p>
    Marking options: conditions
      <b>markcond(</b><i>condition</i><b>)</b>         must contain a condition valid on the
                                    active dataset; specifies that points
                                    satisfying that condition should be
                                    coloured in <b>colormarkcond</b> with 
                                    <b>marker_options</b> contained in
                                    <b>optionsmarkcond</b> and that the legend of
                                    this scatter should be <b>legendmarkcond</b>
      <b><u>colormark</u></b><b>cond(</b><i>color</i><b>)</b>        option of <b>markcond</b>
      <b>legendmarkcond(</b><i>string</i><b>)</b>      option of <b>markcond</b>
      <b>optionsmarkcond(</b><i>options</i><b>)</b>    option of <b>markcond</b>
      <b>markcond1(</b><i>condition</i><b>)</b>...     up to 5 conditions might be specified of
                                    the form <b>markcond</b><i>i</i><b>(</b><i>condition</i><b>)</b>; specifies
                                    that points satisfying <b>markcond</b><i>i</i><b>(</b><i>string</i><b>)</b>
                                    should be coloured in
                                    <b>colormarkcond</b><i>i</i><b>(</b><i>color</i><b>)</b> with <b>marker_options</b>
                                    contained in <b>optionsmarkcond</b><i>i</i><b>(</b><i>options</i><b>)</b>
                                    and that the legend of this scatter
                                    should be <b>legendmarkcond</b><i>i</i><b>(</b><i>string</i><b>)</b>
<p>
    Marking options: markunit
      <b><u>marku</u></b><b>nits(</b><i># "text" </i>[<i># </i>[<i>"text"</i>]<i> </i>...]<b>)</b>
                                    list a set of values of <i>unit</i> whose
                                    scatter point must labeled; if a string
                                    is specified after a value, then that
                                    string is used to label the unit
                                    corresponding to that value, otherwise
                                    value label or value itself is used
      <b><u>markcol</u></b><b>or(</b><i>color</i><b>)</b>            specify the colour of the units
      <b><u>marktextop</u></b><b>tions(</b><i>options</i><b>)</b>    specify any <b>added_text_options</b>; default is
                                    <i>placement(ne)</i>
<p>
    Other graph options
      <b><u>vert</u></b><b>ical</b>                    plot a vertical funnel plot instead of a
                                    horizontal one
      <b><u>linecol</u></b><b>or(</b><i>color</i><b>)</b>            specify the colour of the target line
      <b><u>extra</u></b><b>plot(</b><i>plot</i><b>)</b>             specify additional plots to overlay the
                                    funnel plot
      <b><u>tit</u></b><b>le(</b><i>string</i><b>)</b>               specify <b>title_options</b>
      <b><u>{y|x}tit</u></b><b>le(</b><i>string</i><b>)</b>          specify axis title, see <b>axis_options</b>
      <b><u>aspect</u></b><b>ratio(</b><i>options</i><b>)</b>        specify aspectratio, see <b>aspect_option</b>
      <b><u>twoway</u></b><b>opts(</b><i>options</i><b>)</b>         specify additional <b>twoway_options</b> possibly
                                    overriding other default or specified
                                    options (e.g. legending options)
<p>
    Programming options
      <b><u>display</u></b><b>command</b>              show the command that generates the graph
      <b><u>sav</u></b><b>ing(</b><i>filename</i><b>)</b>            save a dta file ready for funnel generation
                                    with the command displayed by
                                    <b>displaycommand</b>, with target value and
                                    other information saved as dataset
                                    characteristics
      <b><u>nodra</u></b><b>w</b>                      avoid plotting the graph
<p>
<p>
    -------------------------------------------------------------------------
    <i>value</i> contains the values of the indicator; <i>pop</i> contains the denominators
    of the indicator or, if <b>smr</b> is specified, the expected number of events;
    <i>unit</i> contains an identifier of the units (e.g. institutions) whose
    indicator values are to be compared with a target value; <i>sdvalue</i> is
    optionally specified in case the <b>continuous</b> option is also specified, and
    contains the standard deviations of the indicator values.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>funnelcompar</b> computes data and plots a funnel plot as defined by
    Spiegelhalter 2005. A scatter plot of an indicator values <i>value</i> is
    plotted against a measure of their precision <i>pop</i>, tipically the sample
    size, together with a target line and control limits (contours), that
    narrow as the sample size gets bigger. The plot graphically tests whether
    each value of the indicator is extracted from a target distribution
    specified by the options.
<p>
<b><u>Target distribution and algorithm for parameter definition</u></b>
<p>
    The user must specify a distribution among normal, binomial or Poisson,
    respectively with the options <b>continuous</b>, <b>binomial</b> or <b>poisson</b>. The
    parameters of the target distribution (target value and standard
    deviation) are then defined.
    The target value is computed as a default as a weighted mean of <i>value</i>
    with weights <i>pop</i>. If the <b>noweight</b> option is specified it is computed as a
    simple mean. Finally, it might be specified by the user as an external
    value via the <b>ext_stand</b> option.
    If the distribution is binomial or Poisson with target value <i>t</i> then the
    standard deviation is obtained as the squared root of, respectively,
    <i>t(1-t)</i> and <i>t</i>. Only if the distribution is normal the standard deviation
    must be further estimated. As a default it is computed as a weighted mean
    of <i>sdvalue</i> with weights <i>pop</i>. If the <b>noweight</b> option is specified it is
    computed as a simple mean of <i>sdvalue</i>. Finally, it might be specified by
    the user as an external value via the <b>ext_sd</b> option.
    If the <b>smr</b> option is specified then <b>poisson</b> must be specified as well,
    and the target is assumed to be 1 (or the value specified in the <b>constant</b>
    option).
<p>
<b><u>Contours</u></b>
<p>
    Plotting the default contours of the funnel plot corresponds to testing
    if the value of the indicator differ 2 or 3 standard deviations from the
    target value, as recommended by standard Statistical Process Control
    principles. Other significance values can be chosen with the <b>contours()</b>
    option.
    If the distribution is discrete (i.e. binomial or Poisson) the <b>exact</b>
    option specifies that the contours are plotted with an exact formula,
    that produces slightly different contours for small values of the
    indicator. As a default the normal approximation is used.
<p>
<p>
<b><u>Examples</u></b>
<p>
    Plot funnel of percentages, specify an external target and specify the
    legend of the units
    <b>. funnelcompar measure pop unit, binom const(100) ext_stand(23)</b>
        <b>unitlabel("LHAs")</b>
<p>
    Plot funnel of percentages and mark in blue a group of units and in green
    another group of units
    <b>. funnelcompar measure pop unit, binomial const(100) markcond(group==3)</b>
        <b>legendmarkcond(Group 3) colormarkcond(blue) markcond1(group==5)</b>
        <b>legendmarkcond1(Group 5) colormarkcond1(green)</b>
<p>
    Plot funnel of indirectly standardised rates, mark in green a single
    point labelled "Your hospital", display the command and save a dataset
    containing instructions for plotting the graph again
    <b>. funnelcompar smr expected hospital, poisson smr markunit(37 "Your</b>
        <b>hospital") display saving(for_funnel)</b>
<p>
    Plot funnel of means and label units that fail the test at 0.02%
    significance
    <b>. funnelcompar mean pop unit sd, continuous markup marklow</b>
        <b>markcontour(.2)</b>
<p>
<b><u>Authors</u></b>
<p>
Silvia Forni, Rosa Gini, Agenzia regionale di sanità della Toscana, Italy.
Email: rosa.gini@arsanita.toscana.it
<p>
<b><u>References</u></b>
<p>
    Spiegelhalter, DJ. Funnel plots for institutional comparison. <i>Qual. Saf.</i>
        <i>Health Care</i> 2002; 11:390-391.
<p>
    Spiegelhalter, DJ. Funnel plots for comparing institutional performance.
        <i>Statist. Med.</i> 2005; 24:1185–1202.
<p>
<p>
<b><u>Also see</u></b>
<p>
    Silvia Forni, Rosa Gini. Funnel plots for institutional comparisons. <i>2009</i>
             <i>UK Stata Users Group meeting.</i> abstract presentation
<p>
    Online:  <b>confunnel</b> (if installed)
<p>
<p>
<p>
<p>
<p>
</pre>