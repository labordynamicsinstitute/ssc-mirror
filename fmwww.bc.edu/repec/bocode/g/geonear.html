<pre>
<b>help geonear</b>
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
    <b>geonear</b> -- Finds nearest neighbors using geodetic distances.
<p>
<p>
<b><u>Syntax</u></b>
<p>
        <b>geonear</b> <i>baseid baselat baselon</i> <b>using</b> <i>nborfile</i> <b>,</b> <b><u>n</u></b><b>eighbors(</b><i>nborid</i>
                <i>nborlat nborlon</i><b>)</b> [<i>options</i>]
<p>
    <i>options</i>               Description
    -------------------------------------------------------------------------
    Main
      <b><u>wid</u></b><b>e</b>                return nearest neighbors in wide form (the default)
      <b><u>lo</u></b><b>ng</b>                return nearest neighbors in long form
      <b><u>nea</u></b><b>rcount(</b><i>#</i><b>)</b>        find the <i>#</i> nearest neighbors
      <b><u>i</u></b><b>gnoreself</b>          ignore distance to self (when<i> baseid == nborid</i>)
      <b><u>o</u></b><b>ps(</b><i>#</i><b>)</b>              specify a maximum <i>#</i> of pairwise combinations of
                            <i>baseid</i> and <i>nborid</i> per region
<p>
      <i>Wide Form Only</i>      
      <b><u>g</u></b><b>enstub(</b><i>str</i><b>)</b>        prefix nearest neighbor variable names with <i>str</i>
<p>
      <i>Long Form Only</i>      
      <b><u>wit</u></b><b>hin(</b><i>#</i><b>)</b>           return neighbors within a distance of <i>#</i> from each
                            <i>baseid</i>
      <b><u>li</u></b><b>mit(</b><i>#</i><b>)</b>            return no more than <i>#</i> nearest neighbors for each
                            <i>baseid</i>
<p>
    Distances
      <b><u>mi</u></b><b>les</b>               return distances in miles
      <b><u>ra</u></b><b>dius(</b><i>#</i><b>)</b>           custom radius <i>#</i> (in km) for spherical distances
      <b><u>e</u></b><b>llipsoid</b>           use ellipsoidal distances
      <b>a(</b><i>#</i><b>)</b>                custom ellipsoid; semi-major axis parameter <i>#</i>
      <b>f(</b><i>#</i><b>)</b>                custom ellipsoid; flattening parameter <i>#</i>
<p>
    Reporting
      <b><u>re</u></b><b>port(</b><i>#</i><b>)</b>           display a status report line every <i>#</i> seconds
<p>
    -------------------------------------------------------------------------
<p>
<p>
<b><u>Description</u></b>
<p>
    For each location identified by <i>baseid</i> and with coordinates <i>baselat</i>
    <i>baselon</i>, <b>geonear</b> finds in <i>nborfile</i>, a Stata-format dataset, the nearest
    neighbor(s), identified by <i>nborid</i> and located at <i>nborlat</i> <i>nborlon</i>.
    Coordinates must be in signed decimal degrees, positive for north and
    east, and negative for south and west. Latitudes (<i>baselat</i> and <i>nborlat</i>)
    range from -90 to 90 and longitudes (<i>baselon</i> and <i>nborlon</i>) from -180 to
    180.
<p>
    <b>geonear</b> computes geodetic distances, i.e. the length of the shortest
    curve between two points along the surface of a mathematical model of the
    earth.  geodist is a standalone implementation of <b>geonear</b>'s distance
    routines and is available from SSC. By default, <b>geonear</b> calculates
    distances on a sphere but ellipsoidal distances can be requested
    (slower). All distances are in kilometers and all distance variables are
    prefixed with "<i>km_to_</i>" unless the <b><u>mi</u></b><b>les</b> option is specified (the prefix
    changes to "<i>mi_to_</i>").
<p>
    <b>geonear</b> uses a divide and conquer strategy to significantly reduce the
    number of distances that must be computed. The approach involves
    splitting base locations into progressively smaller geographic regions
    while at the same time safely reducing the set of potential neighbors for
    each region. Distances are calculated only when the number of pairwise
    combinations of <i>baseid</i> and <i>nborid</i> falls below a threshold value
    (adjustable using the <b><u>o</u></b><b>ps(</b><i>#</i><b>)</b> option). Generally, there is about the same
    number of base locations per region which means that <b>geonear</b> will
    predictably find the nearest neighbors in a linear time even though the
    size of the overall problem increases exponentially.  In other words
    doubling the size of the base location set <i>and</i> doubling the size of the
    neighbor location set simply doubles the number of regions and thus
    doubles the run time.
<p>
    By default, <b>geonear</b> operates in wide form mode (see <b><u>wid</u></b><b>e</b> option).  In
    this mode, <b>geonear</b> creates two variables for each neighbor requested.
    The first variable identifies the nearest neighbor (using <i>nborid</i>
    identifiers). The second variable stores the distance to that neighbor
    from the <i>baseid</i> location.
<p>
    In long form mode (see <b><u>lo</u></b><b>ng</b> option), <b>geonear</b> returns one observation per
    neighbor found. The <b><u>near</u></b><b>count(</b><i>#</i><b>)</b> option can be used to request a specific
    number of neighbors per <i>baseid</i>. The <b><u>wit</u></b><b>hin(</b><i>#</i><b>)</b> option can be used to
    request all neighbors within a distance of <i>#</i> from each <i>baseid</i>. You can
    combine <b><u>wit</u></b><b>hin(</b><i>#</i><b>)</b> with <b><u>near</u></b><b>count(</b><i>#</i><b>)</b> and <b>geonear</b> will return any <i>nborid</i>
    that satisfies either condition.
<p>
<p>
<b><u>Options</u></b>
<p>
        +------+
    ----+ Main +-------------------------------------------------------------
    <b><u>wid</u></b><b>e</b> is used to request that <b>geonear</b> return results in wide form.  In
        this mode, <b>geonear</b> creates variables to identify neighbors and their
        distance to the <i>baseid</i>. If <b><u>nea</u></b><b>rcount(</b><i>#</i><b>)</b> is omitted, the nearest
        neighbor is identified by the <i>nid</i> and <i>km_to_nid</i> variables. Otherwise,
        the naming follows the following pattern:
<p>
            <i>nid1  km_to_nid1  nid2  km_to_nid2  [...]  nid#  km_to_nid#</i>
<p>
        The <b><u>g</u></b><b>enstub(</b><i>nidstub</i><b>)</b> option can be used to specify an alternative
        stubname to <i>nid</i>.
<p>
    <b><u>lo</u></b><b>ng</b> is used to request results in long form, one observation per
        neighbor found. <b>geonear</b> returns the variables <i>baseid</i>, <i>nborid</i> and
        <i>km_to_nborid</i>, with as many observations per <i>baseid</i> as there are
        neighbors found. Because of the output format, <i>baseid</i> and <i>nborid</i> must
        have different names. Both <b><u>wit</u></b><b>hin(</b><i>#</i><b>)</b> and <b><u>near</u></b><b>count(</b><i>#</i><b>)</b> can be used to
        target neighbors.
<p>
    <b><u>nea</u></b><b>rcount(</b><i>#</i><b>)</b> is used to request a specific number of nearest <i>nborid</i> per
        <i>baseid</i>. If omitted, <b>geonear</b> finds the nearest neighbor for each
        <i>baseid</i>. If there is a tie for the #th <i>nborid</i> position, the neighbor
        is chosen by ascending order of <i>nborid</i>.
<p>
    <b><u>ign</u></b><b>oreself</b> is used when <i>baseid</i> and <i>nborid</i> identify the same set of
        locations. With this option, <b>geonear</b> ignores distances when
        <i>nborid == baseid</i> (as such distance would be zero) and thus ensures
        that the nearest neighbor is a different entity.
<p>
    <b><u>o</u></b><b>ps(</b><i>#</i><b>)</b> specifies the maximum <i>#</i> number of distances to be calculated per
        region. Within a region, the number of distances to be calculated is
        determined by <i>(nbases * nnbors)</i>, where <i>nbases</i> is the count of base
        locations within the region and <i>nnbors</i> is the number of potential
        neighbors. The default is 15,000 for results in wide form and 7,000
        for results in long form.
<p>
    <b><u>g</u></b><b>enstub(</b><i>str</i><b>)</b> is only available in wide form mode. It is used to specify
        an alternative stubname to <i>nid</i> for the nearest neighbor variables.
<p>
    <b><u>wit</u></b><b>hin(</b><i>#</i><b>)</b> is only available in long form mode. It is used to request all
        neighbors within a distance <i>#</i> of each <i>baseid</i>. If the <b><u>mi</u></b><b>les</b> option is
        specified, <b><u>wit</u></b><b>hin(</b><i>#</i><b>)</b> is considered specified in miles. This option
        can be combined with <b><u>nea</u></b><b>rcount(</b><i>#</i><b>)</b> to request a minimum number of
        nearest neighbors per <i>baseid</i>. Combined with <b><u>nea</u></b><b>rcount(</b><i>0</i><b>)</b>, <i>baseid</i>s are
        excluded from the results if they have no neighbors within the
        specified distance.
<p>
    <b><u>li</u></b><b>mit(</b><i>#</i><b>)</b> is only available in long form mode. It can be used to limit the
        number of neighbor observations per <i>baseid</i> when <b><u>wit</u></b><b>hin(</b><i>#</i><b>)</b> is used.
        This option is offered mostly as a convenience. It does not affect
        the number of distances calculated; it simply drops neighbor
        observations that exceed the count.
<p>
        +-----------+
    ----+ Distances +--------------------------------------------------------
    <b><u>mi</u></b><b>les</b> requests that distances be returned in miles instead of kilometers.
        It also indicates that <b><u>wit</u></b><b>hin(</b><i>#</i><b>)</b> is in miles.
<p>
    <b><u>ra</u></b><b>dius(</b><i>#</i><b>)</b> allows for a user-specified radius of the earth in km. If
        omitted, a radius of 6371km is used. This is the earth's mean radius
        (see http://en.wikipedia.org/wiki/Earth_radius#Mean_radii).
<p>
    <b><u>e</u></b><b>llipsoid</b> indicates that distances should be calculated using the WGS
        1984 reference ellipsoid. Calculating ellipsoidal distances requires
        more computational power; you should expect a significant penalty in
        terms of total run time.
<p>
    <b>a(</b><i>#</i><b>)</b> is used to specify the length of the semi-major axis parameter in
        meters for a different ellipsoid. For example, to use the Bessel 1841
        reference ellipsoid, specify <b>a(</b><i>6377397</i>.<i>155</i><b>)</b>.
<p>
    <b>f(</b><i>#</i><b>)</b> is used to specify the flattening ratio parameter for a different
        ellipsoid. For example, to use the Bessel 1841 reference ellipsoid,
        specify <b>f(</b><i>299</i>.<i>1528128</i><b>)</b>.
<p>
        +-----------+
    ----+ Reporting +--------------------------------------------------------
    <b><u>rep</u></b><b>ort(</b><i>#</i><b>)</b> is used to control the frequency of status reporting. By
        default, a status report line is displayed every 10 seconds. Each
        report line includes current region count, number of base locations
        within the region, number of neighbor locations considered, total
        number of distances calculated (ops = base locs x nbor locs),
        cumulative number of distances, percent done, and remaining time.
<p>
<p>
<b><u>Accuracy and limitations</u></b>
<p>
    By default, <b>geonear</b> computes great-circle distances using the Haversine
    formula. <b>geonear</b> uses double precision arithmetic throughout and the
    formula provides submillimeter accuracy for all distances except within
    10 meters of antipodal locations. <b>geonear</b> uses the Vincenty (1975)
    equations when computing distances on a reference ellipsoid. According to
    Thomas and Featherstone (2005), these are thought to maintain
    submillimeter accuracy between all locations. However, the Vincenty
    algorithm cannot accurately calculate distances for near-antipodal
    points. In such cases, the distances are undefined and set to missing.
    See http://geographiclib.sourceforge.net/cgi-bin/Geod for a calculator
    that does not have this limitation. In either case, since <b>geonear</b> seeks
    nearest neighbors, the issue of near-antipodal locations is not likely to
    matter.
<p>
    Most longitude and latitude datasets are based on the WGS 1984 datum,
    which is what GPS devices and Google Earth/Map use. There are other
    datums and it is important to understand that distances will not be
    accurate if the base and neighbor locations are not expressed in the same
    reference system. Here is a photo of my GPS lying on the Prime Meridian
    line at the Royal Observatory in Greenwich, England. If you use a
    distance calculator, you will see that it is about 100 meters to the west
    of the Reference Meridian of WGS 1984 (geodist 51.47803 -0.00145 51.47803
    0).
<p>
<p>
<b><u>Examples</u></b>
<p>
    Simulate a dataset of 2000 Census Block Group centroids for Colorado.
<p>
        <b>.</b> clear
        <b>.</b> set seed 123456
        <b>.</b> set obs 3278
        <b>.</b> gen bgid = _n
        <b>.</b> gen double bglat = 37 + (41 - 37) * uniform()
        <b>.</b> gen double bglon = -109 + (109 - 102) * uniform()
        <b>.</b> tempfile bg
        <b>.</b> save "`bg'"
        
    Create a new dataset that contains locations of cell towers in the State
    of Colorado.
<p>
        <b>.</b> clear
        <b>.</b> set obs 1000
        <b>.</b> gen ctid = _n
        <b>.</b> gen double ctlat = 37 + (41 - 37) * uniform()
        <b>.</b> gen double ctlon = -109 + (109 - 102) * uniform()
        <b>.</b> tempfile cell
        <b>.</b> save "`cell'"
<p>
    To find the nearest neighbor for each of these cell towers:
<p>
        <b>.</b> geonear ctid ctlat ctlon using "`cell'", n(ctid ctlat ctlon) ignorese
&gt; lf
<p>
    To find all towers within 50km of each tower:
<p>
        <b>.</b> use "`cell'", clear
        <b>.</b> rename ctid ctid0
        <b>.</b> geonear ctid0 ctlat ctlon using "`cell'", n(ctid ctlat ctlon) ign lon
&gt; g within(50) near(0)
<p>
    To find all cell towers within 5km from each Census Block Group
    centroids:
<p>
        <b>.</b> use "`bg'", clear
        <b>.</b> geonear bgid bglat bglon using "`cell'", n(ctid ctlat ctlon) within(5
&gt; ) near(0) long 
<p>
    To find the nearest cell tower as well as all cell towers within 5km from
    each Census Block Group centroids:
<p>
        <b>.</b> use "`bg'", clear
        <b>.</b> geonear bgid bglat bglon using "`cell'", n(ctid ctlat ctlon) within(5
&gt; ) long 
        <b>.</b> by bgid: gen N = _N 
        <b>.</b> tab N 
<p>
    To find the nearest 3 Census Block Group centroids for each cell tower in
    wide form:
<p>
        <b>.</b> use "`cell'", clear
        <b>.</b> geonear ctid ctlat ctlon using "`bg'", n(bgid bglat bglon) wide near(
&gt; 3) genstub(bgid)
        
    The following example finds all Census Block Group centroids that fall
    within each cell tower's Voronoi (a.k.a. Thiessen) polygon.
<p>
        <b>.</b> use "`bg'", clear
        <b>.</b> geonear bgid bglat bglon using "`cell'", n(ctid ctlat ctlon) genstub(
&gt; ctid) 
        <b>.</b> sort ctid bgid
        <b>.</b> by ctid: gen N = _N
        <b>.</b> tab N
<p>
<p>
<b><u>References and acknowledgements</u></b>
<p>
    Many thanks to Chris Veness for the best web pages on how to compute
    geodetic distances:
<p>
        http://www.movable-type.co.uk/scripts/latlong-vincenty.html
        http://www.movable-type.co.uk/scripts/latlong.html
        
    The definition of the World Geodetic System 1984 is available from
<p>
        http://earth-info.nga.mil/GandG/publications/tr8350.2/wgs84fin.pdf
   
    See Appendix A.1 for a list of reference ellipsoids.
<p>
    C. F. F. Karney, Geodesics on an ellipsoid of revolution, Feb. 2011;
    preprint arxiv:1102.1215.
<p>
    R. W. Sinnott, "Virtues of the Haversine", <i>Sky and Telescope</i> 68 (2), 159
    (1984).  Thanks to the University of Michigan's Shapiro Science Library.
<p>
    C. M. Thomas and W. E. Featherstone, Validation of Vincenty's Formulas
    for the Geodesic Using a New Fourth-Order Extension of Kivioja's Formula,
    <i>J. Surv. Engrg.</i> Volume 131, Issue 1, pp. 20-26 (February 2005), available
    for download from:
<p>
        http://www.cage.curtin.edu.au/~will/thomas-featherstone.pdf
<p>
    Vincenty, T. (1975) Direct and inverse solutions of geodesics on the
    ellipsoid with application of nested equations, <i>Survey Review</i> 22(176):
    88-93 is available from:
<p>
        http://www.ngs.noaa.gov/PUBS_LIB/inverse.pdf
<p>
<p>
<b><u>Author</u></b>
<p>
    Robert Picard
    picard@netbox.com
</pre>