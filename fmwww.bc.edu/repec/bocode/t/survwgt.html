<pre>
-------------------------------------------------------------------------------
help for <b>survwgt</b>
-------------------------------------------------------------------------------
<p>
<b><u>Survey sampling weights: adjustment and replicate weight creation</u></b>
<p>
    <b>survwgt</b> <b><u>cr</u></b><b>eate</b>       <i>weight_type</i> <b>,</b> <b><u>str</u></b><b>ata(</b><i>varname</i><b>)</b> <b>psu(</b><i>varname</i><b>)</b>
                         <b><u>w</u></b><b>eight(</b><i>varname</i><b>)</b> <b>stem(</b><i>stem</i><b>)</b> [ <b>fay(</b><i>#</i><b>)</b> <b>dof(</b><i>#</i><b>)</b>
                         <b><u>hadm</u></b><b>at(</b><i>matname</i><b>)</b> <b><u>hadf</u></b><b>ile(</b><i>matrix_file_name</i><b>)</b> <b><u>nod</u></b><b>ots</b> ]
<p>
                         <i>weight_type</i> is one of
<p>
                         <b>brr</b> - balanced repeated replication weights
                         <b>jk1</b> - unstratified delete-one jackknife weights
                         <b>jk2</b> - two per stratum delete-one jackknife weights
                         <b>jkn</b> - delete-n jackknife weights
<p>
    <b>survwgt</b> <b><u>post</u></b><b>stratify</b> <i>varspec</i> <b>,</b> <b>by(</b><i>varlist</i><b>)</b> <b><u>t</u></b><b>otvar(</b><i>varname</i><b>)</b> {
                         <b><u>g</u></b><b>enerate(</b><i>varlist</i><b>)</b> | <b>stem(</b><i>stem</i><b>)</b> | <b><u>pre</u></b><b>fix(</b><i>prefix</i><b>)</b> |
                         <b>replace</b> }
<p>
    <b>survwgt</b> <b>rake</b>         <i>varspec</i> <b>,</b> <b>by(</b><i>varlist</i><b>)</b> <b><u>t</u></b><b>otvars(</b><i>varlist</i><b>)</b> {
                         <b><u>g</u></b><b>enerate(</b><i>varlist</i><b>)</b> | <b>stem(</b><i>stem</i><b>)</b> | <b><u>pre</u></b><b>fix(</b><i>prefix</i><b>)</b> |
                         <b>replace</b> } <b><u>maxr</u></b><b>ep(</b><i>#</i><b>)</b> <b><u>nit</u></b><b>er</b>
<p>
    <b>survwgt</b> <b><u>nonr</u></b><b>esponse</b>  <i>varspec</i> <b>,</b> <b>by(</b><i>varlist</i><b>)</b> <b><u>r</u></b><b>espvar(</b><i>varname</i><b>)</b> {
                         <b><u>g</u></b><b>enerate(</b><i>varlist</i><b>)</b> | <b>stem(</b><i>stem</i><b>)</b> | <b><u>pre</u></b><b>fix(</b><i>prefix</i><b>)</b> |
                         <b>replace</b> }
<p>
                         <i>varspec</i> is one of
<p>
                         <i>varlist</i> - a Stata variable list
                         <b>[pw]</b> - indicates the full sample weight
                         <b>[rw]</b> - indicates the set of replicate weights
                         <b>[all]</b> - indicates both <b>[pw]</b> and <b>[rw]</b>
<p>
<p>
<b><u>Description</u></b>
<p>
<b>survwgt</b> creates sets of weights for replication-based variance estimation
techniques for survey data.  These include balanced repeated replication (BRR)
and several version of the survey jackknife (JK*).  These replication methods
are alternates to the Taylor series linearization methods used by Stata's
svy-based commands.
<p>
In addition, <b>survwgt</b> performs poststratification, raking, and non-response
adjustments to survey weights.
<p>
<b>survwgt create</b> creates a set of replicate weights for a dataset.  <b>survwgt</b> can
create four types of replicate weights, depending on the nature of the complex
sample design and user preferences.  In each method, multiple weight variables
are created.  Each set of replicate weights is calcuated by setting the
sampling weights for observations in one or more PSUs to zero, and adjusting
the sampling weights for the remaining observations to reproduce the
full-sample totals.  The svr set of commands use these weights to calculate
(co)variances estimates of parameters by repeatedly estimating statistics of
interest with each set of replicate weights.  See Wolter (1985) for details.
<p>
    <b>brr</b> (balanced repeated replication) is appropriate for designs with exactly
        two PSUs per stratum.  Technically, (CHECK) PSUs must have been
        selected without replacement; any subsequent subsampling within PSUs is
        acceptable.  In BRR, <i>n</i> weights are created, in which <i>n</i> is the smallest
        multiple of four greater than or equal to the number of strata.  In
        each set of weights, one PSU from each stratum is included and the
        other excluded, in a pattern defined by a Hadamard matrix.
        Specifications for Hadamard matrices up to dimension 512 are included
        with <b>survwgt</b>, which allows for designs with up to 512 strata.  Larger
        Hadamard matrices may be provided by the user, up to the limits of 
        matsize.
<p>
    <b>jk1</b> (unstratified delete-one jackknife) is appropriate for non-stratified,
        clustered sampling designs.  In JK1, one PSU is deleted from each set
        of replicate weights, so the number of replicate weights equals the
        number of PSUs.
<p>
    <b>jk2</b> (two per stratum delete-one jackknife) is appropriate for the same
        designs as the balanced repeated replication method: two PSUs per
        stratum, selected with replacement, with any subsampling scheme within
        PSU.  In the <b>jk2</b> method, one PSU is deleted from each replicate (as
        opposed to one PSU <i>per stratum</i> in the <b>brr</b> method).
<p>
    <b>jkn</b> (delete-n jackknife) is appropriate for sampling designs with two or
        more PSUs per stratum.  [Insert description here!]
<p>
<b>survwgt poststratify</b> computes post-stratification adjustments to survey
sampling weights.  The sampling weights in each stratum are adjusted by a
multiplicative factor such that the sum of the weights equals the control total
for each stratum, as specified in the <b>totvar()</b> option.  When more than one
sampling weight variable is specified, the command post-stratifies each in
turn.  This allows for the adjustment of the main sampling weight and a full
set of replicate weights in one easy step.
<p>
<b>survwgt rake</b> computes raking adjustments to survey sampling weights.  Raking is
used when there are multiple stratification dimension, when control totals
known for the marginal distribution of each dimension but not for the
individual cell totals.  (When population cell totals are known,
post-stratification should be used.) In raking, the sampling weights for each
stratum are iteratively adjusted by a multiplicative factor such that the sum
of the weights equals the control total for marginal dimension, in turn, until
convergence is achieved.  As with post-stratification, multiple sets of
analysis and replicate weights can be raked with one call to <b>survwgt</b>.
<p>
<b>survwgt nonresponse</b> computes non-response adjustments to survey sampling
weights.  Nonresponse adjustment requires a dataset that includes the full
sample-- responders and non-responders.  Separately within each response
stratum, the base survey sampling weight for each responder in the sample is
adjusted such that the total weight for responders alone equals the total
weight for the sample.  The weight for non-responders is set to zero.  As with
the other weight adjustment routines, multiple variables can be subjected to
non-response adjustment in one easy call to <b>survwgt</b>.
<p>
<p>
<b><u>Options for </u></b><b><u>survwgt create</u></b>
<p>
<b>strata(</b><i>varname</i><b>)</b> specifies the variable that identifies stratum membership.
    This must be a single variable; if the strata are defined by multiple
    variables, a single variable can be created with egen's group() option.
    The <b>strata()</b> option is required for all weight types except JK1, for which
    it is not allowed.
<p>
<b>psu(</b><i>varname</i><b>)</b> specifies the variable that identifies the primary sampling units
    within strata.  It is required for all types of replicate weight creation.
<p>
<b>weight(</b><i>varname</i><b>)</b> specifies the base sampling weights.  It is required.
<p>
<b>stem)</b><i>stem</i><b>)</b> specifies a stem to be used as the basis for the replicate weight
    variable names.  The repliciate weight variables are named stem1, stem2,
    ... stem<i>n</i>.  If <b>stem()</b> is not specified, a stem based on the type of weights
    is used (brr_, jk1_, jk2_, or jkn_)
<p>
<b>fay(</b><i>#</i><b>)</b> specifies the value of the constant to be used in generating weights
    according to Fay's variant of balanced repeated replication.  In this
    method, observations in the selected PSUs are assigned weight of (2-fay),
    and those in the non-selected PSUs are assigned a weight of (fay), rather
    than 2 and 0, respectively.  By default, the Fay constant is 0, which
    implies "regular" BRR.  This option is valid only for the brr method.
<p>
<b>dof(</b><i>#</i><b>)</b> specifies the appropriate degrees of freedom for variance estimates.  By
    default, degrees of freedom is set to the number of strata for the BRR and
    JK2 methods, to one less than the the number of PSUs for JK1, and to the
    total number of PSUs minus the total number of strata, for the JKn method.
<p>
<b>hadmat(</b><i>matname</i><b>)</b> specifies a Stata system matrix that contains the Hadamard
    matrix to create the replicates.  The program comes with a binary file with
    Hadamard matrices up to dimension 512, so this option should be
    little-used.  No checking is done that the matrix is in fact a Hadamard
    matrix -- be careful!
<p>
<b>hadfile(</b><i>matrix_file_name</i><b>)</b> specifies the system file that contains Hadamard
    matrices.  This should only be necessary when the system file is located
    off the Stata search path, or named something other than the default.
<p>
<b>nodots</b> specifies that a dot should not be displayed for each set of weights
    that is created.  With large datasets, the dots can reassure you that the
    program has not died.
<p>
<p>
<b><u>Options for </u></b><b><u>survwgt poststratify</u></b><b><u>, </u></b><b><u>rake</u></b><b><u>, and </u></b><b><u>nonresponse</u></b>
<p>
<i>varspec</i> specifies the base weight(s) to adjusted (i.e., post-stratified, raked,
    or adjusted for non-response).  This can be specified as a Stata varlist.
    More usefully, this can be specified as <b>[pw]</b>, which indicates the currently
    specified main analysis weight, and/or <b>[rw]</b> which indicates the set of
    replicate weights.  <b>[all]</b> is a synonym for <b>[pw] [rw]</b>.  If this automated
    variable specification is used, then the svr settings for the dataset are
    updated to specify the new weights, unless the <b>noupdate</b> option is
    specified.  See svrset.
<p>
<b><u>noup</u></b><b>date</b> specifies that the svr settings for the dataset should not be updated
    to reflect the adjusted weights.  This only has an effect when the
    variables to be adjusted are specified with the "automatic" syntax
    discussed above.
<p>
<b>by(</b><i>varlist</i><b>)</b> specifies variable(s) identifying the strata.  For
    post-stratification, the base weights are adjusted to sum to the control
    totals for the <i>cells</i> defined by the strata; for raking, the base weights
    are adjusted to sum to the control totals for the <i>marginals</i> of the strata.
    For non-response adjustment, the base weights for respondents are adjusted
    to sum to the total of the full sample weights for the cells defined by the
    strata.
<p>
<b>totvar</b>[<b>s</b>]<b>(</b><i>varname</i>[<i>s</i>]<b>)</b> specifies the variable[s] containing control totals for
    post-stratification or raking.  For post-stratification, <b>totvar()</b> must be a
    single variable, constant within the cells defined by the <b>by(</b><i>varlist</i><b>)</b>, of
    control totals.  For raking, <b>totvars()</b> must contain variables (one per
    variable specified <b>by()</b>), which specify the marginal control total for each
    value of the corresponding stratum variable.  This option is not valid for
    non-response adjustment.
<p>
<b>respvar(</b><i>varname</i><b>)</b> specifies the variable that contains response information for
    members of the sample.  This variable must take on values of 0 (indicating
    non-response), 1 (indicating response), or missing (out of sample).  The
    base weights are adjusted such that, within each response stratum, the
    adjusted weight for respondents sums to the total of the base weight for
    all sample members.  Non-respondent cases are assigned an adjusted weight
    of zero, and out of sample cases are excluded from the calculations and
    assigned missing for the adjusted weight.
<p>
    If there are no respondents in a stratum, all weights for that stratum are
    set to zero and a warning is displayed.  If there are no sample members in
    a stratum, all weights are set to missing and a warning is displayed.  This
    option is only valid for non-response adjustment.
<p>
<b>generate(</b><i>varlist</i><b>)</b> specifies the explicitly the names for the adjusted weight
    variable(s) to be created. There must be one name per base sampling weight
    specified in <i>varlist</i>.
<p>
<b>stem(</b><i>stem</i><b>)</b> specifies a stem to be used to create names for the adjusted weight
    variable(s).  New variables are numbered from 1, unless the "pw" or "all"
    are indicated for the <i>varspec</i>, in which case they are numbered from 0.
<p>
<b>prefix(</b><i>prefix</i><b>)</b> specifies a prefix to be prepended to the existing variable
    names used to create the adjusted weight variable(s).
<p>
<b>replace</b> specifies that the adjusted variables should replace the existing
    variables.  This option should be used with caution.
<p>
<b><u>maxr</u></b><b>ep(</b><i>#</i><b>)</b> specifies the maximum number of iterations allowed for <b>survwgt rake</b>.
    The default is 10.
<p>
<b><u>nit</u></b><b>er</b> specifies that the number of iterations required for <b>survwgt rake</b> to
    converge be displayed.
<p>
<p>
<p>
<b><u>Methods and formulae for weight calculation</u></b>
<p>
<b>survwgt create</b> only works for survey designs that exactly match the
specificatons for the type of weights requested (two PSUs per stratum for BRR,
etc.) Any collapsing of strata or PSUs, splitting of certainty PSUs, or other
adjustments to approximate the appropriate design must be done outside of the
program.
<p>
The program creates k sets of replicate weights, where k is defined as
discussed above for the replication method.
<p>
For the <b>BRR</b> method, the the program selects one of the PSUs from each stratum,
according to a Hadamard matrix of the relevant dimension. For replicate <i>j</i>, the
weights for each observation<i> i</i> are calculated as follows:
<p>
<p>
     W    = W   * (2-k)         for observations in the PSU
      <i>ij</i>     <i>i</i>F                 selected into the replicate
<p>
<p>
          = W   * (k)           for observations in the other PSU
             <i>i</i>F
<p>
where
<p>
     W     is the full-sample weight for observation <i>i</i>, and
           <i>i</i>F
<p>
     k     is the constant for Fay's method.  For standard BRR, k=0.
<p>
<p>
The program comes with an auxiliary binary file,
survwgt_hadamardmatrixfile.ado, which contains Hadamard matrices up to
dimension 512.  These matrices are stored in a compressed binary format to save
disk space; the available matrix sizes can be obtained by typing <b>survwgt create</b>
<b>brr sizes</b>.  (Note: the binary file is named with an "ado" file extension in
order that it be installed in the correct directory by Stata's net install and
ssc install commands.  The file is not, in fact, a Stata program, and will
issue an appropriate error message if it is attempted to be run.)
<p>
For the <b>JK1</b> method, the program creates one replicate per PSU.  In replicate <i>j</i>,
the weights for each observation <i>i</i> are calculated as follows:
<p>
<p>
     W    = 0                   for observations in PSU
      <i>ij</i>                                               <i>j</i>
<p>
<p>
          = W   * ( N/(N-1) )   for observations in other PSUs
             <i>i</i>F
<p>
where N is the number of PSUs, and W is defined as above.
<p>
For the <b>JK2</b> method, the program creates one replicate per stratum.  In each
replicate, the weights in the selected stratum are doubled in the first PSU,
and set to zero in the second PSU.  Weights in other strata are not changed.
<p>
For the <b>JKn</b> method, the program creates one replicate for PSU.  In each
replicate, the weights for each observation <i>i</i> are calculated as follows:
<p>
     W    = 0                   for observations in PSU  (from stratum <i>k</i>)
      <i>ij</i>                                               <i>j</i>
<p>
<p>
          = W   * (N /(N -1))   for observations from other PSUs
             <i>i</i>F     <i>k</i>   <i>k</i>       in stratum <i>k</i>
<p>
<p>
          = W                   for observations in other strata
             <i>i</i>F
<p>
where
<p>
     N     is the number of PSUs in stratum <i>k</i>
      <i>k</i>
<p>
<p>
<p>
<b><u>Methods and formulae for variance estimation</u></b>
<p>
The <b>svr</b> set of commands make use of the replication weights produced by <b>survwgt</b>
<b>create</b> to estimate (co)variances for parameters and other estimated quantities.
See svr for a list of these commands.  In general, the parameter estimates are
calculated by standard statistical commands using aweights, which yields the
same point estimates as Stata's linearization-based svy commands for survey
data.  The (co)variances are calculated by repeatedly re-estimating the same
parameters with each of the set of replicate weights.  From these replicated
estimates, the (co)variances are calcuated as follows:
<p>
<p>
                 R
     V(b) = F * Sum( f *(b -b)(b -b)' )
                r=1   <i>r</i>   <i>r</i>     <i>r</i>
<p>
where
<p>
     R     is the number of replicates,
<p>
     b     is the vector of full sample point estimate(s),
<p>
     b     is the vector of estimates derived from replicate <i>r</i>,
      <i>r</i>
<p>
     F     is a constant factor depending on the replication method, and
<p>
     f     is a replicate-specific factor.
      <i>r</i>
<p>
<p>
The values for F and f are:
<p>
     <b>method</b>      <b>F</b>           <b>f</b>
<p>
       BRR                 1/R          1
<p>
       Fay's variant  1/(R*(1-k)^2)     1
       of BRR
<p>
       JK1               (R-1)/R        1
<p>
       JK2                  1           1
<p>
       JKn                  1       (N -1)/N
                                      <i>k</i>     <i>k</i>
<p>
<p>
<p>
<b><u>Saved Results</u></b>
<p>
The command saves no results, but it does set data characteristics to identify
the full sample and replicate weight variables, degrees of freedom, fay
constant for BRR method, and replication method (BRR, JK1, JK2, or JKn).  The 
svrset command can be used to set, clear, or display these characteristics.
<p>
<p>
<b><u>References</u></b>
<p>
Judkins, D. 1990.  Fay's Method for Variance Estimation.  Journal of Official
Statistics 16:25-45.
<p>
Wolter, K. M. 1985. Introduction to Variance Estimation. New York:
Springer-Verlag.
<p>
<p>
<b><u>Acknowledgements</u></b>
<p>
I would like to thank Bobby Gutierrez at StataCorp for advice on implementation
of BRR, and the technical group at StataCorp for feedback on an early version
of the BRR programs.  The code for raking is partly based upon Nick Cox's
program mstdize.
<p>
<p>
<b><u>Author</u></b>
<p>
        Nick Winter
        University of Virginia
        nwinter&lt;at&gt;virginia&lt;dot&gt;edu
</pre>