<pre>
<b>help reffadjustsim</b>                                                             
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
     <b>reffadjustsim</b> -- random effects adjustment: simulating from the
distribution of random effect variances and covariances
<p>
<p>
<a name="syntax"></a><b><u>Syntax</u></b>
<p>
        <b>reffadjustsim</b> <i>depvar</i> <i>indepvars</i> <b>,</b> <b>eqn(</b>string<b>)</b> [<i>options</i>]
<p>
<p>
<a name="options"></a>    <i>options</i>                         Description
    -------------------------------------------------------------------------
      <b>eqn(</b><i>string</i><b>)</b>                   name of the equation the adjusted
                                      coefficients are to be extracted from
      <b>centileopts(</b><i>string</i><b>)</b>           options passed to <b>centile</b>
      <b><u>l</u></b><b>evel(</b><i>#</i><b>)</b>                      set confidence level; default is
                                      <b>level(95)</b>
      <b>mcmcsum</b>                       use chains from <b>mcmcsum</b>
      <b>n(</b><i>#</i><b>)</b>                          # of observations to simulate; default is
                                      10,000
      <b>post</b>                          post estimation results
      <b>replace</b>                       replace beta_indepvar if variable exists
                                      in dataset
      <b><u>sav</u></b><b>ing(</b><i>filename </i>[<b>,</b><i> replace</i>]<b>)</b>  save simulated observations to <i>filename</i>
      <b>sf(</b><i>numlist</i><b>)</b>                   scaling factors corresponding to each
                                      coefficient
      <b>seed(</b><i>#</i><b>)</b>                       seed for random-number generator
      <b>statadrawnorm</b>                 use Stata's <b>drawnorm</b> for Wald type CIs
      <b><u>sub</u></b><b>level(</b><i>#</i><b>)</b>                   sublevel of a repeated group variable
      <b><u>wald</u></b><b>type</b>                      report means &amp; Wald-type confidence
                                      intervals
    -------------------------------------------------------------------------
<p>
<p>
<a name="description"></a><b><u>Description</u></b>
<p>
    <b>reffadjustsim</b> is a postestimation command to perform adjustment of random
    effects estimates.  It runs with estimates from <b>runmlwin</b> or chains from
    <b>runmlwin</b> by <b>mcmcsum</b> (Leckie and Charlton, 2011), <b>xtmixed</b>, <b>xtmelogit</b>, and
    <b>xtmepoisson</b>.
<p>
    <b>reffadjustsim</b> generates the specified number of observations of the
    variances and covariances of the random effects from the corresponding
    multivariate normal distribution.  Alternatively, values are used from
    the returned chains from Bayesian estimation in MLwiN by <b>mcmcsum,</b>
    <b>getchains</b>.  For each observation the adjusted coefficient/s are estimated
    as described by Fisher (1925, chapter 5, section 29).  The approach is
    described in more detail in Macdonald-Wallis et al. (2011, submitted).
    Further details are given in <b>reffadjust</b>.  The covariates (<i>indepvars</i>) can
    be specified in any order.
<p>
    An alternative approach is to use the accompanying <b>reffadjust4nlcom</b>
    command to generate the expression for the adjusted coefficient, and pass
    that to <b>nlcom</b> to estimate a delta-method confidence interval.
<p>
    See Buis (2011) for a description of how to retrieve random effect
    variance and correlations from <b>xt</b> commands.
<p>
    <b>Note on multivariate response models:</b>  Covariates (<i>indepvars</i>) in <b>runmlwin</b>
    estimates from multivariate response models have suffix <b>_#</b>, where # is
    the corresponding equation number.  For example, from equation 1 <i>cons</i>
    would be referred to as <i>cons_1</i>.
<p>
    <b>Note on shrinkage estimates:</b>  <b>reffadjustsim</b> uses the estimated random
    effect variances and covariances from the model.  It does not use the
    shrinkage estimates of these parameters, i.e. the variances and
    covariances of the residuals (see chapter 3 of the MLwiN User Manual).
<p>
    <b>Warning about waldtype option:</b>  By default<b> reffadjustsim</b> reports
    coefficients as medians with 2.5 and 97.5 percentiles.  Coefficients can
    be reported as means with Wald-type confidence intervals with the
    <b>waldtype</b> option.  Means and Wald-type confidence intervals may not be
    accurate.  It is always advised to compare results with the default
    output and if possible also with the delta-method confidence interval via
    <b>reffadjust4nlcom</b> and <b>nlcom</b>.  In general, P-values associated with these
    estimates may be affected by boundary value issues in the estimation of
    the random effect variances and covariances (see Distribution theory for
    likelihood ratio tests subsection in <b>[XT] </b><i>xtmixed</i>, Gutierrez et al.
    2001).
<p>
    <b>Interpretation of coefficients:</b>  The coefficients estimated by
    <b>reffadjustsim</b> represent the mean difference in the random effect entered
    as the dependent variable, which is associated with a unit increase in
    each of the random effects entered as independent variables, whilst
    adjusting for the other random effects included as independent variables.
<p>
    <b>Parameters estimated with zero variance:</b>  Sometimes a multilevel model
    can be declared as converged but some parameters (especially random
    effect variances and covariances) may not have a standard error.  A
    warning is issued that resulting confidence intervals may not be valid in
    this case.
<p>
<p>
<a name="options"></a><b><u>Options</u></b>
<p>
    <b>eqn(</b><i>string</i><b>)</b> the name of the equation the coefficients are to be extracted
        from.  For example a two level random effects model from <b>runmlwin</b>
        will typically return four equations (FP1, FP2, RP1, RP2).
<p>
    <b>centileopts(</b><i>string</i><b>)</b> options passed to <b>centile</b>, note you may not specify
        the <b>centile(</b><i>#</i><b>)</b> option here.  The reported percentiles can be changed
        through the <b>level(#)</b> option.
<p>
    <b><u>l</u></b><b>evel(</b><i>#</i><b>)</b>; see <b>[R] estimation options</b>.
<p>
    <b>mcmcsum</b> calculates centiles from the Bayesian posterior distribution of
        the coefficients using chains imported by:  <b>mcmcsum, getchains</b>.  Note
        your <b>runmlwin</b> model must have been fitted by MCMC.  Options: <b>seed</b>, <b>n</b>,
        <b>statadrawnorm</b>, <b>waldtype</b> (and <b>post</b>) are not required/allowed with
        <b>mcmcsum</b>.  Only allowed with <b>runmlwin</b> estimates.
<p>
    <b>n(</b><i>#</i><b>)</b> specifies the number of observations to be simulated.  The default
        is 10,000 and is not allowed to be less than 10.  Not allowed with
        <b>mcmcsum</b>, where <b>n</b> is taken as the number of observations in the
        dataset imported by <b>mcmcsum, getchains</b>.
<p>
    <b>post</b> causes <b>reffadjustsim</b> to behave like a Stata estimation (<b>eclass</b>)
        command.  May only be specified with <b>waldtype</b>.  When <b>post</b> is
        specified, <b>reffadjustsim</b> will post the vector of adjusted estimates
        and its estimated variance-covariance matrix to <b>e()</b>. Thus you could,
        after <b>post</b>ing, treat the estimation results in the same way as you
        would treat results from other Stata estimation commands.  For
        example, after posting, you could redisplay the results by typing
        <b>reffadjustsim</b> without any arguments, or use <b>test</b> to perform
        simultaneous tests of hypotheses on linear combinations of the
        estimates.
<p>
        Specifying <b>post</b> clears out the previous estimation results, which can
        be recovered only by refitting the original model or by storing the
        estimation results before running <b>reffadjustsim</b> and then restoring
        them; see <b>[R] estimates store</b>.
<p>
    <b>replace</b> overwrites variables named <i>beta_indepvar</i> if they exist in the
        dataset.  Only valid with <b>mcmcsum</b>.
<p>
    <b><u>sav</u></b><b>ing(</b><i>filename </i>[<b>,</b><i> replace</i>]<b>)</b> saves the simulated realisations of the
        random effect variances and covariances to <i>filename</i>, optionally
        replacing <i>filename</i> if it exists.
<p>
    <b>seed(</b><i>#</i><b>)</b> specifies the initial value of the random-number seed.  The
        default is the current random-number seed.  Specifying <b>seed(</b><i>#</i><b>)</b> is the
        same as typing <b>set seed</b> <i>#</i> before issuing the command; see <b>set_seed</b>.
        Not allowed with <b>mcmcsum</b>.
<p>
    <b>sf(</b><i>numlist</i><b>)</b> a numlist of scaling factors.  If specified each number
        corresponds to the respective covariate (<i>indepvar</i>), i.e. first number
        is the scaling factor for the first coefficient and so on.  If
        specified the <i>numlist</i> must be the same length as the number of
        covariates.  To scale the coefficient by 2 times the dependent
        variable (<i>Y</i>), for example, then with one covariate (<i>X</i>) specify sf(2).
        To scale the coefficient by 2 times the covariate specify sf(.5)
        because in this case you scale by 2/2^2 since a regression
        coefficient is given by: cov(<i>X</i>,<i>Y</i>)/var(<i>X</i>).
<p>
    <b>statadrawnorm</b> use Stata's <b>drawnorm</b> to simulate the adjusted coefficients.
        For speed by default <b>reffadjustsim</b> uses its own Mata implementation;
        see <b>drawnorm</b>.  Not allowed with <b>mcmcsum</b>.
<p>
    <b><u>sub</u></b><b>level(</b><i>#</i><b>)</b> the sublevel of a repeated group variable.  For example, in
        the following model
<p>
        <b>. xtmixed</b> <i>f_p</i> <b>|| school: z1 z2, nocons cov(id) || school: z3 z4,</b>
            <b>nocons cov(un)</b> <i>options</i>
<p>
        <b>z1</b> and <b>z2</b> are at sublevel 1 and <b>z3</b> and <b>z4</b> are at sublevel 2 of the
        <b>school</b> group variable.
        Only valid with <b>xtmixed</b>, <b>xtmelogit</b>, and <b>xtmepoisson</b>.
<p>
    <b><u>wald</u></b><b>type</b> report coefficients as means with Wald-type confidence
        intervals.  By default <b>reffadjustsim</b> reports coefficients as medians
        and centiles of the simulated coefficients. This option can produce
        inaccurate results, as per the warning above please compare with the
        default output.  Not allowed with <b>mcmcsum</b>.
<p>
<p>
<a name="examples"></a> <b><u>Examples</u></b>
<p>
    ---------------------------------------------------------------------------
    Examples 1 &amp; 2 assume the path to the MLwiN executable is set in <b>global</b>
    <b>MLwiN_path</b>; see runmlwin
<p>
    <b>Example 1: Two level continuous response model</b> (see page 59 of the MLwiN
    User Manual)
<p>
    <b>. * read in data</b>
    <b>. </b><b>use http://www.bristol.ac.uk/cmm/media/runmlwin/tutorial, clear</b>
<p>
    <b>. * fit model using MLwiN via runmlwin</b>
    <b>. </b><b>runmlwin normexam cons standlrt, level1(student: cons) level2(school:</b>
        <b>cons standlrt) batch</b>
<p>
    <b>. * report coefficient as median with 2.5 &amp; 97.5 percentiles</b>
    <b>. </b><b>reffadjustsim cons standlrt, eqn(RP2) seed(12345)</b>
<p>
    <b>. * report coefficient as mean &amp; Wald-type confidence interval</b>
    <b>. * Warning: mean and Wald-type confidence are inaccurate in this example</b>
    <b>. </b><b>reffadjustsim cons standlrt, eqn(RP2) seed(12345) waldtype</b>
<p>
    <b>. * compare with delta-method confidence interval (first refit model)</b>
    <b>. </b><b>runmlwin normexam cons standlrt, level1(student: cons) level2(school:</b>
        <b>cons standlrt) batch</b>
    <b>. </b><b>reffadjust4nlcom cons standlrt, eqn(RP2)</b>
    <b>. </b><b>nlcom `r(beta_standlrt)'</b>
<p>
    <b>. * compare with Bayesian posterior distribution</b>
    <b>. </b><b>runmlwin normexam cons standlrt, level1(student: cons) level2(school:</b>
        <b>cons standlrt) batch mcmc(on) initsprevious seed(121211)</b>
    <b>. </b><b>mcmcsum, getchains</b>
    <b>. </b><b>reffadjustsim cons standlrt, eqn(RP2) mcmcsum</b>
<p>
<p>
    <b>Example 2: Multivariate response model</b> (see page 214 of the MLwiN User
    Manual)
<p>
    <b>. * read in data</b>
    <b>. </b><b>use http://www.bristol.ac.uk/cmm/media/runmlwin/gcsemv1, clear</b>
<p>
    <b>. * fit model using MLwiN via runmlwin</b>
    <b>. </b><b>runmlwin (written cons female, eq(1)) (csework cons female, eq(2)),</b>
        <b>level1(student: (cons, eq(1)) (cons, eq(2))) level2(school: (cons,</b>
        <b>eq(1)) (cons, eq(2))) batch</b>
<p>
    <b>. * report coefficient as median with 2.5 and 97.5 percentiles</b>
    <b>. </b><b>reffadjustsim cons_1 cons_2, eqn(RP2) seed(12345)</b>
   
    <b>. * report coefficient as mean with Wald-type confidence interval</b>
    <b>. </b><b>reffadjustsim cons_1 cons_2, eqn(RP2) seed(12345) waldtype</b>
<p>
    <b>. * compare with delta-method confidence interval (first refit model)</b>
    <b>. </b><b>runmlwin (written cons female, eq(1)) (csework cons female, eq(2)),</b>
        <b>level1(student: (cons, eq(1)) (cons, eq(2))) level2(school: (cons,</b>
        <b>eq(1)) (cons, eq(2))) batch</b>
    <b>. </b><b>reffadjust4nlcom cons_1 cons_2, eqn(RP2)</b>
    <b>. </b><b>nlcom `r(beta_cons_2)'</b>
<p>
    <b>. * compare with Bayesian posterior distribution</b>
    <b>. </b><b>runmlwin (written cons female, eq(1)) (csework cons female, eq(2)),</b>
        <b>level1(student: (cons, eq(1)) (cons, eq(2))) level2(school: (cons,</b>
        <b>eq(1)) (cons, eq(2))) batch mcmc(on) initsprevious seed(121211)</b>
    <b>. </b><b>mcmcsum, getchains</b>
    <b>. </b><b>reffadjustsim cons_1 cons_2, eqn(RP2) mcmcsum</b>
<p>
<p>
    <b>Example 3: based on xtmixed helpfile</b>
    <b>. </b><b>webuse nlswork, clear</b>
    <b>. </b><b>xtmixed ln_w grade age c.age#c.age ttl_exp tenure c.tenure#c.tenure ||</b>
        <b>idcode: tenure, cov(uns) var</b>
    <b>. </b><b>reffadjustsim _cons tenure, eqn(idcode) seed(12345)</b>
<p>
<p>
    <b>Example 4: based on xtmelogit helpfile</b>
    <b>. </b><b>webuse bangladesh, clear</b>
    <b>. </b><b>xtmelogit c_use urban age child* || district: urban, cov(uns) var</b>
    <b>. </b><b>reffadjustsim _cons urban, eqn(district) seed(12345)</b>
<p>
<p>
    <b>Example 5: based on xtmepoisson helpfile</b>
    <b>. </b><b>webuse epilepsy, clear</b>
    <b>. </b><b>xtmepoisson seizures treat lbas lbas_trt lage visit || subject: visit,</b>
        <b>cov(uns) var intpoints(9)</b>
    <b>. </b><b>reffadjustsim _cons visit, eqn(subject) seed(12345)</b>
<p>
<p>
    <b>Example 6: repeated group variable</b>
    <b>. </b><b>webuse nlswork, clear</b>
    <b>. </b><b>xtmixed ln_w grade age || idcode: tenure union, cov(uns) || idcode:</b>
        <b>race, cov(uns) var</b>
    <b>. </b><b>reffadjustsim tenure union, eqn(idcode) sub(1) seed(12345)</b>
    <b>. </b><b>reffadjustsim race _cons, eqn(idcode) sub(2) seed(12345)</b>
    ---------------------------------------------------------------------------
<p>
<p>
<a name="saved_results"></a><b><u>Saved results</u></b>
<p>
    <b>reffadjustsim</b> saves the following in <b>r()</b>:
<p>
    Scalars        
      <b>r(N)</b>                number of simulated observations
<p>
    If <b>waldtype</b> is not specified, <b>reffadjustsim</b> saves the following for each
    indepvar in <b>r()</b>:
<p>
    Scalars        
      <b>r(n_cent_indepvar)</b>  number of centiles requested (usually 2)
      <b>r(c_1_indepvar)</b>     value of 1st centile for indepvar
      <b>r(lb_1_indepvar)</b>    1st centile lower confidence bound
      <b>r(ub_1_indepvar)</b>    1st centile upper confidence bound
      <b>r(c_2_indepvar)</b>     value of 2nd centile for indepvar
      <b>r(lb_2_indepvar)</b>    2nd centile lower confidence bound
      <b>r(ub_2_indepvar)</b>    2nd centile upper confidence bound
      <b>r(med_indepvar)</b>     median of indepvar
      <b>r(lb_med_indepvar)</b>  median lower confidence bound
      <b>r(ub_med_indepvar)</b>  median upper confidence bound
<p>
    If <b>waldtype</b> is specified, <b>reffadjustsim</b> saves the following in <b>r()</b>:
<p>
    Matrices       
      <b>r(b)</b>                vector of adjusted coefficients
      <b>r(V)</b>                estimated variance-covariance matrix of the
                            adjusted coefficients
<p>
    If <b>waldtype</b> and <b>post</b> are specified, <b>reffadjustsim</b> also saves the
    following in <b>e()</b>:
<p>
    Scalars        
      <b>e(N)</b>                number of simulated observations
<p>
    Macros         
      <b>e(cmd)</b>              <b>reffadjustsim</b>
      <b>e(depvar)</b>           name of the dependent variable
      <b>e(properties)</b>       <b>b V</b>
<p>
    Matrices       
      <b>e(b)</b>                vector of adjusted coefficients
      <b>e(V)</b>                estimated variance-covariance matrix of the
                            adjusted coefficients
<p>
<p>
<a name="references"></a><b><u>References</u></b>
<p>
    Buis ML. 2011. Stata tip 97: Getting at rho's and sigma's. The Stata
        Journal. 11(2) 315-317.
<p>
    Fisher RA. 1925. Chapter 5: Tests of significance of means, differences
        of means, and regression coefficients, Section 29:  Regression with
        several independent variates in Statistical Methods for Research
        Workers. Oliver and Boyd, Edinburgh.
<p>
    Gutierrez RG, Carter S, Drukker DM. 2001. sg160: On boundary-value
        likelihood ratio tests. Stata Technical Bulletin. 60. 15-18.
<p>
    Leckie G, Charlton C. 2011. <b>runmlwin</b>: Stata module for fitting multilevel
        models in the MLwiN software package. Centre for Multilevel
        Modelling, University of Bristol, UK. 
        http://www.bristol.ac.uk/cmm/software/runmlwin/
<p>
    Macdonald-Wallis C, Lawlor DA, Palmer TM, Tilling K. 2011 (submitted).
        Multivariate multilevel spline models for parallel growth processes:
        application to weight and mean arterial pressure in pregnancy.
        Statistics in Medicine.
<p>
    Rasbash J, Charlton C, Browne WJ, Healy M, Cameron B. 2009. MLwiN version
        2.1. Centre for Multilevel Modelling, University of Bristol, UK. 
        http://www.bristol.ac.uk/cmm/software/mlwin.
<p>
    Rasbash J, Steele F, Browne WJ, Goldstein H. 2009. A user's guide to
        MLwiN, v2.10. Centre for Multilevel Modelling, University of Bristol,
        UK. 
        http://www.bristol.ac.uk/cmm/software/mlwin/download/manuals.html.
<p>
<p>
<a name="authors"></a><b><u>Authors</u></b>
<p>
    Tom Palmer, MRC Centre for Causal Analyses in Translational Epidemiology,
        School of Social and Community Medicine, University of Bristol, UK.
        tom.palmer@bristol.ac.uk.
<p>
    Corrie Macdonald-Wallis, MRC Centre for Causal Analyses in Translational
        Epidemiology, School of Social and Community Medicine, University of
        Bristol, UK.  c.macdonald-wallis@bristol.ac.uk.
<p>
    Kate Tilling, School of Social and Community Medicine, University of
        Bristol, UK.
<p>
<p>
<b><u>Also see</u></b>
<p>
      Help:  <b>reffadjust</b>, <b>reffadjust4nlcom</b>, <b>runmlwin</b> (if installed), <b>mcmcsum</b>
             (if installed), <b>nlcom</b>, <b>xtmixed</b>, <b>xtmelogit</b>, <b>xtmepoisson</b>
</pre>