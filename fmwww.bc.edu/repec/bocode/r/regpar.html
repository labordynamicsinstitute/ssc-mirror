<pre>
-------------------------------------------------------------------------------
help for <b>regpar</b>                                                  (Roger Newson)
-------------------------------------------------------------------------------
<p>
<b><u>Population attributable and unattributable risks from binary regression models</u></b>
<p>
        <b>regpar</b> [<i>if</i>] [<i>in</i>] [<i>weight</i>] , [ <b><u>at</u></b><b>spec(</b><i>atspec</i><b>)</b> <b><u>atz</u></b><b>ero(</b><i>atspec0</i><b>)</b>
                     <b>subpop(</b><i>subspec</i><b>)</b> <b><u>pr</u></b><b>edict(</b><i>pred_opt</i><b>)</b> <b>vce(</b><i>vcespec</i><b>)</b> <b>no</b><b><u>e</u></b><b>sample</b>
                     <b>force</b> <b><u>iter</u></b><b>ate(</b><i>#</i><b>)</b> <b><u>l</u></b><b>evel(</b><i>#</i><b>)</b> <b>post</b> ]
<p>
    where <i>atspec</i> and <i>atspec0</i> are at-specifications recognized by the <b>at()</b>
    option of <b>margins</b>, <i>subspec</i> is a subpopulation specification of the form
    recognized by the <b>subpop()</b> option of <b>margins</b>, and <i>vcespec</i> is a
    variance-covariance specification of the form recognized by <b>margins</b>, and
    must have one of the values
<p>
    <b>delta</b> | <b>unconditional</b>
<p>
    <b>fweight</b>s, <b>aweight</b>s, <b>iweight</b>s, <b>pweight</b>s are allowed; see weight.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>regpar</b> calculates confidence intervals for population attributable risks,
    and also for scenario proportions.  <b>regpar</b> can be used after an
    estimation command whose predicted values are interpreted as conditional
    proportions, such as <b>logit</b>, <b>logistic</b>, <b>probit</b>, or <b>glm</b>.  It estimates two
    scenario proportions, a baseline scenario ("Scenario 0") and a fantasy
    scenario ("Scenario 1"), in which one or more exposure variables are
    assumed to be set to particular values (typically zero), and any other
    predictor variables in the model are assumed to remain the same.  It also
    estimates the difference between the Scenario 0 proportion and the
    Scenario 1 proportion.  This difference is known as the population
    attributable risk (PAR), and represents the amount of risk attributable
    to living in Scenario 0 instead of Scenario 1.
<p>
<p>
<b><u>Options for </u></b><b><u>regpar</u></b>
<p>
    <b>atspec(</b><i>atspec</i><b>)</b> is an at-specification, allowed as a value of the <b>at()</b>
        option of <b>margins</b>.  This at-specification must specify a single
        scenario ("Scenario 1"), defined as a fantasy world in which a subset
        of the predictor variables in the model are set to values different
        from their value in the baseline scenario (denoted "Scenario 0" and
        equal to the real-life scenario unless <b>atzero()</b> is specified).
        <b>regpar</b> uses the <b>margins</b> command to estimate the proportions of
        outcome values positive under Scenarios 0 and 1, and then uses <b>nlcom</b>
        to estimate the logits of these 2 scenario proportions, and the
        hyperbolic arctangent (or Fishers's <i>z</i>-transform) of the difference
        between the Scenario 0 proportion and the Scenario 1 proportion,
        known as the population attributable risk (PAR).  The proportion
        positive under Scenario 1 is known as the population unattributable
        risk (PUR).  If <b>atspec()</b> is not specified, then its default value is
        <b>atspec((asobserved) _all)</b>, implying that Scenario 1 is the real-life
        baseline scenario, represented by the predictor values actually
        present.
<p>
    <b>atzero(</b><i>atspec0</i><b>)</b> is an at-specification, allowed as a value of the <b>at()</b>
        option of <b>margins</b>.  This at-specification must specify a single
        baseline scenario ("Scenario 0"), defined as an alternative fantasy
        world in which a subset of predictors in the model are set to the
        values specified by <i>atspec0</i>.  Scenario 0 will then be compared to the
        "Scenario 1" specified by the <b>atspec()</b> option.  If <b>atzero()</b> is not
        specified, then its default value is <b>atzero((asobserved) _all)</b>,
        implying that Scenario 0 is the real-life baseline scenario,
        represented by the predictor values actually present.
<p>
    <b>subpop(</b><i>subspec</i><b>)</b>, <b>predict(</b><i>pred_opt</i><b>)</b> and <b>vce(</b><i>vcespec</i><b>)</b> have the same form
        and function as the options of the same names for <b>margins</b>.  They
        specify the subpopulation, the predict option(s), and the
        variance-covariance matrix formula, respectively, used to estimate
        the scenario proportions, and therefore to estimate the population
        attributable risk.
<p>
    <b>noesample</b> has the same function as the option of the same name for 
        <b>margins</b>.  It specifies that computations will not be restricted to
        the estimation sample used by the previous estimation command.
<p>
    <b>force</b> has the same function as the option of the same name for <b>margins</b>.
<p>
    <b>iterate(</b><i>#</i><b>)</b> has the same form and function as the option of the same name
        for <b>nlcom</b>.  It specifies the number of iterations used by <b>nlcom</b> to
        find the optimal step size to calculate the numerical derivatives of
        the logits of the scenario proportions and the <i>z</i>-transform of their
        difference, with respect to the original scenario proportions
        calculated by <b>margins</b>.
<p>
    <b>level(</b><i>#</i><b>)</b> specifies the percentage confidence level to be used in
        calculating the confidence intervals.  If it is not specified, then
        it is taken from the current value of the c-class value <b>c(level)</b>,
        which is usually 95.
<p>
    <b>post</b> specifies that <b>regpar</b> will post in <b>e()</b> the estimation results for
        estimating the logits of the scenario means and the <i>z</i>-transform of
        their difference, the PAR.  If <b>post</b> is not specified, then any
        existing estimation results are left in <b>e()</b>.  Note that the
        estimation results posted are for the logits of the scenario
        proportions and the <i>z</i>-transform of their difference, and not for the
        proportions themselves and their difference.  This is done because
        the estimation results are intended to define symmetric confidence
        intervals for the transformed parameters, which can be
        back-transformed to define asymmetric confidence intervals for the
        untransformed parameters.
<p>
<p>
<b><u>Remarks</u></b>
<p>
    <b>regpar</b> estimates the population attributable risk, defined in its
    simplest unadjusted form by Gordis (2000).  The general principles behind
    scenario comparisons for generalized linear models were introduced in
    Lane and Nelder (1982).
<p>
    <b>regpar</b> starts by estimating the logits of the scenario proportions and
    the hyperbolic arctangent or Fisher's <i>z</i>-transform of their difference
    (the PAR), using <b>margins</b> and <b>nlcom</b>.  The results of this estimation are
    stored in <b>e()</b>, if the option <b>post</b> is specified.  These estimation results
    may be saved in an output dataset (or resultsset) by the <b>parmest</b> package,
    which can be downloaded from SSC.
<p>
    <b>regpar</b> assumes that the most recent estimation command estimates the
    parameters of a regression model, whose fitted values are conditional
    proportions, which must be bounded between 0 and 1.  It is the user's
    responsibility to ensure that this is the case.  However, it will be true
    if the conditional proportions are defined using a generalized linear
    model with a Bernoulli variance function (<i>not</i> a non-Bernoulli binomial
    variance function), and a logit, probit or complementary log-log link
    function.
<p>
    Note that population attributable and unattributable risks (PARs and
    PURs) are not the same parameters as population attributable and
    unattributable fractions (PAFs and PUFs).  A population attributable risk
    is a difference between scenario proportions, a population unattributable
    fraction is a ratio between scenario proportions (or means), and a
    population attributable fraction is the result of subtracting a
    population unattributable fraction from 1.  Users who need to estimate
    population unattributable fractions should use either <b>punaf</b> (for cohort
    or cross-sectional study data) or <b>punafcc</b> (for case-control or survival
    study data).  Users who need to estimate scenario prevalences (without
    differences) should use <b>margprev</b>.  Users who need to estimate
    log-transformed scenario means (without ratios) should use <b>marglmean</b>.
    The packages <b>punaf</b>, <b>punafcc</b>, <b>margprev</b> and <b>marglmean</b> are downloadable from
    SSC.
<p>
    Note, also, that <b>regpar</b> estimates population attributable risks (PARs)
    using an indirect-standardization method, based on a regression model.
    Alternatively, a user can estimate the PAR using a direct-standardization
    method, based on rank statistics.  This can be done using the <b>scsomersd</b>, 
    <b>somersd</b> and <b>expgen</b> packages, which also are downloadable from SSC.
<p>
<p>
<b><u>Examples</u></b>
<p>
    The following examples use the dataset <b>lbw.dta</b>, provided by Hosmer and
    Lemeshow (1988) and used in <b>[R] logistic</b> and distributed by Stata Press.
    This dataset has 1 observation for each of a sample of pregnancies, and
    data on the birth weight of the baby and on a list of predictive
    variables, which might be assumed to be causal by some scientists.
<p>
    Setup
<p>
        <b>.use http://www.stata-press.com/data/r11/lbw.dta, clear</b>
        <b>.describe</b>
<p>
    The following example estimates population unattributable and
    attributable risks for maternal smoking during pregnancy as a predictor
    of low birth weight.  This is done by comparing "Scenario 1" (a fantasy
    world in which no pregnant women smoke) with "Scenario 0" (the real world
    in which the data were collected).
<p>
        <b>. logit low i.race i.smoke, or robust</b>
        <b>. regpar, at(smoke=0)</b>
<p>
    The following example estimates population unattributable and
    attributable risks for maternal smoking and non-white race.  This is done
    by comparing "Scenario 1" (a fantasy world in which all pregnant women
    are white and no pregnant women smoke) with "Scenario 0" (the real world
    in which the data were collected).
<p>
        <b>.logit low i.race i.smoke, or robust</b>
        <b>.regpar, at(smoke=0 race=1)</b>
<p>
    The following example demonstrates the use of <b>regpar</b> with a univariate
    model of low birth weight with respect to maternal smoking status, to
    estimate total and exposed PARs.  We <b>logit</b> to estimate the odds ratio of
    low birth weight with respect to maternal smoking, and use <b>regpar</b> to
    estimate the scenario proportions and PARs, first for the total
    population, then for the smoking-exposed subpopulation.  Finally, we use
    <b>regpar</b> with the <b>atzero()</b> option to compare 2 alternative fantasy
    scenarios, a "Scenario 0" in which no mothers smoke and a "Scenario 1" in
    which all mothers smoke.  Note that, in this comparison, the PAR is
    negative, because a world of non-smoking mothers would have fewer low
    birth weight babies than a world of smoking mothers.
<p>
        <b>.logit low i.smoke, or robust</b>
        <b>.regpar, at(smoke=0)</b>
        <b>.regpar if smoke==1, at(smoke=0)</b>
        <b>.regpar, at(smoke=1) atzero(smoke=0)</b>
<p>
    The following example demonstrates the use of <b>regpar</b> with the <b>parmest</b>
    package, downloadable from SSC.  The population unattributable and
    attributable risks for smoking are estimated using <b>regpar</b> (with the <b>post</b>
    option), and saved (in their transformed versions), using <b>parmest</b>, in a
    dataset in memory, overwriting the original dataset, with 1 observation
    for each of the 3 transformed parameters, named <b>"Scenario_0"</b>,
    <b>"Scenario_1"</b> and <b>"PAR"</b>, and data on the estimates, confidence limits,
    <i>P</i>-values, and other parameter attributes.  We then use <b>replace</b> to replace
    the symmetric confidence intervals for the transformed parameters with
    asymmetric confidence intervals for the untransformed parameters, and 
    <b>describe</b> and <b>list</b> the new dataset.
<p>
        <b>. logit low i.race i.smoke, or robust</b>
        <b>. regpar, at(smoke=0) post</b>
        <b>. parmest, norestore</b>
        <b>. foreach Y of var estimate min* max* {</b>
        <b>. replace `Y'=invlogit(`Y') if parm!="PAR"</b>
        <b>. replace `Y'=tanh(`Y') if parm=="PAR"</b>
        <b>. }</b>
        <b>. describe</b>
        <b>. list</b>
<p>
<p>
<b><u>Saved results</u></b>
<p>
    <b>regpar</b> saves the following in <b>r()</b>:
<p>
    Scalars        
      <b>r(rank)</b>             rank of <b>r(V)</b>
      <b>r(N)</b>                number of observations
      <b>r(N_sub)</b>            subpopulation observations
      <b>r(N_clust)</b>          number of clusters
      <b>r(N_psu)</b>            number of samples PSUs, survey data only
      <b>r(N_strata)</b>         number of strata, survey data only
      <b>r(df_r)</b>             variance degrees of freedom, survey data only
      <b>r(N_poststrata)</b>     number of post strata, survey data only
      <b>r(k_margins)</b>        number of terms in <i>marginlist</i>
      <b>r(k_by)</b>             number of subpopulations
      <b>r(k_at)</b>             number of <b>at()</b> options (always 2)
      <b>r(level)</b>            confidence level of confidence intervals
<p>
    Macros         
      <b>r(atzero)</b>           <b>atzero()</b> option
      <b>r(atspec)</b>           <b>atspec()</b> option
<p>
    Matrices       
      <b>r(cimat)</b>            vector containing estimates and confidence limits
                            for the scenario proportions and the PAR
      <b>r(b)</b>                vector of logits of scenario proportions and their
                            <i>z</i>-transformed difference
      <b>r(V)</b>                estimated variance-covariance matrix of the logits
                            of scenario proportions and their <i>z</i>-transformed
                            difference
<p>
    If <b>post</b> is specified, <b>regpar</b> also saves the following in <b>e()</b>:
<p>
    Scalars        
      <b>e(rank)</b>             rank of <b>e(V)</b>
      <b>e(N)</b>                number of observations
      <b>e(N_sub)</b>            subpopulation observations
      <b>e(N_clust)</b>          number of clusters
      <b>e(N_psu)</b>            number of samples PSUs, survey data only
      <b>e(N_strata)</b>         number of strata, survey data only
      <b>e(df_r)</b>             variance degrees of freedom, survey data only
      <b>e(N_poststrata)</b>     number of post strata, survey data only
      <b>e(k_margins)</b>        number of terms in <i>marginlist</i>
      <b>e(k_by)</b>             number of subpopulations
      <b>e(k_at)</b>             number of <b>at()</b> options (always 2)
<p>
    Macros         
      <b>e(cmd)</b>              <b>regpar</b>
      <b>e(predict)</b>          program used to implement <b>predict</b>
      <b>e(atzero)</b>           <b>atzero()</b> option
      <b>e(atspec)</b>           <b>atspec()</b> option
      <b>e(properties)</b>       <b>b V</b>
<p>
    Matrices       
      <b>e(b)</b>                vector of logits of scenario proportions and their
                            <i>z</i>-transformed difference
      <b>e(V)</b>                estimated variance-covariance matrix of the logits
                            of scenario proportions and their <i>z</i>-transformed
                            difference
      <b>e(V_srs)</b>            simple-random-sampling-without-replacement
                            (co)variance hat V_srswor, if <b>svy</b>
      <b>e(V_srswr)</b>          simple-random-sampling-with-replacement
                            (co)variance hat V_srswr, if <b>svy</b> and <b>fpc()</b>
      <b>e(V_msp)</b>            misspecification (co)variance hat V_msp, if <b>svy</b> and
                            available
<p>
    Functions      
      <b>e(sample)</b>           marks estimation sample
<p>
<p>
<b><u>Author</u></b>
<p>
    Roger Newson, National Heart and Lung Institute, Imperial College London,
    UK.
    Email: r.newson@imperial.ac.uk
<p>
<p>
<b><u>References</u></b>
<p>
<a name="gordis_2000"></a>    Gordis, L.  2000.  <i>Epidemiology. 2nd ed.</i>  Philadelphia, PA: W. B.
        Saunders.
<p>
<a name="hosmer_1988"></a>    Hosmer Jr., D. W., S. Lemeshow, and J. Klar.  1988.  Goodness-of-fit
        testing for the logistic regression model when the estimated
        probabilities are small.  <i>Biometrical Journal</i> <b>30</b>: 911–924.
<p>
<a name="lane_1982"></a>    Lane, P. W., and J. A. Nelder.  1982.  Analysis of covariance and
        standardization as instances of prediction.<i>  Biometrics</i> <b>38</b>: 613–621.
<p>
<p>
<b><u>Also see</u></b>
<p>
    Manual:  <b>[R] margins</b>, <b>[R] nlcom</b>, <b>[R] logistic</b>, <b>[R] logit</b>, <b>[R] probit</b>, <b>[R]</b>
             <b>glm</b>
<p>
      Help:  <b>[R] margins</b>, <b>[R] nlcom</b>, <b>[R] logistic</b>, <b>[R] logit</b>, <b>[R] probit</b>, <b>[R]</b>
             <b>glm</b>
             <b>punaf</b>, <b>punafcc</b>, <b>margprev</b>, <b>marglmean</b>, <b>parmest</b>, <b>scsomersd</b>, 
             <b>somersd</b>, <b>expgen</b> if installed
</pre>