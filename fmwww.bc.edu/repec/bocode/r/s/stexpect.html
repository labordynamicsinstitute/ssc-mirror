<pre>
-------------------------------------------------------------------------------
help for <b>stexpect</b>                                                            EC
-------------------------------------------------------------------------------
<p>
<b><u>Compute and tabulate Expected Survival</u></b>
<p>
        <b>stexpect</b> [ <i>newvarname</i> ] [<b>if</b> <i>exp</i>] [<b>in</b> <i>range</i>] <b>,</b> <b>ratevar(</b><i>varname</i><b>)</b>
               [<b><u>out</u></b><b>put(</b><i>filename</i> [<b>,replace</b>]<b>)</b> [ <b><u>met</u></b><b>hod(</b><i>#</i><b>)</b> <b>at(</b><i>numlist</i><b>)</b>
               <b>by(</b><i>varlist</i><b>)</b> <b><u>np</u></b><b>oints(</b><i>#</i><b>)</b> <b><u>noli</u></b><b>st</b>]
<p>
<p>
    <b>stexpect</b> is for use with survival-time data; see help st. You must <b>stset</b>
    your data using the <b>id()</b> option before using this command; see help 
    stset.
<p>
    <b>stexpect</b> tabulates the expected survival probability. You must specify in
    <b>ratevar(</b><i>varname</i><b>)</b> the reference rate variable.
<p>
<b><u>Description</u></b>
<p>
    Expected survival is used to produce an overall survival curve. This is
    then added to the Kaplan-Meier plot of the study group for visual
    comparison between these subjects and the population at large. Before
    estimating the expected survival we have to specify a different follow-up
    time for the study group according to three common methods of computing
    it.
<p>
    In the Ederer or "exact" method the subjects in the study cohort are not
    censored or dead before the end of a stated follow-up time. Let us assume
    that the subjects of the cohort are enrolled from 1985 to 1990 and that
    we want to estimate the expected survival until ten years from the start
    of the follow-up. If <i>entrydate</i> is a decimal date, we set <i>timevar</i> as
    follows:
<p>
    <b>. gen survtime = entrydate + 10</b>
<p>
     
    In the Hakulinen method, follow up time is the actual censoring time for
    those patients who are censored and the maximum potential follow up for
    those who die, i.e. the most optimistic last contact date. In the
    previous example let the follow-up be terminated June 30, 2000, <i>status</i> is
    1 if the subject dies and 0 otherwise, <i>exitdate</i> is the actual follow-up
    time. Then
<p>
    <b>. gen survtime = cond(status,2000.5,exitdate)</b>
<p>
<p>
    Conditional method (or Ederer II) is simpler in respect of this, because
    follow-up time is what it actually is, either the subject dies or not,
    i.e.:
<p>
    <b>. gen survtime = exitdate</b>
<p>
<p>
    Combining the observed survival function produced by <b>sts generate</b> and the
    expected survival estimated with <b>stexpect</b>, it is easy to achieve the
    relative survival function, the preferred survival measure in cancer
    registry activity. In a context of population-based cancer registry data,
    due to the large number of cases frequently involved, <b>stexpect</b> memory
    requirements can exceed the available RAM. In this case the expected
    survival function can still be estimated using the <b>npoints(</b><i>#</i><b>)</b> option.
<p>
<p>
<p>
<b><u>Options</u></b>
<p>
    <b>ratevar(</b><i>varname</i><b>)</b> is not an option. It specifies a reference rate
        variable.
<p>
    <b>output(</b><i>filename</i> [<b>,replace</b>]<b>)</b> saves a dataset in <i>filename</i>.  The file
        contains the expected survival probability, the time to which it
        refers and the number at risk. If not specified in <i>newvarname</i>,
        expected survival will be stored in a variable named Survexp.
<p>
    <b>method(</b><i>#</i><b>)</b> defines the method to be used according to the following
        numerical codes:
        1 = Ederer
        2 = Conditional (Ederer II)
        3 = Hakulinen
        Hakulinen is the default.
<p>
    <b>at(</b><i>numlist</i><b>)</b> specifies time intervals at which the expected survival is to
        be computed. It is not an option if <b>method(</b><i>1</i><b>)</b> (Ederer) is chosen. If,
        using the other methods, <b>at(</b><i>numlist</i><b>)</b> is omitted an estimate is
        returned for each unique survival time.
<p>
    <b>by(</b><i>varlist</i><b>)</b> specifies up to 5 by variables and produces separate
        estimates for each group identified by equal values of the <b>by()</b>
        variable(s) taking on integer or string values.
<p>
    <b>npoints(</b><i>#</i><b>)</b> specifies the number of the points at which to calculate
        intermediate results, evenly spaced over the range of the survival
        times. The usual calculation is done at each unique follow-up time.
        Therefore <b>stexpect</b> may require great amounts of memory. For large
        datasets specifying <b>npoints(</b><i>#</i><b>)</b> can reduce the amount of memory and
        computation required.
          
    <b>nolist</b> suppresses the output.  This is used only when saving results to a
        file specified by <b>output()</b>.
<p>
<b><u>Example</u></b>
<p>
    The following example uses the <b>mgus</b> data, downloadable from prof. T.
    Therneau's web page at 
    http://www.mayo.edu/hsr/people/therneau/book/book.html.  File <b>survexp.us</b>
    freely available within R package has been used as source of the US
    reference rates. They have been transformed in annual rates and saved as
    a Stata data file named <b>usrate</b>. Both files are included in the package.
<p>
    The example illustrates how to plot the observed and the expected
    survival estimated using both Ederer's method and Hakulinen's method.
    When Conditional method is applied, Conditional and Hakulinen's expected
    survival are plotted together with the observed survival.
<p>
<u>Observed Survival</u>
        <b>.use mgusexample,clear</b>
        <b>.stset time, failure(status) scale(365.25)</b>
        <b>.sts gen kaplan = s,by(sex)</b>
        <b>.gen kapmale=kaplan if sex==1</b>
        <b>.gen kapfemale=kaplan if sex==2</b>
        <b>.label var kapmal "S(males)"</b>
        <b>.label var kapfem "S(females)"</b>
        <b>.preserve</b>
<p>
<p>
<u>Ederer Method</u>
        In this example the stated follow-up time is 30 years.  
        <b>.gen survederer=30 *365.25</b>
        <b>.stset survederer, f(status) id(id) scale(365.25) noshow</b>
        
        Usually, to use reference population rates, data have to be splitted 
        by age band and calendar year and then merged with a suitable file wher
&gt; e
        reference rates are stored.
        <b>.stsplit fu, at(0(1)30)</b>
        <b>.gen year = yeardiagnosis + fu</b>
        <b>.gen age = agediagnosis + fu</b>
        <b>.sort year age sex</b>
        <b>.merge year age sex using usrate, uniqus nokeep</b>
        
        Now expected survival is saved in a file named mgusederer
        <b>.stexpect ederer, ratevar(rate) at(0(1)30) out(mgusederer,replace) meth</b>
<b>&gt; od(1) by(sex)</b>
<p>
        Note that t_exp is the time at which expected survival has been estimat
&gt; ed
        <b>.use mgusederer,clear</b>
        <b>.gen edermale = ederer if sex==1</b>
        <b>.gen ederfemale = ederer if sex==2</b>
        <b>.save mgusederer,replace</b>
        <b>.restore,preserve</b>
<p>
        The two files are joined
        <b>.append using mgusederer</b>
<p>
        <b>.twoway (line kapmale kapfemale _t, sort c(J J) clc(blue*1.3 red*1.3)) </b>
<b>&gt; ///</b>
            <b>(lowess edermale t_exp, bw(.3) clc(blue*1.3)) ///</b>
            <b>(lowess ederfemale t_exp, bw(.3) clc(red*1.3)), ///</b> 
            <b>xti("Years of Follow Up") yti("Survival") xla(0(5)30) ///</b>
            <b>legend(label(3 "Expexted males") label(4 "Expected females") pos(7)</b>
<b>&gt;  ring(0) col(1)) ///</b>
            <b>t1t("MGUS example") t2t("Ederer Method")</b>
<p>
-------------------------------------------------------------------------------
<p>
<u>Hakulinen Method</u>
        In this study the follow-up was closed at 1st august 1990.
        Then, the potential follow-up if death occurs is determined as the
        difference between this date and the date of diagnosis.
<p>
        <b>.use mgusexample,clear</b>
        <b>.gen survhakulinen = cond(status,mdy(8,1,1990) - datediagnosis, time)</b>
        <b>.stset survhakulinen, f(status) id(id) scale(365.25) noshow</b>
        <b>.stsplit fu, at(0(1)30)</b>
        <b>.gen year = yeardiagnosis + fu</b>
        <b>.gen age = agediagnosis + fu</b>
        <b>.sort year age sex</b>
        <b>.merge year age sex using usrate, uniqus nokeep</b>
        <b>.stexpect hakulinen, ratevar(rate) at(0(1)30) out(mgushakulinen,replace</b>
<b>&gt; ) by(sex)</b>
        <b>.use mgushakulinen,clear</b>
        <b>.gen hakulmale = hakulinen if sex==1</b>
        <b>.gen hakulfemale = hakulinen if sex==2</b>
        <b>.save mgushakulinen,replace</b>
        <b>.restore, preserve</b>
        <b>.append using mgushakulinen</b>
        <b>.twoway (line kapmal kapfem _t, sort c(J J) clc(blue*1.3 red*1.3)) ///</b>
                <b>(lowess hakulmale t_exp, bw(.3) clc(blue*1.3)) ///</b>
                <b>(lowess hakulfemale t_exp, bw(.3) clc(red*1.3)), ///</b>
                <b>xti("Years of Follow Up") yti("Survival") xla(0(5)30) ///</b>
                <b>legend(label(3 "Expexted males") label(4 "Expected females") po</b>
<b>&gt; s(7) ring(0) col(1)) ///</b>
                <b>t1t("MGUS example") t2t("Hakulinen Method")</b>
<p>
-------------------------------------------------------------------------------
<p>
<u>Conditional Method</u>
        <b>.use mgusexample,clear</b>
<p>
Actual Follow up
        <b>.stset time, f(status) id(id) scale(365.25) noshow</b>
        <b>.stsplit fu, at(0(1)30)</b>
        <b>.gen year = yeardiagnosis + fu</b>
        <b>.gen age = agediagnosis + fu</b>
        <b>.sort year age sex</b>
        <b>.merge year age sex using usrate, uniqus nokeep</b>
        <b>.stexpect conditional, ratevar(rate) at(0(1)30) out(mgusconditional,rep</b>
<b>&gt; lace) by(sex) method(2)</b>
        <b>.use mgusconditional,clear</b>
        <b>.gen condmale = conditional if sex==1</b>
        <b>.gen condfemale = conditional if sex==2</b>
        <b>.save mgusconditional,replace</b>
        <b>.restore</b>
        <b>.append using mgushakulinen</b>
        <b>.append using mgusconditional</b>
        <b>.twoway (line kapmale kapfemale _t,sort c(J J) clc(blue*1.3 red*1.3)) /</b>
<b>&gt; //</b>
                <b>(lowess hakulmale t_exp, bw(.3) clc(blue*1.3)) ///</b>
                <b>(lowess hakulfemale t_exp, bw(.3) clc(red*1.3)) ///</b>
                <b>(lowess condmale t_exp, bw(.3) clc(black) clp(shortdash)) ///</b>
                <b>(lowess condfemale t_exp, bw(.3) clc(black) clp(shortdash)), //</b>
<b>&gt; /</b>
                <b>xti("Years of Follow Up") yti("Survival") xla(0(5)30) ///</b>
                <b>legend(label(3 "Hakulinen males") label(4 "Hakulinen females") </b>
<b>&gt; ///</b>
                <b>label(5 "Conditional males") label(6 "Conditional females") pos</b>
<b>&gt; (2) ring(0) col(1)) ///</b>
                <b>t1t("MGUS example") t2t("Conditional vs Hakulinen Method")</b>
<p>
<p>
    Setting mgusexample.dta and usrate.dta in one of your <b>`"`c(adopath)'"'</b>
    directory you can run this example.
<p>
          <i>(</i><i>click to run</i><i>)</i>
<p>
<p>
<p>
<b><u>References</u></b>
<p>
    Therneau TM., Grambsch PM., Modeling Survival Data Extending the Cox
    Model, p. 261 - 287. Springer, 2000.
<p>
<p>
<p>
<b><u>Author</u></b>
<p>
    Enzo Coviello, Department of Prevention ASL BA/1, Minervino Murge, IT.
    Email: enzo.coviello@tin.it
<p>
<p>
<b><u>Also see</u></b>
<p>
    Manual: <b>[ST] sts generate</b>, <b>[ST] strate</b>
<p>
</pre>