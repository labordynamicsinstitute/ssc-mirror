<pre>
<p>
<b>help reweight </b>                                                                 
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
<p>
    <b>reweight</b> -- Reweights survey variables using external aggregate totals
<p>
<b><u>Syntax</u></b>
<p>
        <b>reweight</b> <i>varlist</i> [<i>if</i>] [<i>in</i>] <b>,</b> <b><u>sw</u></b><b>eight(</b><i>varname</i><b>)</b> <b><u>nw</u></b><b>eight</b>(<i>newvar</i>)
               <b><u>tot</u></b><b>al</b>(<i>matrix</i>) <b><u>df</u></b><b>unction</b>(<i>name</i>) [<b><u>sv</u></b><b>alues</b>(<i>matrix</i>) <b><u>tol</u></b><b>erance(</b>#<b>)</b>
               <b>niter(</b>#<b>)</b> <b><u>nt</u></b><b>ries(</b>#<b>)</b> <b><u>upb</u></b><b>ound(</b>#<b>)</b> <b><u>lowb</u></b><b>ound(</b>#<b>)</b> <b><u>mlowb</u></b><b>ounds(</b>#<b>)</b>
               <b><u>mupb</u></b><b>ounds(</b>#<b>)</b>]
<p>
<b><u>Description</u></b>
<p>
    <b>reweight</b> calibrates survey data to external aggregate totals. The
    methodology closely follows Deville and Deville and Sarndal (1992) and
    the recursive algorithm that implements the calibration is from Creedy
    (2003).
<p>
<b><u>Options for reweight</u></b>
<p>
    <b>sweight(</b><i>varname</i><b>)</b> is required and specifies a numeric variable for the
        original survey weights.
<p>
    <b>nweight(</b><i>name</i><b>)</b> is required and defines the name of the new variable
        containing the calibrated weights.
<p>
    <b>total(</b><i>matrix</i><b>)</b> is required and contains a Stata 1xK matrix with the
        user-provided totals, with arguments to be inserted in the same order
        as the K calibrating variables in <i>varlist</i>.
<p>
    <b>dfunction(</b><i>name</i><b>)</b> specifies the distance function to be used when computing
        the new weights.  The allowed distance functions are the chi-squared
        (type "<b>chi2</b>"), the Deville and Sarndal's (type "<b>ds</b>") and three more,
        which we define as type-A (type "<b>a</b>"), type-B (type "<b>b</b>") and type-C
        (type "<b>c</b>") distant functions. See Pacifico (2010) for details.
<p>
    <b>svalues(</b><i>matrix</i><b>)</b> specifies user-provided starting values. Starting values
        must be put in a Stata 1xK matrix following the same order as the
        variables in <i>varlist</i>.  The default is a vector with the Lagrange
        multipliers obtained from the chi-squared distance function.
<p>
    <b>tolerance(</b><i>#</i><b>)</b> specifies the tolerance level to asses convergence. The
        default is <b>tolerance(</b><i>0</i>.<i>000001</i><b>)</b>. <b>reweight</b> employs a double criterion
        to asses convergence.  The first is that the difference between the
        estimated and the external totals must be lower than the tolerance
        level.  The second criterion is that - from one iteration to the
        other - the percentage variations of the estimated distance between
        the new and the original weights must be lower than the tolerance
        level for each observation in the sample.
<p>
    <b>ntier(</b><i>#</i><b>)</b> specifies the number of maximum iterations. The default is
        <b>niter(</b><i>50</i><b>)</b>.
<p>
    <b>ntries(</b><i>#</i><b>)</b> specifies the maximum number of “tries” when the algorithm
        doeas not achieve convergence within the maximum number of
        iterations.  This option can be useful when the external totals are
        significantly different from the survey totals.  In such situations
        the algorithm automatically restarts with new random starting values
        up to <b>#</b> times. The default is <b>ntries(</b><i>0</i><b>)</b>.
<p>
    <b>upbound(</b><i>#</i><b>)</b> specifies the upper-bound of the ratio between the new and the
        original weight when using the Deville and Sarndal's distance
        function.  The default is <b>upbound(3)</b>. Note that this value must be
        bigger than 1.
<p>
    <b>lowbound(</b><i>#</i><b>)</b> specifies the lower-bound of the ratio between the new and
        the original weightwhen using the Deville and Sarndal's distance
        function.  The default is <b>lowbound(0.2)</b>. Note that this value must be
        between 0 and 1.
<p>
    <b>mlowbound(</b><i>#</i><b>)</b> and <b>mupbound(</b><i>#</i><b>)</b> are relevant options only for the DS distant
        function when the option <b>ntries(</b><i>#</i><b>)</b> is effective.  In this case, if
        the recursion does not achieve convergence the routine starts again
        with a new set of starting values and of new random bounds.
        <b>mlowbound(</b><i>#</i><b>)</b> specifies the maximum deviation from the highest value
        of the lower bound and <b>mupbound(</b><i>#</i><b>)</b> specifies the maximum deviation
        from the lowest value of the upper bound.  As an example, if
        <b>mlowbound(</b><i>#</i><b>)</b> is set to 0.5 than the new random value for the lower
        bound will be drawn from a uniform distribution in the range 0.5-1
        and if <b>mupbound(</b><i>#</i><b>)</b> is set to 5 than the new random value for the
        upper bound will be drawn from a uniform distribution in the range
        1-5. The default is 0.1 and 6 respectively.
<p>
<b><u>Example</u></b>
<p>
    Consider the following example from Creedy(2003).  <b>id</b> is the
    identification number of each unit included in the survey, <b>x1</b>, <b>x2</b>, <b>x3</b> and
    <b>x4</b> are variables included in the survey, <b>weight</b> is the vector of original
    survey weights:
<p>
<p>
<b>. use http://fmwww.bc.edu/RePEc/bocode/r/reweight, clear</b>
<b>. list</b>
<p>
<b>id      x1      x2      x3      x4      weight</b>
<b>1       1       1       0       0       3</b>
<b>2       0       1       0       0       3</b>
<b>3       1       0       2       0       5</b>
<b>4       0       0       6       1       4</b>
<b>5       1       0       4       1       2</b>
<b>6       1       1       0       0       5</b>
<b>7       1       0       5       0       5</b>
<b>8       0       0       6       1       4</b>
<b>9       0       1       0       0       3</b>
<b>10      0       0       3       1       3</b>
<b>11      1       0       2       0       5</b>
<b>12      1       1       0       1       4</b>
<b>13      1       0       3       1       4</b>
<b>14      1       0       4       0       3</b>
<b>15      0       0       5       0       5</b>
<b>16      0       1       0       1       3</b>
<b>17      1       0       2       1       4</b>
<b>18      0       0       6       0       5</b>
<b>19      1       0       4       1       4</b>
<b>20      0       1       0       0       3</b>
<p>
<p>
The survey weights produce the following aggregate totals: 
<p>
<p>
<b>1.      tabstat x1 x2 x3 x4 [w=weight], s(su)</b>
<b>2.      stats   x1      x2      x3      x4</b>
<b>3.      sum     44      24      213     32</b>
<p>
<p>
Now, let us assume that external information on these variables are available, 
&gt; and that the real population totals are:
<p>
<p>
<b>        stats   x1      x2      x3      x4</b>
<b>                50      20      230     35</b>
<p>
<p>
In this case, <b>reweight</b> can be used to calibrate the original survey weights so 
&gt; that the new estimated totals will be equal to the population totals:
<p>
<p>
<b>matrix t=(50 \ 20 \ 230 \ 35)</b>
<b>reweight x1 x2 x3 x4, sw(weight) nw(wchi2) tot(t) df(chi2)</b>
<b>reweight x1 x2 x3 x4, sw(weight) nw(wa) tot(t) df(a)</b>
<b>reweight x1 x2 x3 x4, sw(weight) nw(wb) tot(t) df(b)</b>
<b>reweight x1 x2 x3 x4, sw(weight) nw(wc) tot(t) df(c)</b>
<b>reweight x1 x2 x3 x4, sw(weight) nw(wds) tot(t) df(ds)</b>
<p>
<b>list w*</b>
<b>weight  wchi2   wa      wb      wc      wds</b>
<b>3       2.753   2.674   2.654   2.697   2.706 </b>
<b>3       2.109   2.228   2.260   2.193   2.178 </b>
<b>5       5.945   5.998   6.012   5.982   5.976 </b>
<b>4       4.005   3.944   3.926   3.963   3.974 </b>
<b>2       2.484   2.514   2.521   2.505   2.501 </b>
<b>5       4.589   4.456   4.423   4.495   4.510 </b>
<b>5       5.752   5.729   5.717   5.739   5.747 </b>
<b>4       4.005   3.944   3.926   3.963   3.974 </b>
<b>3       2.109   2.228   2.260   2.193   2.178 </b>
<b>3       3.120   3.086   3.074   3.098   3.106 </b>
<b>5       5.945   5.998   6.012   5.982   5.976 </b>
<b>4       3.985   3.814   3.762   3.870   3.897 </b>
<b>4       5.019   5.108   5.136   5.080   5.065 </b>
<b>3       3.490   3.490   3.487   3.491   3.494 </b>
<b>5       4.678   4.665   4.666   4.667   4.665 </b>
<b>3       2.345   2.370   2.380   2.360   2.355 </b>
<b>4       5.070   5.191   5.232   5.150   5.128 </b>
<b>5       4.614   4.603   4.604   4.603   4.600 </b>
<b>4       4.967   5.028   5.043   5.010   5.001 </b>
<b>3       2.109   2.228   2.260   2.193   2.178</b>
<p>
Which gives the same values as in Creedy (2003).
<p>
<p>
<b><u>Reference</u></b>
<p>
    Creedy, J., 2003.<i>  Survey Reweighting for Tax Microsimulation Modelling</i>,
        Treasury Working Paper Series 03/17, New Zealand Treasury.
<p>
    Deville, J.C. and Sarndal, C.E., 1992.<i>  Calibration estimators in survey</i>
        <i>sampling</i>, Journal of the American Statistical Association 87 (418)
        376-382, American Statistical Association.
<p>
    Pacifico 2010.<i>  reweight: A Stata module to reweight survey data to</i>
        <i>external totals</i>, CAPPaper N.79.
<p>
<p>
<b><u>Author</u></b>
<p>
    This command was written by Daniele Pacifico (daniele.pacifico@tesoro),
        Italian Department of the Treasury. Comments and suggestions are
        welcome.
<p>
<p>
<b><u>Also see</u></b>
<p>
    Manual:  <b>[R] reweight</b>
<p>
    Online:  <b>[R] reweight</b>
<p>
<p>
</pre>