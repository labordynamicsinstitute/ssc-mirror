<pre>
<p>
<p>
<b>help rct_minim</b>
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
    <b>rct_minim </b>-<b> Allocation of treatments to balance prognostic factors in</b>
                <b>controlled trials</b>
<p>
<p>
<b><u>Syntax</u></b>
<p>
        <b>rct_minim</b> <b>,</b> <b><u>file</u></b><b>stub</b><b>(</b><i>filenamestub</i><b>)</b>  <b>nt</b><b>(</b><i>#</i><b>)</b>  <b>nf</b><b>(</b><i>#</i><b>)</b>  <b>nl</b><b>(</b><i>#1 [#2</i>
                 <i>[...]</i><b>)</b>  <b>pchoice</b><b>(a</b>|<b>b</b>|<b>c)</b>  [<i>options</i>]
<p>
<p>
    <i>options</i>                          Description
    -------------------------------------------------------------------------
    Main
      <b><u>file</u></b><b>stub(</b><i>filenamestub</i><b>)</b>         filename prefix for allocations and
                                       factor balance files; required option
      <b>nt(</b><i>#</i><b>)</b>                          number of treatment groups; required
                                       option
      <b>nf(</b><i>#</i><b>)</b>                          number of prognostic factors; required
                                       option
      <b>nl(</b><i>#1 #2 </i>...<b>)</b>                  number of levels in <i>factor1 factor2</i> etc;
                                       required option
      <b>pchoice</b><b>(a</b>|<b>b</b>|<b>c)</b>                 method to calculate treatment assignment
                                       probabilities; required option
<p>
    Options
     *<b>p(</b><i>#</i><b>)</b>                           specify probability p for<b> pchoice</b> method
                                       <b>a</b>
     *<b>q(</b><i>#</i><b>)</b>                           specify parameter q for<b> pchoice</b> method <b>b</b>
     *<b>t(</b><i>#</i><b>)</b>                           specify parameter t for<b> pchoice</b> method <b>c</b>
      <b><u>treatv</u></b><b>ar(</b><i>varname</i><b>)</b>              name of treatment group variable
      <b><u>factn</u></b><b>ames(</b><i>name1 name2</i>...<b>)</b>      names of prognostic factors
      <b><u>pat</u></b><b>tern(</b><i>#1 #2 </i>...<b>)</b>             current subject's levels on each
                                       prognostic factor
      <b>w(</b><i>#1 #2</i>...<b>)</b>                    weights for each prognostic factor
      <b>mchoice</b><b>(range</b>|<b>var</b>|<b>sd</b>|<b>thresh)</b>   method for measuring imbalance in
                                       prognostic factors
      <b>limit(</b><i>#</i><b>)</b>                       limit of acceptable imbalance (specified
                                       when <b>mchoice(thresh)</b> is specified)
      <b>delay(</b><i>#</i><b>)</b>                       specify first # subjects are allocated
                                       treatments at random
      <b>warn</b>                           user response required between
                                       re-display of command and treatment
                                       assignment
      <b><u>showd</u></b><b>etail</b>                     display detailed output
<p>
    -------------------------------------------------------------------------
     * one of <b>p</b>, <b>q</b> or <b>t</b> must be specified
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>rct_minim</b> assigns subjects to treatment groups so as to balance
    categorical or ordered categorical prognostic factors across the
    treatments using a process called<i> minimization</i> (see Pocock and Simon
    (1975)).  This is a form of "covariate adaptive randomisation", the
    assignment for the current subject depends <i>inter alia</i> on
 
        (i) all previous subjects' treatment assignments,
       (ii) all previous subjects' patterns of prognostic factors, and
      (iii) the current subject's pattern of prognostic factors.
<p>
    Treatment assignment by minimization may be useful in smaller trials,
    when the number of strata is large relative to the sample size, and/or
    when balance of prognostic factors is judged to be critically important.
    [See <b>ralloc</b> for a more common method of randomisation using randomly
    permuted blocks and stratification.]
<p>
<p>
<b><u>Options</u></b>
<p>
        +------+
    ----+ Main +-------------------------------------------------------------
<p>
    <b>filestub(</b><i>filenamestub</i><b>)</b> specifies the prefix of the names of 2 files that
        <b>rct_minim</b> will create on its first invocation and use on each
        subsequent treatment assignment.
<p>
        The <i>first</i> file will be named <i>filenamestub</i><b>_rand.dta</b>; for each subject
        it stores the treatment assignment, the factor levels, a
        system-generated <b>_SeqNum</b> variable giving the sequential number of
        that subject's allocation, and a system-generated binary variable,
        <b>_minim</b>, indicating whether (1=yes) or not (0=no) the minimising
        algorithm was invoked for that subject (see option <b>delay</b> below).
<p>
        The<i> second</i> file will be named <i>filenamestub</i><b>_factbal.dta</b>; it stores
        summary count data on the distribution of treatment assignments and
        prognostic factor levels in a layout similar to Table 1 of Pocock and
        Simon. Data from this file are used within<b> rct_minim</b> to construct a
        <i>factor balance matrix</i>.
<p>
    <b>nt(</b><i>#</i><b>)</b> specifies the number of treatment groups; <i>#</i> must be at least 2.
<p>
    <b>nf(</b><i>#</i><b>)</b> specifies the number of prognostic factors; <i>#</i> must be at least 1.
<p>
    <b>nl(</b><i>#1 #2 </i>...<b>)</b> specifies the number of levels of <i>factor1 factor2</i> etc; <i>#</i>
        must be at least 2 for each factor. Separate the <i>#</i>s by one or more
        spaces.
<p>
    <b>pchoice</b><b>(a</b>|<b>b</b>|<b>c)</b> specifies how to calculate probabilities that will
        determine the extent of the bias in treatment assignments.
        Minimization seeks to assign a treatment based on minimising the
        prognostic factor imbalance. This imbalance is reflected in function
        D<i>i</i> that measures the extent of variation across treatments for levels
        of factor <i>i</i>.  By default, <b>rct_minim</b> specifies D<i>i</i> as the <i>range</i> in the
        counts of each level of factor <i>i</i> across treatments (see option
        <b>mchoice</b> below for alternative methods of measuring imbalance in
        factors), and then calculates G<i>k</i>, a sum (perhaps weighted) of the D<i>i</i>
        for each treatment <i>k</i> (k = 1..<b>nt</b>).  We may then <i>deterministically</i>
        assign the subject to the treatment that will minimise G, or, perhaps
        in an effort to better protect the blinding, assign the subject to
        treatments in a random fashion following an empirical probability
        distribution. This distribution will of course assign more
        probability to the treatment minimizing G. Pocock and Simon discuss 3
        methods, denoted "<b>a</b>", "<b>b</b>" and "<b>c</b>" for setting up the probability
        distribution (see section 3.3 of their paper).
<p>
        Method <b>a</b> specifies <b>p</b> as the probability for the assignment to the
        treatment with the lowest value of G, and <b>p</b><i>k</i> = (1-<b>p</b>)/(<b>nt</b>-1) for every
        other treatment (k = 2...<b>nt</b>) where k is ordered for increasing values
        of G<i>k</i>. If <b>p</b> = 1 then the assignment is automatically to the treatment
        minimizing G. If <b>p</b> = 1/<b>nt</b> then each treatment has equal probability
        of being assigned.  Commonly, <b>p</b> = 2/3 is chosen as a compromise
        between maintaining the blinding and affording a bias in the
        assignments to achieve factor balance.
<p>
        Method <b>b</b> specifies <b>q</b> as some constant such that the probability
        distribution takes account of the ranking of G<i>k</i> for all k (and not
        just for k = 1 as is the case in Method <b>a</b>).  p<i>k</i> = <b>q</b> -
        [2<i>k</i>((<b>nt</b>*<b>q</b>)-1)/(<b>nt</b>(<b>nt</b>+1))] (k = 1...<b>nt</b>).  Pocock and Simon give an
        example using <b>q</b> = 1/2 in a 4 treatment trial, yielding p<i>1</i> = 0.4, p<i>2</i> =
        0.3, p<i>3</i> = 0.2 and p<i>4</i> = 0.1. That is, the subject will be assigned to
        the treatment for which G is minimized with probability 0.4, to the
        treatment for which G is next in ordered value with probability 0.3
        and so on.
<p>
        Method <b>c</b> specifies <b>t</b> as some constant such that the probability
        distribution takes account of the actual value of G<i>k</i> for all k (and
        not just for the ranking of G<i>k</i> as is the case in Method <b>b</b>).  The
        higher the value of <b>t</b> the more bias in treatment assignment. Under
        this method p<i>k</i> = (1/(<b>nt</b> - <b>t</b>)) * [1 - (<b>t</b>*G<i>k</i>/sum(G<i>k</i>)] (k = 1...<b>nt</b>).
<p>
        The three methods and their associated probability distributions do
        not apply to the first subject's treatment assignment.  This is
        determined by simple randomisation with assignment to each group
        equally likely.
<p>
<p>
<p>
        +---------+
    ----+ Options +----------------------------------------------------------
<p>
    <b>p(</b><i>#</i><b>)</b> specifies value of p when <b>pchoice</b>(<b>a</b>) has been chosen. <i>#</i> must lie
        between 1/<b>nt</b> and 1.
<p>
    <b>q(</b><i>#</i><b>)</b> specifies value of q when <b>pchoice</b>(<b>b</b>) has been chosen. <i>#</i> must lie
        between 1/<b>nt</b> and 2/(<b>nt</b>-1).
<p>
    <b>t(</b><i>#</i><b>)</b> specifies value of t when <b>pchoice</b>(<b>c</b>) has been chosen. <i>#</i> must lie
        between 0 and 1.
<p>
    <b>mchoice(</b><i>string</i><b>)</b> specifies the method of measuring the imbalance in
        prognostic factors across treatments.  The default is <b>range</b>.
        Alternatives are <b>var</b> (variance of the counts within a factor level
        across treatments), <b>sd</b> (standard deviation of the counts), and <b>thresh</b>
        which signals that a bias in treatment assignment will only proceed
        if the imbalance in the range of counts exceeds a specified <b>limit</b>.
<p>
    <b>limit(</b><i>#</i><b>)</b> specifies the maximum acceptable (integer) imbalance in
        prognostic factor levels before a bias in treatment assignment
        (designed to correct the imbalance) will be invoked. Used with option
        <b>mchoice(thresh)</b>. Default is 1.
<p>
    <b>treatvar(</b><i>varname</i><b>)</b>} specifies the name of the treatment group variable;
        default is "_group".
<p>
    <b>factnames(</b><i>name1 name2</i>...<b>)</b> specifies the names of the prognostic factors;
        default is "factor1", "factor2" etc
<p>
    <b>pattern(</b><i>#1 #2 </i>...<b>)</b> specifies this subject's levels on each prognostic
        factor. If<b> pattern</b> is not specified the user is prompted to enter the
        levels one factor at a time at the cursor. This is simply a
        convenience feature, as the factor levels may be the only option to
        change for each subject.
<p>
    <b>w(</b><i>#1 #2</i>...<b>)</b> specifies the relative importance weights for each prognostic
        factor.  These are used in the linear combination of the D<i>i</i> to form
        the G<i>k</i>.  Higher relative weights are given to factors for which an
        imbalance would be most unwelcome. The <i>#i</i> should each exceed 0.
<p>
    <b>delay(</b><i>#</i><b>)</b> specifies that the first <i>#</i> subjects are allocated treatments
        purely at random (with equal probabilities) - the minimisation
        algorithm is not used for these subjects. [Note that the first
        subject is always allocated his/her treatment at random, since no
        factor balance matrix yet exists.] The default is <b>delay(</b><i>1</i><b>)</b>, implying
        that the minimisation algorithm will be used for the second and
        subsequent subjects.
<p>
    <b>warn</b> specifies that a user confirmation will be required between
        re-display of the command and the actual treatment assignment; by
        default no warning is given. Because sequential invocations of
        <b>rct_minim</b> may occur after some time has elapsed, it is important for
        the integrity of the study design that certain options are specified
        consistently, especially <b>filestub</b>, <b>nt</b>, <b>nf</b> and <b>nl</b>. On each invocation
        <b>rct_minim</b> saves two <i>characteristics</i> to the data files. The first,
        named <b>_dta[TD_</b><i>n</i><b>]</b> (where n is the sequential number of the current
        subject), stores the time and date of the assignment. (See also <i>Note</i>
        below). The second characteristic, named <b>_dta[minim_</b><i>n</i><b>]</b> stores the
        command and options that were issued. Specifying <b>warn</b> causes
        <b>rct_minim</b> to re-display the current command and also the contents of
        <b>_dta[TD_</b><i>n-1</i><b>]</b> and of <b>_dta[alloc_</b><i>n-1</i><b>]</b> (that is, the command as issued
        for the previous assignment) so that the user can compare these and
        decide whether or not to proceed with the current randomisation.
        This is in addition to other error traps within the program.
<p>
        <i>Note</i>: The characteristic <b>_dta[TD_</b><i>n</i><b>]</b> stores the time and date of the
              assignment. <b>rct_minim</b> uses the date and time, in that order,
              concatenated and stripped of any non-numeric characters to form
              the seed for the current assignment. (This seed is also
              displayed when option <b>showdetail</b> is specified.)
<p>
    <b>showdetail</b> specifies that detailed output is displayed. The default is
        minimal output, but it would be prudent to both open a log file and
        specify <b>showdetail</b> for each treatment assignment. <b>showdetail</b> will
        cause the following to be displayed:
<p>
            the seed (set from the date and time)
            the method chosen for measuring imbalance in prognostic factors
            the weight vector
            the status of the progostic factor balance matrix from the
              previous assignment
            the sequential number of the subject about to be assigned
              treatment
            the status of the progostic factor balance matrix for each
              possible treatment assignment for the current subject
            the values of weighted G for each treatment group
            the values of weighted G for each treatment group, sorted in
              ascending order (with ties broken at random)
            the smallest value of G and the treatment group it represents
            the random number <i>u</i> used to determine the actual treatment
              allocation
            the cumulative probability distribution (set up by either <b>p</b>, <b>q</b> or
              <b>t</b>); the value of <i>u</i> with respect to this distribution determines
              the assignment.
            the final treatment group assignment
            the updated prognostic factor balance matrix
<p>
<p>
<b><u>Examples</u></b>
<p>
    Basic setup for 2-arm trial with 3 prognostic factors; the <i>first</i> subject
    is at level 1 for factor1, level 3 for factor2, and level 2 for factor3.
    The <i>second</i> subject is at level 2 for each factor. Use the default <b>range</b>
    method to measure imbalance.
<p>
      <b>. rct_minim, filestub(my_trial) nt(2) nf(3) nl(2 4 3) pchoice(a)</b>
          <b>p(.66667) showdet warn pattern(1 3 2)</b>
      <b>. rct_minim, filestub(my_trial) nt(2) nf(3) nl(2 4 3) pchoice(a)</b>
          <b>p(.66667) showdet warn pattern(2 2 2)</b>
<p>
    3-arm trial with 2 user-named prognostic factors, sex has 2 levels,
    age_group has 5 levels; no warnings and no detail displayed; program will
    request current subject's levels on each factor
<p>
      <b>. rct_minim, filestub(your_trial) nt(3) nf(2) factnames(sex age_group)</b>
          <b>nl(2 5) pchoice(a) p(.75)</b>
<p>
    Same design as previous example but this time, in an effort to better
    protect the blind, delay the minimization process until the 11th subject
    is randomized; the first 10 subjects will have their treatments allocated
    at random.
<p>
      <b>. rct_minim, filestub(her_trial) nt(3) nf(2) factnames(sex age_group)</b>
          <b>nl(2 5) pchoice(a) p(.75) delay(10)</b>
<p>
    Mimic example from section 3.4 of Pocock and Simon. Ensure that files
    <b>pocock_simon_v3_rand.dta</b> and <b>pocock_simon_v3_factbal.dta</b> (available with
    the <b>rct_minim</b> package from SSC) are installed in the current path. 50
    subjects have already been randomised, whither the 51st?
<p>
      <b>. rct_minim, filestub(pocock_simon_v3) w(2 1 1) nt(3) nf(3) nl(2 2 3)</b>
          <b>pchoice(a) p(`=2/3') pattern(1 2 2) treatv(treatment) showd</b>
<p>
  
<b><u>Reference</u></b>
<p>
    Pocock, S.J. and Simon, R. [1975]. Sequential treatment assignment with
        balancing for prognostic factors in the controlled clinical trial.
        Biometrics 31, 103-115.
<p>
<p>
<b><u>Acknowledgements</u></b>
<p>
    Thanks to Kit Baum, Boston College Economics and DIW Berlin, for
    suggesting some useful Mata code.
    Thanks also to Tom Sullivan, DMAC, University of Adelaide, for helping
    test and debug <b>rct_minim</b>.
<p>
<p>
<b><u>Author</u></b>
<p>
    Philip Ryan
    Data Management &amp; Analysis Centre
    Discipline of Public Health
    Faculty of Health Sciences
    University of Adelaide
    South Australia
    philip.ryan@adelaide.edu.au
<p>
<p>
<b><u>See also</u></b>
<p>
    STB:  <b>ralloc</b> in STB-54 sxd1.2, STB-50 sxd1.1, STB-41 sxd1
     SJ:  <b>ralloc</b> in SJ 8(4):594, SJ 8(1):146
<p>
</pre>