<pre>
-------------------------------------------------------------------------------
help for <b>proprcspline</b>
-------------------------------------------------------------------------------
<p>
<b><u>Restricted cubic spline smoothing of proportions</u></b>
<p>
        <b>proprcspline</b> <i>yvar xvar</i> [<i>cvars</i>] [<i>if</i>] [<i>in</i>] [<i>weight</i>] [ <b>,</b> <b>at(</b><i>cvar1 #</i>
            [<i>cvar2 # </i>[...]]<b>)</b> <b>by(</b><i>by_option</i><b>)</b> <b><u>sh</u></b><b>owknots</b> <b><u>catax</u></b><b>is</b> <b><u>catleg</u></b><b>end</b>
            <b>rareaopt#(</b><i>rarea_options</i><b>)</b> <b>addplot(</b><i>plot</i><b>)</b> <b><u>labl</u></b><b>ength(</b><i>"all" </i>|<i> #</i><b>)</b>
            <b>stub(</b><i>stub</i><b>)</b> <b><u>gen</u></b><b>erate(</b><i>stub</i><b>)</b> <i>mkspline_options</i>
            <b><u>mlogit</u></b><b>opts(</b><i>mlogit_options</i><b>)</b> ]
<p>
    <b>fweight</b>s and <b>pweight</b>s are allowed; see weight.
<p>
<p>
<b><u>Description</u></b>
<p>
    <b>proprcspline</b> computes a restricted cubic spline smooth of proportions of
    observations in each category of <i>yvar</i> given <i>xvar</i>, and graphs them as a
    stacked area plot.  Optionally, these smoothed proportions can be
    adjusted for a set of control variables (<i>cvars</i>).
<p>
<p>
<b><u>Remarks</u></b>
<p>
    <b>proprcspline</b> calls mkspline, cubic to create variables containing a
    restricted cubic spline of <i>xvar</i>.  It then calls mlogit to regress <i>yvar</i>
    against those new variables, and thus obtains predicted (smoothed) values
    of proportions in each category of <i>yvar</i> given <i>xvar</i>.  Finally, it calls 
    graph to plot the smooth.
<p>
    When control variables are added, then these will also be added to the
    <b>mlogit</b> model. When predicting the smoothed proportions the values of
    control variables will be fixed at the values specified in the <b>at()</b>
    option or the mean when these variables did not occur in the <b>at()</b> option.
<p>
    More generally, the main intended usage of <b>proprcspline</b> is for
    descriptive analysis and informal exploratory analysis. More formal uses
    would require specification of the <b>stub()</b> option to save the variables
    created. Some consideration might need to be given to the implications of
    any data snooping.
<p>
<p>
<b><u>Options</u></b> 
<p>
    <b>at(</b><i>cvar1 # </i>[<i>cvar2 # </i>[...]]<b>)</b> specifies the values at which the control
        variables (<i>cvars</i>) are held constant when predicting the smoothed
        proportions. All control variables that are not mentioned in the <b>at()</b>
        option will be fixed at their overal mean. When the <b>by()</b> option is
        specified, the mean will be computed once for the entire sample
        (allowing for <b>if</b> and <b>in</b> selection criteria),<i> not</i> separately for each
        group specified in the <b>by()</b> option.
<p>
    <b>by(</b><i>by_options</i><b>)</b> allows comparing the smoothed proportions across groups.
        See help on by_option.
<p>
    <b>showknots</b> specifies that the positions of the knots be shown on the graph
        by vertical lines.
<p>
    <b>cataxis</b> specifies that the categories of <i>yvar</i> are labeled on the right
        y-axis. This is the default when the <b>by()</b> option is not specified or
        when the <b>by()</b> option implies the comparison of only two groups.
<p>
    <b>catlegend</b> specifies that the categories of <i>yvar</i> are labeled in a legend.
        This is the default when the <b>by()</b> option is specified such that more
        than 2 groups are compared.
<p>
    <b>rareaopt#(</b><i>rarea_options</i><b>)</b> specifies options to be applied to the area
        representing category number # of <i>yvar</i>. These options are listed in 
        twoway rarea
<p>
    <b>addplot(</b><i>plot</i><b>)</b> provides a way to add other plots to the generated graph.
        See help on addplot_option.
<p>
    <b>lablength(</b><i>"all"</i>|<i> #</i><b>)</b> Within the second y-axis or the legend the categories
        are labeled using the value labels. the <b>lablength(()</b> option specifies
        the maximum number of characters that are used from each value label.
        The default is 20. One can either specify "all" to make <b>proprcspline</b>
        use all characters of the value labels in the legend or a positive
        integer indicating the maximum number of characters used.
<p>
    <b>stub(</b><i>stub</i><b>)</b> specifies that the variables containing the spline be saved in
        variables with prefix <i>stub</i>.
<p>
    <b>generate(</b><i>stub</i><b>)</b> specifies that smoothed proportions be saved in variables
        with prefix <i>stub</i>..
<p>
    <i>mkspline_options</i> are options of mkspline, cubic.
<p>
        <b>nknots()</b> specifies the number of knots that are to be used for a
        restricted cubic spline.  This number must be between 3 and 7 unless
        the knot locations are specified using <b>knots()</b>.  The default number
        of knots is 5.
<p>
        <b>knots()</b> specifies the exact location of the knots to be used for a
        restricted cubic spline.  The values of these knots must be given in
        increasing order.  When this option is omitted, the default knot
        values are based on Harrell's recommended percentiles with the
        additional restriction that the smallest knot may not be less than
        the fifth-smallest value of <i>xvar</i> and the largest knot may not be
        greater than the fifth-largest value of <i>xvar</i>.  If both <b>nknots()</b> and
        <b>knots()</b> are given, they must specify the same number of knots.
<p>
    <b>mlogitopts()</b> contains options of mlogit. It is difficult to know why you
        would want to specify any.
<p>
<p>
<b><u>Examples</u></b> 
<p>
<p>
<b>    sysuse nlsw88, clear</b>
<b>    </b>
<b>    gen marst = cond(never_married, 1,              ///</b>
<b>                cond(married, 2, 3))                ///</b>
<b>                if !missing(married, never_married)</b>
<b>    label define marst 1 "never married"            ///</b>
<b>                       2 "married"                  ///</b>
<b>                       3 "divorced/widowed"</b>
<b>    label value marst marst</b>
<b>    </b>
<b>    proprcspline marst grade, xlab(0(5)15) </b>
<p>
    (click to run)
<p>
<p>
<b>    sysuse nlsw88, clear</b>
<b>    </b>
<b>    gen marst = cond(never_married, 1,              ///</b>
<b>                cond(married, 2, 3))                ///</b>
<b>                if !missing(married, never_married)</b>
<b>    label define marst 1 "never married"            ///</b>
<b>                       2 "married"                  ///</b>
<b>                       3 "divorced/widowed"</b>
<b>    label value marst marst</b>
<b>    </b>
<b>    proprcspline marst grade, xlab(0(5)15)          ///</b>
<b>                 rareaopt1(color(red))              ///</b>
<b>                 rareaopt2(color(blue))             ///</b>
<b>                 rareaopt3(color(gs10))</b>
<p>
    (click to run)
<p>
<p>
<b>    sysuse nlsw88, clear</b>
<b>    </b>
<b>    gen marst = cond(never_married, 1,              ///</b>
<b>                cond(married, 2, 3))                ///</b>
<b>                if !missing(married, never_married)</b>
<b>    label define marst 1 "never married"            ///</b>
<b>                       2 "married"                  ///</b>
<b>                       3 "divorced/widowed"</b>
<b>    label value marst marst</b>
<p>
<b>    label define c_city 1 "in central city"         ///</b>
<b>                        0 "outside central city"</b>
<b>    label value c_city c_city  </b>
<p>
<b>    proprcspline marst grade, xlab(0(5)15)          ///</b>
<b>                 by(c_city, note(""))</b>
<p>
    (click to run)
<p>
<p>
<b>    sysuse nlsw88, clear</b>
<b>    </b>
<b>    gen marst = cond(never_married, 1,              ///</b>
<b>                cond(married, 2, 3))                ///</b>
<b>                if !missing(married, never_married)</b>
<b>    label define marst 1 "never married"            ///</b>
<b>                       2 "married"                  ///</b>
<b>                       3 "divorced/widowed"</b>
<b>    label value marst marst</b>
<p>
<b>    label define c_city 1 "in central city"         ///</b>
<b>                        0 "outside central city"</b>
<b>    label value c_city c_city  </b>
<b>        </b>
<b>    gen black = race == 2 if race &lt; .</b>
<b>    label define black 1 "black"                     ///</b>
<b>                       0 "non-black"</b>
<b>    label value black black    </b>
<p>
<b>    proprcspline marst grade black, xlab(0(5)15)     ///</b>
<b>                 by(c_city, note("")) at(black 0)   </b>
<p>
    (click to run)
<p>
<p>
<b><u>Saved results</u></b> 
<p>
    r(N_knots)   number of knots (scalar) 
    r(knots)     knot positions (matrix) 
<p>
<p>
<b><u>Author</u></b> 
<p>
    Maarten L. Buis
    Universitaet Tuebingen
    Institut fuer Soziologie
    maarten.buis@uni-tuebingen.de
<p>
<p>
<b><u>Acknowledgments</u></b> 
<p>
    Large portions of the code are based upon <b>rcspline</b> by Nicholas J. Cox.
<p>
<p>
<b><u>Also see</u></b>
<p>
    Online: lowess, lpoly
    If installed: rcspline, mvrs
</pre>