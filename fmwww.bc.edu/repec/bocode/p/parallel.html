<pre>
<p>
<b>help parallel</b>
-------------------------------------------------------------------------------
<p>
<b><u>Title</u></b>
<p>
    <b>parallel</b> -- Stata module for Parallel computing
<p>
<b><u>Syntax</u></b>
<p>
    Setting the number of clusters (data blocks)
<p>
        <b>parallel setclusters</b> # [, <b><u>f</u></b><b>orce</b>]
<p>
    Parallelizing a do-file
<p>
        <b>parallel do</b> <i>filename</i> [, <b>by</b>(<i>varlist</i>) <b><u>f</u></b><b>orce</b> <b><u>k</u></b><b>eep</b> <b><u>keepl</u></b><b>ast</b> <b><u>p</u></b><b>rograms</b> <b><u>m</u></b><b>ata</b>
                 <b><u>nog</u></b><b>lobal</b> <b><u>s</u></b><b>eeds</b>(<i>numlist</i>) <b><u>nod</u></b><b>ata</b>]
<p>
    Parallelizing a stata command
<p>
        <b>parallel</b> [, <b>by</b>(<i>varlist</i>) <b><u>f</u></b><b>orce</b> <b><u>k</u></b><b>eep</b> <b><u>keepl</u></b><b>ast</b> <b><u>p</u></b><b>rograms</b> <b><u>m</u></b><b>ata</b> <b><u>nog</u></b><b>lobal</b>
                 <b><u>s</u></b><b>eeds</b>(<i>numlist</i>) <b><u>nod</u></b><b>ata</b>]:  <i>stata_cmd</i>
<p>
    Removing auxiliary files
<p>
        <b>parallel clean</b> [, <b><u>e</u></b><b>vent(</b><i>pll_id</i><b>)</b> <b><u>a</u></b><b>ll</b>]
<p>
    Setting the right stata directory
<p>
        <b>parallel setstatadir</b> <i>stata_path</i>
<p>
    <i>options</i>        Description
    -------------------------------------------------------------------------
    Setting the number of clusters
      <b><u>f</u></b><b>orce</b>        In order to protect the users' computers, setting more
                     than 8 clusters it is not permitted (see the WARNING in
                     description). With this option the user can skip this
                     restriction.
<p>
    Byable parallelization
      <b>by</b>           Varlist. Tells the command through which observations the
                     current dataset can be splitted, avoiding stories
                     splitting over two or more clusters (for example).
      <b><u>f</u></b><b>orce</b>        When using <b>by</b>, <b>parallel</b> checks wheather if the dataset is
                     propertly sorted. By using <b>force</b> the command skips this
                     check.
<p>
    Keeping auxiliary files
      <b><u>k</u></b><b>eep</b>         Keeps auxiliary files generated by <b>parallel</b>.
      <b><u>keepl</u></b><b>ast</b>     Keeps auxiliary files and remove those last time saved
                     during the current session.
<p>
    Passing Stata/Mata objects
      <b><u>p</u></b><b>rograms</b>     In the case of having temporal programs loaded in the
                     sesion, using this option <b>parallel</b> passes them to the
                     clusters.
      <b><u>m</u></b><b>ata</b>         If the algorithm needs to use mata objects, this option
                     allows to pass to each cluster every mata object loaded
                     in the current sesion (including functions).
      <b><u>nog</u></b><b>lobal</b>     By defaul <b>parallel</b> takes into account any global macro
                     loaded in the sesion. If the user needs to not include
                     globals in clusters, he should use this option.
<p>
    Simulation options
      <b><u>s</u></b><b>eeds</b>        Numlist. With this option the user can pass an specific
                     seed to be used within each cluster.
      <b><u>nod</u></b><b>ata</b>       Tells <b>parallel</b> that there is no data loaded and thus
                     should not try to split or append anything.
<p>
    Removing auxiliary files
      <b><u>e</u></b><b>vent</b>        Integer. Specifies which executed (and stored) event's
                     files should be removed.
      <b><u>a</u></b><b>ll</b>          Tells <b>parallel</b> to remove every remanent auxiliary files
                     generated by it in the current directory.
<p>
    Setting the right stata directory
      <b>stata_path</b>   Filename. Required option to set stata's current path.
    -------------------------------------------------------------------------
<p>
<a name="description"></a><b><u>Description</u></b>
<p>
    <b>parallel</b> allows to implement data parallelism algorithm in order to
    substantially improve speed performance of it.
<p>
    In order to use <b>parallel</b> it is necesary to set the number of desired
    clusters with which the user wants to work with. To do this the user
    should use <b>parallel setclusters #</b> syntaxis, replacing <i>#</i> with the desired
    number of clusters. Setting more clusters than physical cores the user's
    computer has it is not recommended (see the WARNING in description).
<p>
    <b>parallel do</b> is the equivalent to <b>do</b>. By using this syntax, the loaded
    dataset will be splitted in the number of clusters specified by <b>parallel</b>
    <b>setclusters</b> and the do-file will be executed independently over each and
    every one of the data clusters. After all the parallel-instances stops,
    the datasets will be appended.
<p>
    <b>parallel :</b> (as a prefix) allows to, after spliting the loaded dataset,
    execute a <i>stata_cmd</i> over the specified number of data clusters in order
    to speed up computations. Like <b>parallel do</b>, after all the
    parallel-instances stops, the datasets will be appended.
<p>
    Every time that <b>parallel</b> runs several auxiliary files are generated
    which, after finishing, are automatically deleted. In the case that the
    user sets <b><u>k</u></b><b>eep</b> or <b><u>keepl</u></b><b>last</b> the auxiliar files are kept, thus the syntax
    <b>parallel clean</b> becomes handy. With <b>parallel clean</b> the user can remove the
    last generated auxiliar files (default option), an specific parallel
    instance files (using <i>#pll_id</i> number), or every kept auxiliar file (with
    <b>all</b>).
<p>
    Giving <i>N</i> clusters, within each cluster <b>parallel</b> creates the local macros
    <i>pll_id</i> (equal for all the clusters) and <i>pll_instance</i> (ranging from 1 up
    to <i>N</i>, equalling 1 inside the first and <i>N</i> inside the last).  Also the
    global macros <i>PLL_CLUSTERS</i> and <i>PLL_DIR</i> are available within each cluster.
<p>
    As by now, <b>parallel</b> by default automatically identifies stata's
    executable file path. This is necessary as it is used to run stata in
    batch mode (the core of the command). Either way, after some reports,
    that file path is not always correctly identified; where <b>parallel</b>
    <b>setstatadir</b> can be used to manually set it.
<p>
    WARNINGS <i>(a)</i> For each cluster <b>parallel</b> starts a new stata instance (thus
    running as many processes as clusters), this way, if the user sets more
    clusters than cores his computer has, it is possible that his computer
    collapses.  <i>(b)</i> By this time <b>parallel</b> can not stop running the clusters
    by itself, what implies that, in the case of any of the clusters starts a
    endless loop, stoping the clusters should be done manually by the user by
    killing them from the OS's tasks manager.
<p>
<a name="details"></a><b><u>Details</u></b>
<p>
    Inspired by the R library ``snow'' and to be used in multicore CPUs ,
    <b>parallel</b> implements parallel computing methods through an OS's shell
    scripting (using Stata in batch mode) to speedup computations by
    splitting the dataset into a determined number of clusters in such a way
    to implement a data parallelism algorithm.
<p>
    The number of efficient computing clusters depends upon the number of
    physical cores (CPUs) with which your computer is built, e.g. if you have
    a quad-core computer, the correct cluster setting should be four. In the
    case of simultaneous multithreading, such as that from Intel's
    hyper-threading technology (HTT), setting <b>parallel</b> following the number
    of processors threads, as it was expected, hardly results into a perfect
    speedup scaling. In spite of it, after several tests on HTT capable
    architectures, the results of implementing <b>parallel</b> according to the
    machines physical cores versus it logical's shows small though
    significant differences.
<p>
    <b>parallel</b> is especially handy when it comes to implementing loop-based
    simulation models (or simply loops), Stata commands such as reshape, or
    any job that (a) can be repeated through data-blocks, and (b) routines
    that processes big datasets.
<p>
    At this time <b>parallel</b> has been successfully tested in Windows and Unix
    machines.Tests using Mac OS are still pending.
<p>
    After several tests, it has been proven that--thanks to how <b>parallel</b> has
    been written--it is possible to use the algorithm in such a way that
    other techniques of parallel computing can be implemented; such as Monte
    Carlo Simulations, simultaneously running models, etc.. An extensive
    example through Monte Carlo Simulations is provided here
<p>
<a name="caveats"></a><b><u>Caveats</u></b>
<p>
    If the <i>stata_cmd</i> or <i>do-file</i> saves results, as<b> parallel</b> runs stata in
    batch mode, none of the results will be keept. This is also true for
    matrices, scalars and mata objects.
<p>
    Inspite <b>parallel</b> passes-through programs, macros and mata objects, by the
    time it is not capable of doing the same with matrices or scalars.
<p>
    Including <b>parallel</b> within ado-files which contains locally-defined
    programs it is not recommended due to knwon issues. By now parallel can
    not correctly interpret this kind of programs during the loading process
    causing erros.
<p>
<a name="examples"></a><b><u>Example 1: using prefix syntax</u></b>
<p>
    In this example we'll generate a variable containing the maximum
    blood-pressure measurement (<i>bp</i>) by patient.
<p>
    Setup for a quad-core computer
        <b>. sysuse bplong.dta</b>
        <b>. sort patient</b>
        
        <b>. parallel setclusters 4</b>
<p>
    Computes the maximum of <i>bp</i> for each patient. We add the option
    <b>by(</b><i>patient</i><b>)</b> to tell parallel not to splitt stories.
        <b>. parallel, by(patient): by patient: egen max_bp = max(bp)</b>
        
    Which is the ``parallel way'' to do:
<p>
        <b>. by patient: egen max_bp = max(bp)</b>
        
    Giving you the same result.
        
<b><u> Example 2: using </u></b><b><u>parallel do</u></b><b><u> syntax</u></b>
<p>
    Another usage that may get big benefits from it is implementing loop-base
    simulations. Imagine that we have a model that requires looping over each
    and every record of a panel-data dataset.
<p>
    Using <b>parallel</b>, the proper way to do this would be using the ``parallel
    do'' syntax
<p>
        <b>. use mybigpanel.dta, clear</b>
<p>
        <b>. parallel setclusters 4</b>
        <b>. parallel do mymodel.do</b>
        
        <b>. collapse ...</b>
<p>
    where <i>mymodel.do</i> would look something like this
        
        ----------------------------------- begin of do-file ------------
        <b>local maxiter = _N</b>
        <b>forval i = 1/`maxiter'</b> <b>{</b>
                        <i>...some routine...</i>
        <b>}</b>
        ----------------------------------- end of the do-file ----------
<p>
<a name="examples"></a><b><u>Example 3: setting the right path</u></b>
<p>
    In the case of <b>parallel</b> setting the stata.exe's path wrongly, using
    <b>parallel setstatadir</b> will correct the situation. So, if <i>"C:\Archivos de</i>
    <i>programa\Stata12/stata.exe"</i> is the right path we only have to write:
<p>
        <b>. parallel setstatadir "C:\Archivos de programa\Stata12/stata.exe"</b>
<p>
<a name="saved_results"></a><b><u>Saved results</u></b>
<p>
    <b>parallel</b> saves the following in <b>r()</b>:
<p>
    Scalars        
      <b>r(pll_n)</b>            Number of parallel clusters last used
      <b>r(pll_id)</b>           Id of the last parallel instance executed (needed
                            to use <b>parallel clean</b>)
      <b>r(pll_t_setu)</b>       Time took to setup (before the parallelization) and
                            to finish the job (after the parallelization)
      <b>r(pll_t_calc)</b>       Time took to complete the parallel job
      <b>r(pll_t_fini)</b>       Time took to appending and cleaning
      <b>r(pll_t_reps)</b>       In the case of <b>keeptime</b>, the number of time
                            measures performed.
<p>
    Macros         
      <b>r(pll_dir)</b>          Directory where parallel ran and stored the
                            auxiliary files.
<p>
<a name="references"></a>        
<b><u>References</u></b>
<p>
    Luke Tierney, A. J. Rossini, Na Li and H. Sevcikova (2012). <i>snow: Simple</i>
        <i>Network of Workstations</i>. R package version 0.3-9. 
        http://CRAN.R-project.org/package=snow
    R Core Team (2012). <i>R: A language and environment for statistical</i>
        <i>computing</i>. R Foundation for Statistical Computing, Vienna, Austria.
        ISBN 3-900051-07-0, URL http://www.R-project.org/.
    George Vega Y (2012). <i>Introducing PARALLEL: Stata Module for Parallel</i>
        <i>Computing</i>. Chilean Pension Supervisor, Santiago de Chile, URL 
        http://fmwww.bc.edu/repec/bocode/p/parallel.pdf.
<p>
<b><u>Author</u></b>
<p>
    George Vega Yon, Superindentencia de Pensiones. 
    mailto:gvega@spensiones.cl
<p>
<b><u>Contributors</u></b>
<p>
    Damian C. Clarke (Oxford University, England), Felix Villatoro
    (Superintendencia de Pensiones, Chile), Eduardo Fajnzylber (Universidad
    Adolfo Ibanez, Chile), Eric Melse (CAREM, Netherlands), Research Division
    (Superindentendia de Pensiones, Chile)
<p>
<b><u>Also see</u></b>
<p>
    Manual: <b>[GSM] Advanced Stata usage (Mac)</b>, <b>[GSU] Advanced Stata usage</b>
             <b>(Unix)</b>, <b>[GSW] Advanced Stata usage (Windows)</b>
<p>
    Online: Running Stata batch-mode in  Mac, Unix and Windows
</pre>